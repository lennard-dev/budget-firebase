<div class="content-area" id="expenses-spa">
  <div class="page-header">
    <h2 class="page-title">Expenses</h2>
    <div class="page-actions">
      <button class="btn btn-primary" id="spa-add">‚ûï Add Expense</button>
    </div>
  </div>
  <div class="card mb-3">
    <div class="card-body">
      <div class="filters">
        <div class="filters-row top">
          <div class="filter-item">
            <label class="form-label">Quick Select</label>
            <select id="spa-quick" class="form-control">
              <option value="">Custom Range</option>
              <option value="7">Past 7 Days</option>
              <option value="30" selected>Past 30 Days</option>
              <option value="90">Past 90 Days</option>
              <option value="365">Past 12 Months</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div class="filter-item">
            <label class="form-label">Start Date</label>
            <input type="date" id="spa-start" class="form-control" />
          </div>
          <div class="filter-item">
            <label class="form-label">End Date</label>
            <input type="date" id="spa-end" class="form-control" />
          </div>
          <div class="filter-item filter-item-search">
            <label class="form-label">Search</label>
            <input type="text" id="spa-search" class="form-control" placeholder="Search description or transaction #..." />
          </div>
        </div>
        <div class="filters-row bottom">
          <div class="filter-item">
            <label class="form-label">Category</label>
            <select id="spa-cat" class="form-control"><option value="">All Categories</option></select>
          </div>
          <div class="filter-item">
            <label class="form-label">Subcategory</label>
            <select id="spa-sub" class="form-control"><option value="">All Subcategories</option></select>
          </div>
          <div class="filter-item">
            <label class="form-label">Payment Method</label>
            <select id="spa-pay" class="form-control"><option value="">All Methods</option></select>
          </div>
          <div class="filters-actions">
            <button class="btn btn-sm btn-outline" onclick="exportExpenses()" title="Export to CSV">üì§ Export</button>
            <button class="btn btn-sm btn-outline" onclick="clearFilters()" title="Clear all filters">üóëÔ∏è Clear</button>
            <div id="spa-count" class="summary-pill" aria-live="polite">0 expenses ‚Ä¢ ‚Ç¨0.00</div>
          </div>
        </div>
      </div>
      <div id="loading-indicator" class="text-center" style="display:none;padding:20px;">
        <div class="spinner" style="display:inline-block;"></div>
        <span style="margin-left:8px;">Loading expenses...</span>
      </div>
    </div>
  </div>
  <div class="card"><div class="card-body">
    <table class="data-table desktop-only">
      <thead>
        <tr>
          <th class="col-date" data-sort="date" style="cursor:pointer;" title="Click to sort by date">Date <span class="sort-arrow">‚Üì</span></th>
          <th class="col-receipt" data-sort="transaction_number" style="cursor:pointer;" title="Click to sort by transaction number">Transaction # <span class="sort-arrow">‚áÖ</span></th>
          <th class="col-category">Category</th>
          <th class="col-description" data-sort="description" style="cursor:pointer;" title="Click to sort by description">Description <span class="sort-arrow">‚áÖ</span></th>
          <th class="col-amount text-right" data-sort="amount" style="cursor:pointer;" title="Click to sort by amount">Amount <span class="sort-arrow">‚áÖ</span></th>
          <th class="col-payment" data-sort="paymentMethod" style="cursor:pointer;" title="Click to sort by payment method">Payment <span class="sort-arrow">‚áÖ</span></th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="spa-tbody"></tbody>
    </table>
    <!-- Mobile Card View -->
    <div id="spa-cards" class="mobile-only mobile-card-view"></div>
    <div style="text-align:center; margin-top:12px; display:none;" id="spa-loadmore-wrap"><button class="btn btn-secondary" id="spa-more">Load More</button></div>
  </div></div>
</div>

<style>
/* Keep the normal app-main structure */
body #app #content .app-main {
  margin-left: 280px; /* Keep sidebar spacing */
}

/* Restore main-content padding for proper page spacing */
.main-content {
  padding: 12px 16px; /* Restore the original padding from shared.css */
}

/* Container and layout fixes */
.content-area {
  width: 100%;
  margin: 0 auto;
  overflow-x: hidden;
  overflow-y: visible !important;
  max-height: none !important;
  height: auto !important;
}

/* Ensure page header uses full width */
.page-header {
  width: 100% !important;
  max-width: none !important;
  margin-bottom: 1rem;
  box-sizing: border-box;
}

/* Prevent horizontal scrolling on page */
body {
  overflow-x: hidden;
}

html {
  overflow-x: hidden;
}

/* Target main app containers that might cause scrolling */
#content,
.main-content,
.app-content,
.page-wrapper,
.layout-main,
.app-main,
#page-root {
  overflow-y: visible !important;
  max-height: none !important;
  height: auto !important;
}

/* Specifically target the main layout containers that wrap expenses */
.app-main {
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
}

#page-root {
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
  min-height: auto !important;
}

/* Override the min-height from shared.css that causes scrollbars */
.main-content {
  min-height: auto !important;
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
}

/* Keep expenses-spa with normal structure */
#expenses-spa {
  box-sizing: border-box;
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
  width: 100%;
}

/* Pagination needs margin */
.pagination-container {
  margin: 16px !important;
}

/* Remove any computed height constraints on the expense page specifically */
#page-root.main-content {
  min-height: auto !important;
  height: auto !important;
  overflow: visible !important;
}

/* Cards should have normal structure - don't destroy the layout */
#expenses-spa .card {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(16,24,40,0.08);
  padding: 16px; /* Normal padding from shared.css */
  margin-bottom: 16px;
  width: 100%;
  box-sizing: border-box;
}

.card-body {
  overflow: visible;
  max-height: none;
  height: auto;
}

/* Ensure no inner scrolling in expense list */
#expenses-spa .card {
  overflow: visible;
  max-height: none;
  height: auto;
}

#expenses-spa .card-body {
  overflow: visible !important;
  max-height: none !important;
  height: auto !important;
}

/* Target only specific container-level elements for overflow fixes */
#expenses-spa > .card,
#expenses-spa > .card > .card-body,
#expenses-spa .filters,
#expenses-spa .content-wrapper,
#expenses-spa .page-content,
#expenses-spa .main-content {
  overflow-y: visible !important;
  overflow-x: hidden !important;
  max-height: none !important;
  height: auto !important;
}

/* Restore normal overflow for table elements and action menus */
.data-table,
.data-table tbody,
.data-table tr,
.data-table td,
.action-dropdown,
.action-menu {
  overflow: unset !important;
  max-height: unset !important;
  height: unset !important;
}
/* Minimalist table design matching reference */
.data-table {
  width: calc(100% + 32px); /* Extend beyond card padding */
  max-width: none;
  table-layout: fixed;
  border-collapse: collapse;
  background: #fff;
  font-size: 14px;
  word-wrap: break-word;
  margin: -16px; /* Negative margin to counteract card padding */
  border: none;
}

/* First row needs special treatment to look connected */
.data-table thead tr:first-child th:first-child {
  border-top-left-radius: 12px;
}
.data-table thead tr:first-child th:last-child {
  border-top-right-radius: 12px;
}

/* Generic card-body - let specific rules override */
.card-body {
  overflow: visible !important;
  max-height: none !important;
  height: auto !important;
}

/* Mobile cards should also use negative margins */
#spa-cards {
  margin: -16px;
  padding: 16px;
}

/* Load more button container */
#spa-loadmore-wrap {
  margin: 0 -16px -16px -16px;
  padding: 12px 16px;
  background: #f8f9fa;
  border-top: 1px solid #e5e7eb;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius: 12px;
}

.data-table th,
.data-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
  vertical-align: middle;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.data-table thead th {
  background: transparent;
  font-weight: 500;
  font-size: 13px;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  border-bottom: 1px solid #e5e7eb;
}

/* Column sizing - responsive percentages for dynamic width */
.data-table thead th.col-date { width: 8%; min-width: 90px; }
.data-table thead th.col-receipt { width: 10%; min-width: 100px; }
.data-table thead th.col-category { width: 15%; min-width: 150px; }
.data-table thead th.col-description { width: 35%; min-width: 200px; } /* Takes most space */
.data-table thead th.col-amount { width: 10%; min-width: 90px; text-align: right; }
.data-table thead th.col-payment { width: 10%; min-width: 90px; }
.data-table thead th.col-actions { width: 12%; min-width: 100px; }

/* For all screen sizes - ensure full width usage */
.content-area,
#expenses-spa,
.card {
  max-width: none !important;
  width: 100% !important;
}

.data-table {
  width: 100% !important;
  max-width: none !important;
}

/* For very wide screens (> 1920px), adjust column proportions */
@media (min-width: 1920px) {
  /* Give description column even more space on wide screens */
  .data-table thead th.col-description { 
    width: 40%; /* Increase from 35% to 40% on wide screens */
  }
  
  /* Slightly reduce other columns to compensate */
  .data-table thead th.col-date { width: 7%; }
  .data-table thead th.col-receipt { width: 9%; }
  .data-table thead th.col-category { width: 14%; }
  .data-table thead th.col-amount { width: 9%; }
  .data-table thead th.col-payment { width: 9%; }
  .data-table thead th.col-actions { width: 12%; }
}

/* For ultra-wide screens (> 2560px), optimize further */
@media (min-width: 2560px) {
  .data-table thead th.col-description { 
    width: 45%; /* Give even more space to description */
  }
  
  .data-table thead th.col-date { width: 6%; }
  .data-table thead th.col-receipt { width: 8%; }
  .data-table thead th.col-category { width: 13%; }
  .data-table thead th.col-amount { width: 8%; }
  .data-table thead th.col-payment { width: 8%; }
  .data-table thead th.col-actions { width: 12%; }
}

/* Allow wrapping for category and description columns */
.data-table td:nth-child(3),
.data-table td:nth-child(4) {
  white-space: normal;
  overflow: visible;
}

/* Ensure actions column allows proper dropdown positioning */
.data-table td:nth-child(7) {
  position: relative;
  overflow: visible;
}

.data-table tbody tr:hover {
  background: #f8fafc;
}

.data-table tbody td {
  color: #374151;
  font-size: 14px;
}

.data-table .text-right {
  text-align: right;
}

/* Category styling */
.category-cell {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

/* Expenses page specific - no triangles needed */
#expenses-spa .category-name {
  font-weight: 500;
  color: #1f2937;
}

#expenses-spa .category-name::before {
  content: none !important;
  display: none !important;
}

.category-sub {
  font-size: 12px;
  color: #6b7280;
}

/* Filters layout - full width */
.filters { 
  display: grid; 
  gap: 12px; 
  width: 100%;
}
.filters-row { 
  display: grid; 
  gap: 12px; 
  width: 100%;
}
.filters-row.top { 
  display: grid; 
  grid-template-columns: 1.1fr 0.9fr 0.9fr 2.1fr; /* Quick, Start, End, Search (wider) */
  width: 100%;
}
.filters-row.bottom { 
  grid-template-columns: 1fr 1fr 1fr auto; 
  width: 100%;
}
.filters .filter-item { min-width: 0; }
.filters .form-control,
.filters select.form-control,
.filters input[type="date"],
.filters input[type="text"] { height: 40px; line-height: 40px; padding: 8px 12px; box-sizing: border-box; }
.summary-pill { height: 40px; display:inline-flex; align-items:center; padding: 0 12px; border:1px solid #e2e8f0; border-radius:6px; background:#f8fafc; color:#64748b; font-size:13px; white-space: nowrap; cursor: default; }
.filters-actions { display:flex; align-items:center; gap:8px; justify-content:flex-end; align-self:end; justify-self:end; }
.filters-actions .btn { height: 40px; padding: 0 12px; border-radius: 6px; font-size: 13px; }

.badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  color: white;
}

.sort-arrow {
  opacity: 0.4;
  transition: opacity 0.2s;
}

th:hover .sort-arrow {
  opacity: 0.7;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f4f6;
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.btn-outline {
  background: transparent;
  border: 1px solid #d1d5db;
  color: #6b7280;
}

.btn-outline:hover {
  background: #f9fafb;
  border-color: #9ca3af;
}

/* Action buttons styling */
.actions-cell {
  display: flex;
  gap: 8px;
  align-items: center;
}

.action-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #6b7280;
  transition: all 0.15s ease;
}

.action-btn:hover {
  background: #f3f4f6;
  color: #374151;
}

.action-btn.view-receipt {
  color: #6b7280;
}

.action-btn.view-receipt:hover {
  background: #f3f4f6;
  color: #374151;
}

/* Professional SVG icons */
.action-btn.view-receipt::before {
  content: '';
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
  pointer-events: none;
}

.action-btn:not(.view-receipt)::before {
  content: '';
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
  pointer-events: none;
}

.action-btn.view-receipt:hover::before {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E");
}

.action-btn:not(.view-receipt):hover::before {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/%3E%3C/svg%3E");
}

/* Ensure gear button is clickable */
.action-btn.gear-btn {
  position: relative;
  z-index: 10;
  pointer-events: auto;
}

/* Dropdown menu for gear wheel */
.action-dropdown {
  position: relative;
  display: inline-block;
}

.actions-cell {
  position: relative;
}

.action-menu {
  position: absolute;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  min-width: 120px;
  z-index: 10001;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-4px);
  transition: all 0.15s ease;
  pointer-events: none;
  display: flex;
  flex-direction: column;
}

.action-menu.show {
  pointer-events: auto;
}

/* Ensure dropdown appears above all table content */
.action-dropdown {
  position: relative;
  display: inline-block;
  z-index: 1000;
}

/* Ensure table rows don't interfere with dropdown stacking */
.data-table tbody tr {
  position: relative;
  z-index: 1;
}

.data-table tbody tr:hover {
  z-index: 2;
}

/* When dropdown is active, prioritize it above everything */
.action-dropdown.active {
  z-index: 10000;
}

.action-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.action-menu button {
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  font-size: 14px;
  color: #374151;
  transition: background 0.15s ease;
  display: block;
  white-space: nowrap;
}

.action-menu button:hover {
  background: #f3f4f6;
}

.action-menu button:first-child {
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
}

.action-menu button:last-child {
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}

.action-menu button.delete-action:hover {
  background: #fef2f2;
  color: #dc2626;
}

/* Medium screens (1280px - 1920px) */
@media (min-width: 1280px) and (max-width: 1919px) {
  .data-table thead th.col-description { 
    width: 38%; /* Slightly less than wide screens */
  }
}

@media (max-width: 768px) {
  .filters-row.top { grid-template-columns: 1fr 1fr; }
  .filters-row.bottom { grid-template-columns: 1fr; }
  .filters-actions { justify-content: flex-start; }
  
  /* Mobile: adjust container widths */
  body #app #content .app-main {
    margin-left: 0;
    width: 100%;
  }
  
  /* Mobile: keep padding on main content */
  .main-content {
    padding: 8px 12px; /* Slightly tighter on mobile */
    padding-bottom: 80px; /* Space for mobile bottom nav */
  }
  
  /* Mobile cards should have normal padding */
  #expenses-spa .card {
    padding: 12px;
  }
  
  /* Mobile table adjustments */
  .data-table {
    margin: -12px;
    width: calc(100% + 24px);
  }
  
  #spa-cards {
    margin: -12px;
    padding: 12px;
  }
  
  #spa-loadmore-wrap {
    margin: 0 -12px -12px -12px;
  }
}
/* AGGRESSIVE FIX: Force all parent containers to not create scrollbars */
/* But exclude the sidebar from these rules */
body > #app > #content > main,
body > #app > #content > .app-main {
  overflow-y: visible !important;
  overflow-x: hidden !important;
  height: auto !important;
  max-height: none !important;
}

/* Ensure the body itself only scrolls */
body {
  overflow-y: auto !important;
  overflow-x: hidden !important;
  height: auto !important;
  min-height: 100vh !important;
}

/* Don't break the app layout - be more targeted */

/* DEFINITIVE FIX: Override the min-height: calc(100vh - 60px) from shared.css */
div#page-root.main-content {
  overflow: visible !important;
  overflow-y: visible !important;
  overflow-x: visible !important;
  height: auto !important;
  max-height: none !important;
  min-height: auto !important; /* Override calc(100vh - 60px) */
}

/* Extra specificity to ensure it overrides shared.css */
body #app #content .app-main #page-root.main-content {
  min-height: auto !important;
  overflow: visible !important;
}

/* Also ensure all the parent chain doesn't scroll */
.app-main {
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
}

#page-root {
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
  min-height: 0 !important;
}

.main-content {
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
  min-height: 0 !important;
}

.content-area,
#expenses-spa {
  overflow: visible !important;
  height: auto !important;
  max-height: none !important;
  min-height: 0 !important;
}

/* ULTIMATE FIX: Use :not(.modal-body) to avoid conflicts and target ONLY expense card bodies */
#expenses-spa .card {
  overflow: visible !important;
  max-height: none !important;
  height: auto !important;
}

#expenses-spa .card > .card-body:not(.modal-body) {
  overflow: visible !important;
  overflow-x: visible !important;
  overflow-y: visible !important;
  max-height: none !important;
  height: auto !important;
  min-height: 0 !important;
  padding: 0 !important;
}

/* Double-ensure by using the exact path */
#page-root .content-area#expenses-spa .card .card-body {
  overflow: visible !important;
  max-height: none !important;
  height: auto !important;
}

/* Ensure the table itself doesn't create scrollbars */
#expenses-spa .data-table {
  overflow: visible !important;
}

#expenses-spa #spa-tbody {
  overflow: visible !important;
  max-height: none !important;
  height: auto !important;
}
/* FINAL FIX: Only page-level scrolling, no inner scrolling at all */

/* 1. Set up proper page scrolling */
html {
  overflow-y: auto !important;
  overflow-x: hidden !important;
  height: 100%;
}

body {
  min-height: 100%;
  overflow: visible !important; /* Let body content flow naturally */
}

/* 2. Force ALL containers to not create scroll contexts */
* {
  max-height: none !important;
}

#app {
  overflow: visible !important;
  height: auto !important;
  min-height: 100vh !important;
}

#content {
  overflow: visible !important;
  height: auto !important;
  min-height: 100vh !important;
}

.app-main {
  overflow: visible !important;
  height: auto !important;
  min-height: auto !important;
}

/* 3. The critical fix - PREVENT scroll behavior entirely */
.main-content,
#page-root.main-content {
  min-height: auto !important; /* Override calc(100vh - 60px) */
  height: auto !important;
  overflow: visible !important; /* Changed from hidden to visible */
  max-height: none !important;
  position: static !important; /* Prevent scroll context */
}

/* Force the problematic container to not scroll */
#page-root {
  overflow: clip !important; /* Newer CSS that prevents scroll without hiding content */
  overflow-x: clip !important;
  overflow-y: clip !important;
}

/* 4. Ensure all content containers flow naturally */
.content-area,
#expenses-spa,
.card,
.card-body {
  overflow: visible !important;
  height: auto !important;
  min-height: auto !important;
  max-height: none !important;
}

/* 5. Hide scrollbars on everything except html */
body::-webkit-scrollbar,
#app::-webkit-scrollbar,
#content::-webkit-scrollbar,
.app-main::-webkit-scrollbar,
.main-content::-webkit-scrollbar,
#page-root::-webkit-scrollbar,
.content-area::-webkit-scrollbar,
#expenses-spa::-webkit-scrollbar,
.card::-webkit-scrollbar,
.card-body::-webkit-scrollbar {
  display: none !important;
  width: 0 !important;
  height: 0 !important;
}

body,
#app,
#content,
.app-main,
.main-content,
#page-root,
.content-area,
#expenses-spa,
.card,
.card-body {
  scrollbar-width: none !important; /* Firefox */
  -ms-overflow-style: none !important; /* IE/Edge */
}
</style>

<script>
(function(){
  let allExpenses = [];
  let filtered = [];
  let currentPage = 1;
  let itemsPerPage = 25;
  let sortState = { column: 'date', direction: 'desc' };
  let categories = [];
  let payments = [];
  let paginationContainer = null;
  let appendMode = false; // Track if we're appending vs replacing

  function fmt(n){return new Intl.NumberFormat('en-US',{style:'currency',currency:'EUR'}).format(Number(n)||0)}
  function esc(t){ const d=document.createElement('div'); d.textContent=t||''; return d.innerHTML; }
  
  function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }
  
  function truncateText(text, maxLength) {
    if (!text || text.length <= maxLength) return esc(text);
    return esc(text.substring(0, maxLength)) + '...';
  }
  
  function getCategoryColor(category) {
    const colors = {
      'Administration': '#6366f1',
      'Programs': '#10b981', 
      'Facilities': '#f59e0b',
      'Supplies': '#ef4444',
      'Transportation': '#8b5cf6',
      'Staff': '#06b6d4'
    };
    return colors[category] || '#64748b';
  }
  
  window.viewReceipt = function(transactionNumber) {
    // TODO: Implement receipt viewing when Firebase Storage is integrated
    alert(`Receipt viewing will be implemented with Firebase Storage integration.\nTransaction #: ${transactionNumber}`);
  };
  
  window.exportExpenses = async function() {
    const exportBtn = document.querySelector('button[onclick*="exportExpenses"]');
    
    if (filtered.length === 0) {
      alert('No expenses to export');
      return;
    }
    
    try {
      // Show loading state on button
      if (exportBtn) {
        window.setButtonLoading(exportBtn, true);
      }
      
      // Show progress
      window.showPageProgress(20);
      
      // Simulate processing time for large datasets
      if (filtered.length > 100) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      window.showPageProgress(60);
      
      // Create CSV content
      const headers = ['Date', 'Transaction #', 'Category', 'Subcategory', 'Description', 'Amount', 'Payment Method'];
      const csvContent = [
        headers.join(','),
        ...filtered.map(exp => [
          exp.date || '',
          exp.transaction_number || '',
          `"${(exp.category || '').replace(/"/g, '""')}"`,
          `"${(exp.subcategory || '').replace(/"/g, '""')}"`,
          `"${(exp.description || '').replace(/"/g, '""')}"`,
          exp.amount || 0,
          `"${(exp.paymentMethod || '').replace(/"/g, '""')}"`
        ].join(','))
      ].join('\n');
      
      window.showPageProgress(80);
      
      // Download CSV
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `expenses_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      window.showPageProgress(100);
      
      // Show success notification
      const successMessage = document.createElement('div');
      successMessage.className = 'alert alert-success';
      successMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; background: #d4f6d4; color: #0f5132; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
      successMessage.textContent = `Exported ${filtered.length} expenses to CSV`;
      document.body.appendChild(successMessage);
      
      setTimeout(() => {
        successMessage.style.opacity = '0';
        successMessage.style.transform = 'translateY(-20px)';
        successMessage.style.transition = 'opacity 0.3s, transform 0.3s';
        setTimeout(() => successMessage.remove(), 300);
      }, 3000);
      
    } catch (error) {
      console.error('Export failed:', error);
      window.showPageProgress(100);
      
      // Show error notification
      const errorMessage = document.createElement('div');
      errorMessage.className = 'alert alert-error';
      errorMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; background: #fee2e2; color: #991b1b; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
      errorMessage.textContent = 'Export failed. Please try again.';
      document.body.appendChild(errorMessage);
      
      setTimeout(() => {
        errorMessage.style.opacity = '0';
        errorMessage.style.transform = 'translateY(-20px)';
        errorMessage.style.transition = 'opacity 0.3s, transform 0.3s';
        setTimeout(() => errorMessage.remove(), 300);
      }, 4000);
      
    } finally {
      // Remove loading state from button
      if (exportBtn) {
        window.setButtonLoading(exportBtn, false);
      }
    }
  };
  
  window.clearFilters = function() {
    document.getElementById('spa-quick').value = '30';
    document.getElementById('spa-cat').value = '';
    document.getElementById('spa-sub').value = '';
    document.getElementById('spa-pay').value = '';
    document.getElementById('spa-search').value = '';
    // Reset to current month
    const now = new Date(); 
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    document.getElementById('spa-start').value = start.toISOString().slice(0,10);
    document.getElementById('spa-end').value = now.toISOString().slice(0,10);
    load();
  };

  function updateStats(){
    const sum = allExpenses.reduce((s,e)=>s+(Number(e.amount)||0),0);
    const avg = allExpenses.length > 0 ? sum / allExpenses.length : 0;
    
    // Update summary stats (only if elements exist)
    const totalEl = document.getElementById('spa-total');
    const avgEl = document.getElementById('spa-average');
    const countEl = document.getElementById('spa-expense-count');
    
    if (totalEl) totalEl.textContent = fmt(sum);
    if (avgEl) avgEl.textContent = fmt(avg);
    if (countEl) countEl.textContent = allExpenses.length.toLocaleString();
  }
  
  function updateCount(displayedItems, totalFiltered){
    const sum = displayedItems.reduce((s,e)=>s+(Number(e.amount)||0),0);
    document.getElementById('spa-count').textContent = `Showing ${displayedItems.length} of ${totalFiltered} expenses ‚Ä¢ ${fmt(sum)} on this page`;
  }

  function applySorting(){
    allExpenses.sort((a,b)=>{
      let av,bv;
      switch (sortState.column){
        case 'date': av = new Date(a.date); bv = new Date(b.date); break;
        case 'amount': av = Number(a.amount)||0; bv = Number(b.amount)||0; break;
        default: av = (a[sortState.column]||'').toString().toLowerCase(); bv = (b[sortState.column]||'').toString().toLowerCase();
      }
      if (av<bv) return sortState.direction==='asc'?-1:1;
      if (av>bv) return sortState.direction==='asc'?1:-1;
      return 0;
    });
  }

  function updateSortArrows(){
    document.querySelectorAll('#expenses-spa thead th .sort-arrow').forEach(a=>{ a.textContent='‚áÖ'; a.style.opacity='0.4'; });
    const th = document.querySelector(`#expenses-spa thead th[data-sort="${sortState.column}"] .sort-arrow`);
    if (th){ th.textContent = sortState.direction==='asc'?'‚Üë':'‚Üì'; th.style.opacity='1'; }
  }

  function renderPage(){
    const searchTerm = document.getElementById('spa-search').value;
    const filters = {
      category: document.getElementById('spa-cat').value,
      subcategory: document.getElementById('spa-sub').value,
      paymentMethod: document.getElementById('spa-pay').value
    };
    
    // Apply date filters
    const start = document.getElementById('spa-start').value;
    const end = document.getElementById('spa-end').value;
    
    let filteredExpenses = allExpenses.filter(e=>{
      if (start && new Date(e.date) < new Date(start)) return false;
      if (end) { const d=new Date(end); d.setHours(23,59,59,999); if (new Date(e.date)>d) return false; }
      return true;
    });
    
    // Use the new pagination system
    const paginationResult = window.createSearchablePagination(
      filteredExpenses,
      searchTerm,
      filters,
      currentPage,
      itemsPerPage,
      handlePageChange,
      handlePageSizeChange
    );
    
    const { items: displayedItems, pagination, totalItems, currentPage: validCurrentPage } = paginationResult;
    currentPage = validCurrentPage;
    
    // Render table
    const tbody = document.getElementById('spa-tbody');
    const cards = document.getElementById('spa-cards');
    const isMobile = window.innerWidth<=768;
    
    // Only clear if not in append mode (Load More)
    if (!appendMode) {
      tbody.innerHTML = '';
      cards.innerHTML = '';
    }
    appendMode = false; // Reset after use
    
    if (displayedItems.length === 0) {
      if (totalItems === 0) {
        window.showEmptyState(tbody, 'üìã', 'No expenses found', searchTerm ? 'Try adjusting your search or filters' : 'Click "Add Expense" to get started');
      } else {
        window.showEmptyState(tbody, 'üîç', 'No results', 'No expenses match your current filters');
      }
      return;
    }
    
    displayedItems.forEach((exp, index) => {
      if (!isMobile){
        const tr=document.createElement('tr');
        
        // Clean transaction number without link styling
        const transactionNumber = exp.transaction_number || '';
        
        // Category cell with subcategory (bold, bigger) and category (smaller, grey)
        // MORE AGGRESSIVE: Remove ANY non-letter/non-space character at the start
        // This will catch any arrow, symbol, or special character
        let cleanSubcategory = (exp.subcategory||'')
          // First try to remove specific arrows
          .replace(/[‚ñ∂‚ñ∫‚ñ∏‚ñº‚ñ≤‚ñ∑‚óÄ‚óÅ‚ñπ‚óÇ‚ñ¥‚ñæ‚Üí‚Üê‚Üë‚Üì‚ü∂‚üµ‚ü∑‚û§‚ûú‚û°‚¨Ö‚¨Ü‚¨á‚Øà‚ØÜ‚ØÖ‚Øá]/g, '')
          // Then remove any Unicode arrows in various ranges
          .replace(/[\u2190-\u21FF]/g, '') // Arrows block
          .replace(/[\u25A0-\u25FF]/g, '') // Geometric shapes (includes triangles)
          .replace(/[\u2700-\u27BF]/g, '') // Dingbats
          .replace(/[\u2900-\u297F]/g, '') // Supplemental Arrows-B
          // Finally, remove any non-letter character at the beginning
          .replace(/^[^\w\s]+/, '')
          .trim();
        
        let cleanCategory = (exp.category||'')
          .replace(/[‚ñ∂‚ñ∫‚ñ∏‚ñº‚ñ≤‚ñ∑‚óÄ‚óÅ‚ñπ‚óÇ‚ñ¥‚ñæ‚Üí‚Üê‚Üë‚Üì‚ü∂‚üµ‚ü∑‚û§‚ûú‚û°‚¨Ö‚¨Ü‚¨á‚Øà‚ØÜ‚ØÖ‚Øá]/g, '')
          .replace(/[\u2190-\u21FF]/g, '')
          .replace(/[\u25A0-\u25FF]/g, '')
          .replace(/[\u2700-\u27BF]/g, '')
          .replace(/[\u2900-\u297F]/g, '')
          .replace(/^[^\w\s]+/, '')
          .trim();
        const categoryCell = `
          <div class="category-cell">
            <div class="category-name" style="font-weight: bold; font-size: 14px; color: #111;">${esc(cleanSubcategory || 'General')}</div>
            <div class="category-sub" style="font-size: 12px; color: #6b7280; font-style: italic; margin-top: 2px;">${esc(cleanCategory || '')}</div>
          </div>
        `;
        
        // Actions with eye (view receipt) and gear (menu)
        const actionsCell = `
          <div class="actions-cell">
            <button class="action-btn view-receipt" onclick="viewReceipt('${exp.transaction_number}')" title="View receipt"></button>
            <div class="action-dropdown">
              <button class="action-btn gear-btn" onclick="window.toggleActionMenu(this); return false;" title="More actions"></button>
              <div class="action-menu">
                <button onclick="editExpense('${exp.id}')">Edit</button>
                <button class="delete-action" onclick="deleteExpense('${exp.id}')">Delete</button>
              </div>
            </div>
          </div>
        `;
        
        tr.innerHTML=`
          <td>${formatDate(exp.date||'')}</td>
          <td>${esc(transactionNumber)}</td>
          <td>${categoryCell}</td>
          <td title="${esc(exp.description||'')}">${esc(exp.description||'')}</td>
          <td class="text-right"><strong>${fmt(exp.amount||0)}</strong></td>
          <td>${esc(exp.paymentMethod||'')}</td>
          <td>${actionsCell}</td>
        `;
        
        // Add staggered animation
        tr.style.opacity = '0';
        tr.style.transform = 'translateY(10px)';
        tr.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        tbody.appendChild(tr);
        
        setTimeout(() => {
          tr.style.opacity = '1';
          tr.style.transform = 'translateY(0)';
        }, 50 * index);
      } else {
        const div=document.createElement('div');
        div.className='expense-card';
        
        const mobileActionsCell = `
          <div class="actions-cell">
            <button class="action-btn view-receipt" onclick="viewReceipt('${exp.transaction_number}')" title="View receipt"></button>
            <div class="action-dropdown">
              <button class="action-btn gear-btn" onclick="window.toggleActionMenu(this); return false;" title="More actions"></button>
              <div class="action-menu">
                <button onclick="editExpense('${exp.id}')">Edit</button>
                <button class="delete-action" onclick="deleteExpense('${exp.id}')">Delete</button>
              </div>
            </div>
          </div>
        `;
        
        // MORE AGGRESSIVE arrow removal for mobile view
        const cleanSubcategoryMobile = (exp.subcategory||'General')
          .replace(/[‚ñ∂‚ñ∫‚ñ∏‚ñº‚ñ≤‚ñ∑‚óÄ‚óÅ‚ñπ‚óÇ‚ñ¥‚ñæ‚Üí‚Üê‚Üë‚Üì‚ü∂‚üµ‚ü∑‚û§‚ûú‚û°‚¨Ö‚¨Ü‚¨á‚Øà‚ØÜ‚ØÖ‚Øá]/g, '')
          .replace(/[\u2190-\u21FF]/g, '')
          .replace(/[\u25A0-\u25FF]/g, '')
          .replace(/[\u2700-\u27BF]/g, '')
          .replace(/[\u2900-\u297F]/g, '')
          .replace(/^[^\w\s]+/, '')
          .trim();
        const cleanCategoryMobile = (exp.category||'')
          .replace(/[‚ñ∂‚ñ∫‚ñ∏‚ñº‚ñ≤‚ñ∑‚óÄ‚óÅ‚ñπ‚óÇ‚ñ¥‚ñæ‚Üí‚Üê‚Üë‚Üì‚ü∂‚üµ‚ü∑‚û§‚ûú‚û°‚¨Ö‚¨Ü‚¨á‚Øà‚ØÜ‚ØÖ‚Øá]/g, '')
          .replace(/[\u2190-\u21FF]/g, '')
          .replace(/[\u25A0-\u25FF]/g, '')
          .replace(/[\u2700-\u27BF]/g, '')
          .replace(/[\u2900-\u297F]/g, '')
          .replace(/^[^\w\s]+/, '')
          .trim();
        div.innerHTML=`
          <div class="expense-card-main">
            <div>
              <div><strong>${esc(cleanSubcategoryMobile)}</strong></div>
              <div class="expense-card-sub">${esc(cleanCategoryMobile)}</div>
            </div>
            <div><strong>${fmt(exp.amount||0)}</strong></div>
          </div>
          <div class="expense-card-sub" style="margin-top:6px;">${esc(exp.description||'')}</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px;">
            <div style="font-size: 12px; color: #6b7280;">${exp.date||''} ‚Ä¢ ${esc(exp.paymentMethod||'')}</div>
            ${mobileActionsCell}
          </div>
        `;
        
        // Add staggered animation for mobile cards
        div.style.opacity = '0';
        div.style.transform = 'translateY(10px)';
        div.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        cards.appendChild(div);
        
        setTimeout(() => {
          div.style.opacity = '1';
          div.style.transform = 'translateY(0)';
        }, 50 * index);
      }
    });
    
    // Update pagination UI
    updatePaginationUI(pagination, totalItems);
    
    // Update count display
    updateCount(displayedItems, totalItems);

    // Conditional Load More visibility (per requirements)
    const moreWrapContainer = document.getElementById('spa-loadmore-wrap');
    const totalExpenseCount = totalItems;
    const currentlyDisplayedCount = validCurrentPage * itemsPerPage;
    if (moreWrapContainer) {
      const shouldShow = (totalExpenseCount >= 50) && (currentlyDisplayedCount < totalExpenseCount);
      moreWrapContainer.style.display = shouldShow ? 'block' : 'none';
      const moreBtn = document.getElementById('spa-more');
      if (moreBtn) {
        moreBtn.onclick = () => {
          if ((validCurrentPage * itemsPerPage) < totalExpenseCount) {
            appendMode = true; // Set append mode for Load More
            itemsPerPage += 25; // Increase items per page to show more
            renderPage();
          }
        };
      }
    }
    
    // Note: Actions now use direct onclick handlers in HTML
  }
  
  function updatePaginationUI(pagination, totalItems) {
    // Remove existing pagination
    if (paginationContainer) {
      paginationContainer.remove();
    }
    
    // Only show pagination if there are results
    if (totalItems > 0) {
      paginationContainer = pagination;
      
      // Insert pagination after the table/cards
      const tableCard = document.querySelector('.card:has(.data-table)') || document.querySelector('.card:has(#spa-cards)');
      if (tableCard) {
        tableCard.parentNode.insertBefore(paginationContainer, tableCard.nextSibling);
      }
    }
  }
  
  function handlePageChange(newPage) {
    window.setPaginationLoading(paginationContainer, true);
    
    currentPage = newPage;
    applySorting();
    
    setTimeout(() => {
      renderPage();
      window.setPaginationLoading(paginationContainer, false);
      
      // Scroll to top of table
      const tableCard = document.querySelector('.card:has(.data-table)');
      if (tableCard) {
        tableCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 300);
  }
  
  function handlePageSizeChange(newSize) {
    itemsPerPage = parseInt(newSize);
    currentPage = 1; // Reset to first page
    renderPage();
  }

  function applyFilters(){
    currentPage = 1; // Reset to first page when filters change
    applySorting();
    renderPage();
  }

  async function load(){
    // Show enhanced loading states
    const loadingEl = document.getElementById('loading-indicator');
    const tableEl = document.querySelector('.data-table');
    const tbody = document.getElementById('spa-tbody');
    const loadButton = document.getElementById('spa-load');
    
    // Show progress indicator
    window.showPageProgress(20);
    
    // Show table skeleton
    if (tbody) {
      window.showTableSkeleton(tbody, 8, 8);
    }
    
    // Show loading overlay on filters
    const filtersContainer = document.querySelector('.filters-row.top');
    const filtersOverlay = window.showLoading(filtersContainer, 'Loading filters...');
    
    // Set button loading state
    if (loadButton) {
      window.setButtonLoading(loadButton, true);
    }
    
    if (loadingEl) loadingEl.style.display = 'block';
    if (tableEl) tableEl.style.opacity = '0.5';
    
    try {
      window.showPageProgress(40);
      
      // build params
      const s = document.getElementById('spa-start').value;
      const e = document.getElementById('spa-end').value;
      const params = new URLSearchParams(); 
      if(s) params.set('startDate', s); 
      if(e) params.set('endDate', e); 
      params.set('limit','1000'); // Increased limit for better filtering
      
      window.showPageProgress(60);
      
      // Use TransactionService to get expenses
      const filters = {
        type: 'expense',
        limit: 1000
      };
      if(s) filters.startDate = s;
      if(e) filters.endDate = e;
      
      allExpenses = await window.TransactionService.getList(filters) || [];
      
      window.showPageProgress(80);
      
      // Update overall stats
      updateStats();
      
      // Apply sorting and render with pagination
      applySorting();
      renderPage();
      
      window.showPageProgress(100);
      
      // Add success feedback
      if (allExpenses.length > 0) {
        const successMessage = document.createElement('div');
        successMessage.className = 'alert alert-success';
        successMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; background: #d4f6d4; color: #0f5132; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
        successMessage.textContent = `Loaded ${allExpenses.length} expenses successfully`;
        document.body.appendChild(successMessage);
        
        setTimeout(() => {
          successMessage.style.opacity = '0';
          successMessage.style.transform = 'translateY(-20px)';
          successMessage.style.transition = 'opacity 0.3s, transform 0.3s';
          setTimeout(() => successMessage.remove(), 300);
        }, 2000);
      }
      
    } catch (error) {
      console.error('Failed to load expenses:', error);
      window.showPageProgress(100);
      
      if (tbody) {
        window.showEmptyState(tbody, '‚ùå', 'Failed to load expenses', 'Please check your connection and try again');
      }
      
      // Show error notification
      const errorMessage = document.createElement('div');
      errorMessage.className = 'alert alert-error';
      errorMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 12px 20px; background: #fee2e2; color: #991b1b; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
      errorMessage.textContent = 'Failed to load expenses. Please try again.';
      document.body.appendChild(errorMessage);
      
      setTimeout(() => {
        errorMessage.style.opacity = '0';
        errorMessage.style.transform = 'translateY(-20px)';
        errorMessage.style.transition = 'opacity 0.3s, transform 0.3s';
        setTimeout(() => errorMessage.remove(), 300);
      }, 4000);
      
    } finally {
      // Hide all loading states
      if (loadingEl) loadingEl.style.display = 'none';
      if (tableEl) tableEl.style.opacity = '1';
      if (filtersOverlay && filtersContainer) {
        window.hideLoading(filtersContainer);
      }
      if (loadButton) {
        window.setButtonLoading(loadButton, false);
      }
    }
  }

  function populateFilters(){
    const catSel=document.getElementById('spa-cat'); const subSel=document.getElementById('spa-sub'); const paySel=document.getElementById('spa-pay');
    catSel.innerHTML='<option value="">All</option>';
    (categories||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.name; o.textContent=c.name; catSel.appendChild(o); });
    
    // Hardcoded payment methods - only Card, Cash, Bank Transfer
    paySel.innerHTML='<option value="">All</option>';
    const hardcodedPayments = ['Card', 'Cash', 'Bank Transfer'];
    hardcodedPayments.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; paySel.appendChild(o); });
    subSel.innerHTML='<option value="">All</option>';
    catSel.onchange = ()=>{
      subSel.innerHTML='<option value="">All</option>';
      const c = categories.find(x=>x.name===catSel.value);
      if (c && c.subcategories){ c.subcategories.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; subSel.appendChild(o); }); }
      applyFilters();
    }
  }

  function quickSelect(){
    const v=document.getElementById('spa-quick').value; const end=new Date(); let start=new Date();
    switch (v){ 
      case '7': start.setDate(end.getDate()-7); break; 
      case '30': start.setDate(end.getDate()-30); break; 
      case '90': start.setDate(end.getDate()-90); break; 
      case '365': start.setFullYear(end.getFullYear()-1); break; 
      case 'all': 
        // Clear date filters for "All Time" to show ALL expenses
        document.getElementById('spa-start').value = '';
        document.getElementById('spa-end').value = '';
        load();
        return;
      default: return; 
    }
    document.getElementById('spa-start').value = start.toISOString().slice(0,10);
    document.getElementById('spa-end').value = end.toISOString().slice(0,10);
    load();
  }

  window.initializeExpensesPage = async function(){
    // PREVENT INNER SCROLLING - Force scroll events to bubble to HTML
    const pageRoot = document.getElementById('page-root');
    const mainContent = document.querySelector('.main-content');
    
    // Prevent scroll on these containers
    [pageRoot, mainContent].forEach(el => {
      if (el) {
        // Prevent wheel scrolling on inner container
        el.addEventListener('wheel', function(e) {
          if (el.scrollHeight > el.clientHeight) {
            e.preventDefault();
            // Transfer the scroll to the HTML element
            document.documentElement.scrollTop += e.deltaY;
          }
        }, { passive: false });
        
        // Force overflow visible to prevent scroll context
        el.style.overflow = 'visible';
        el.style.overflowY = 'visible';
        el.style.overflowX = 'visible';
      }
    });
    // initialize dates
    const now = new Date(); const start = new Date(now.getFullYear(), now.getMonth(), 1); 
    document.getElementById('spa-start').value = start.toISOString().slice(0,10);
    document.getElementById('spa-end').value = now.toISOString().slice(0,10);
    // load filter datasets
    try {
      const catRes = await window.callApi('/categories');
      // Only use active categories
      categories = (catRes.data||[]).filter(cat => cat.active !== false);
    } catch (e) { 
      console.warn('Categories load failed', e); 
      // Use fallback categories
      categories = [
        { name: 'Operations', subcategories: ['Administrative', 'Office Supplies', 'Communications'] },
        { name: 'Programs', subcategories: ['Direct Aid', 'Education', 'Healthcare', 'Food Distribution'] },
        { name: 'Facilities', subcategories: ['Rent', 'Utilities', 'Maintenance', 'Security'] },
        { name: 'Transportation', subcategories: ['Fuel', 'Vehicle Maintenance', 'Public Transport'] },
        { name: 'Other', subcategories: ['General', 'Miscellaneous'] }
      ];
    }
    populateFilters();

    // events
    const loadBtn = document.getElementById('spa-load');
    if (loadBtn) loadBtn.onclick = load;
    
    // Fix Add Expense button with better error handling
    const addBtn = document.getElementById('spa-add');
    if (addBtn) {
      addBtn.onclick = () => {
        console.log('Add Expense button clicked');
        if (window.openExpenseModal) {
          window.openExpenseModal();
        } else {
          console.error('openExpenseModal not found, trying fallback...');
          // Fallback: manually show the modal
          const modal = document.getElementById('add-expense-modal');
          if (modal) {
            // Initialize form with default values
            const today = new Date().toISOString().slice(0,10);
            const dateField = document.getElementById('expense-date');
            if (dateField) dateField.value = today;
            modal.style.display = 'block';
          } else {
            alert('The expense modal is not loaded. Please refresh the page and try again.');
          }
        }
      };
    }
    
    document.getElementById('spa-quick').onchange = quickSelect;
    document.getElementById('spa-pay').onchange = applyFilters;
    document.getElementById('spa-sub').onchange = applyFilters;
    document.getElementById('spa-search').oninput = ()=>{ clearTimeout(window._deb); window._deb=setTimeout(applyFilters,150); };
    // Sort handlers
    document.querySelectorAll('#expenses-spa thead th[data-sort]').forEach(th=>{
      th.onclick = ()=>{
        const col = th.getAttribute('data-sort');
        if (sortState.column===col){ sortState.direction = sortState.direction==='asc'?'desc':'asc'; } else { sortState.column = col; sortState.direction = col==='date'?'desc':'asc'; }
        updateSortArrows();
        currentPage = 1; // Reset to first page when sorting
        applySorting();
        renderPage();
      }
    });
    updateSortArrows();
    await load();
  };
  
  // Action menu functions
  window.toggleActionMenu = function(button) {
    console.log('toggleActionMenu called with button:', button);
    
    // Close any other open menus and remove active classes
    document.querySelectorAll('.action-menu.show').forEach(menu => {
      if (menu !== button.nextElementSibling) {
        menu.classList.remove('show');
        menu.closest('.action-dropdown').classList.remove('active');
      }
    });
    
    // Toggle this menu
    const menu = button.nextElementSibling;
    const dropdown = button.closest('.action-dropdown');
    console.log('Menu element:', menu);
    console.log('Dropdown element:', dropdown);
    
    if (menu.classList.contains('show')) {
      menu.classList.remove('show');
      dropdown.classList.remove('active');
    } else {
      // Reset any previous positioning
      menu.style.left = '';
      menu.style.top = '';
      menu.style.right = '';
      menu.style.bottom = '';
      menu.style.marginTop = '';
      menu.style.marginBottom = '';
      menu.style.marginLeft = '';
      menu.style.marginRight = '';
      
      console.log('Button position:', button.getBoundingClientRect());
      console.log('Dropdown position:', dropdown.getBoundingClientRect());
      console.log('Viewport size:', window.innerWidth, 'x', window.innerHeight);
      
      // Simple default positioning - menu below button, aligned to right
      menu.style.top = '100%';
      menu.style.right = '0';
      menu.style.marginTop = '2px';
      
      menu.classList.add('show');
      dropdown.classList.add('active');
      console.log('Menu positioned simply at bottom-right of dropdown');
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!button.contains(e.target) && !menu.contains(e.target)) {
            menu.classList.remove('show');
            dropdown.classList.remove('active');
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 0);
    }
  };
  
  window.editExpense = async function(id) {
    // Close any open menus
    document.querySelectorAll('.action-menu.show').forEach(menu => {
      menu.classList.remove('show');
      menu.closest('.action-dropdown').classList.remove('active');
    });
    
    if (window.openExpenseModal) {
      window.openExpenseModal(id);
    } else {
      console.error('openExpenseModal not found');
      alert('Edit functionality not available. Please refresh the page.');
    }
  };
  
  window.deleteExpense = async function(id) {
    // Close any open menus
    document.querySelectorAll('.action-menu.show').forEach(menu => {
      menu.classList.remove('show');
      menu.closest('.action-dropdown').classList.remove('active');
    });
    
    if (confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
      try {
        // Actually delete the transaction
        await window.TransactionService.delete(id);
        load(); // Reload the list
      } catch (error) {
        console.error('Delete failed:', error);
        alert('Failed to delete expense. Please try again.');
      }
    }
  };
  
  window.registerPageInitializer('expenses', window.initializeExpensesPage);
})();
</script>

