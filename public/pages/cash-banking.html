<div class="content-area" id="cash-banking-page">
  <div class="page-header">
    <h2 class="page-title">Cash & Banking</h2>
    <div class="page-actions">
      <button class="btn btn-primary" id="record-movement">ðŸ’° Record Movement</button>
    </div>
  </div>
  
  <!-- Summary Cards (Budget page style) -->
  <div class="budget-summary-row">
    <div class="card">
      <div class="summary-label">Current Cash Balance</div>
      <div id="cb-cash" class="summary-value">â‚¬0.00</div>
      <small id="cb-cash-trend" class="summary-trend">Updated just now</small>
    </div>
    <div class="card">
      <div class="summary-label">Expected Donations</div>
      <div id="cb-expected" class="summary-value text-info">â‚¬0.00</div>
      <small id="cb-expected-count" class="summary-trend">0 pending</small>
    </div>
    <div class="card">
      <div class="summary-label">Received This Month</div>
      <div id="cb-received" class="summary-value text-success">â‚¬0.00</div>
      <small id="cb-received-count" class="summary-trend">0 donations</small>
    </div>
    <div class="card">
      <div class="summary-label">Bank Balance</div>
      <div id="cb-bank" class="summary-value">â‚¬0.00</div>
      <small class="summary-trend">Updated just now</small>
    </div>
  </div>

  <!-- Tab Navigation (Budget page style) -->
  <div class="tab-nav-container">
    <div class="tab-nav">
      <button class="tab-nav-button active" data-tab="movements">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="2" x2="12" y2="22"></line>
          <polyline points="19 9 12 2 5 9"></polyline>
          <polyline points="19 15 12 22 5 15"></polyline>
        </svg>
        Cash Movements
      </button>
      <button class="tab-nav-button" data-tab="bank">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
          <line x1="1" y1="10" x2="23" y2="10"></line>
        </svg>
        Bank Movements
      </button>
      <button class="tab-nav-button" data-tab="expected">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Expected Income
      </button>
    </div>
  </div>
  
  <!-- Cash Movements Tab -->
  <div class="tab-panel active" id="tab-movements">
    <!-- Filter Menu - Fixed to single row -->
    <div class="card mb-3" style="overflow: hidden;">
      <div class="card-body" style="padding: 0;">
        <div class="filters">
          <div class="filters-row">
            <div class="filter-item" style="flex: 0 1 auto; min-width: 140px;">
              <label class="form-label">Quick Select</label>
              <select id="cb-quick" class="form-control">
                <option value="">Custom Range</option>
                <option value="7">Past 7 Days</option>
                <option value="30" selected>Past 30 Days</option>
                <option value="90">Past 90 Days</option>
                <option value="365">Past 12 Months</option>
                <option value="all">All Time</option>
              </select>
            </div>
            <div class="filter-item" style="flex: 0 1 auto; min-width: 140px;">
              <label class="form-label">Start Date</label>
              <input type="date" id="cb-start" class="form-control" />
            </div>
            <div class="filter-item" style="flex: 0 1 auto; min-width: 140px;">
              <label class="form-label">End Date</label>
              <input type="date" id="cb-end" class="form-control" />
            </div>
            <div class="filter-item" style="flex: 0 1 auto; min-width: 160px;">
              <label class="form-label">Type</label>
              <select id="cb-type-filter" class="form-control">
                <option value="">All Types</option>
                <option value="withdrawal">Withdrawal</option>
                <option value="deposit">Deposit</option>
                <option value="donation">Donation</option>
                <option value="cash-expense">Cash Expense</option>
              </select>
            </div>
            <div class="filter-item" style="flex: 1 1 200px; min-width: 200px;">
              <label class="form-label">Search</label>
              <input type="text" id="cb-search" class="form-control" placeholder="Search description..." />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content Card -->
    <div class="card" style="position: relative;">
      <div class="card-body" style="padding: 0;">
        <!-- Top Bar -->
        <div class="top-bar" id="cb-top-bar">
          <div class="top-bar-content">
            <div class="top-bar-left"></div>
            <div class="top-bar-center"></div>
            <div class="top-bar-right"></div>
          </div>
        </div>
        <div style="padding-top: 42px; padding-bottom: 36px;">
          <table class="data-table" style="margin: 0;">
            <thead>
              <tr>
                <th class="col-date">DATE</th>
                <th class="col-type">TYPE</th>
                <th class="col-description">DESCRIPTION</th>
                <th class="col-amount text-right">AMOUNT</th>
                <th class="col-balance text-right">REM. BALANCE</th>
                <th class="col-actions" style="text-align: center;">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="cb-tbody">
              <tr><td colspan="6" class="text-center text-muted">Loading cash movements...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="bottom-bar" id="cb-bottom-bar">
        <div class="bottom-bar-content">
          <div class="bottom-bar-left">
            <span id="cb-opening-balance" style="display:none; font-size: 13px;">
              <span class="text-muted">Opening Balance:&nbsp;&nbsp;</span>
              <strong id="cb-opening-amount" style="font-weight: 600;">â‚¬0.00</strong>
            </span>
          </div>
          <div class="bottom-bar-center" id="cb-loadmore-wrap" style="display:none;">
            <button class="btn btn-secondary btn-sm" id="cb-more">Load More</button>
          </div>
          <div class="bottom-bar-right">
            <span id="cb-items-info" class="text-muted" style="font-size: 13px;"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Expected Income Tab -->
  <div class="tab-panel" id="tab-expected">
    <div class="card">
      <div class="action-bar">
        <button class="btn btn-sm btn-primary" onclick="openExpectedIncomeModal()">âž• Add Expected Income</button>
        <button class="btn btn-sm btn-outline" onclick="exportExpectedIncome()">Export</button>
      </div>
      
      <div class="card-body">
        <table class="data-table" id="expected-table">
          <thead>
            <tr>
              <th>Expected Date</th>
              <th>Source</th>
              <th>Description</th>
              <th class="text-right">Amount</th>
              <th>Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="expected-tbody">
            <tr>
              <td colspan="6" class="text-center text-muted">No expected income entries yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Bank Movements Tab -->
  <div class="tab-panel" id="tab-bank">
    <!-- Filter Menu - Fixed to single row -->
    <div class="card mb-3" style="overflow: hidden;">
      <div class="card-body" style="padding: 0;">
        <div class="filters">
          <div class="filters-row">
            <div class="filter-item" style="flex: 0 1 auto; min-width: 140px;">
              <label class="form-label">Quick Select</label>
              <select id="bank-quick" class="form-control">
                <option value="">Custom Range</option>
                <option value="7">Past 7 Days</option>
                <option value="30" selected>Past 30 Days</option>
                <option value="90">Past 90 Days</option>
                <option value="365">Past 12 Months</option>
                <option value="all">All Time</option>
              </select>
            </div>
            <div class="filter-item" style="flex: 0 1 auto; min-width: 140px;">
              <label class="form-label">Start Date</label>
              <input type="date" id="bank-start" class="form-control" />
            </div>
            <div class="filter-item" style="flex: 0 1 auto; min-width: 140px;">
              <label class="form-label">End Date</label>
              <input type="date" id="bank-end" class="form-control" />
            </div>
            <div class="filter-item" style="flex: 0 1 auto; min-width: 160px;">
              <label class="form-label">Type</label>
              <select id="bank-type-filter" class="form-control">
                <option value="">All Types</option>
                <option value="transfer">Transfer</option>
                <option value="payment">Payment</option>
                <option value="income">Income</option>
              </select>
            </div>
            <div class="filter-item" style="flex: 1 1 200px; min-width: 200px;">
              <label class="form-label">Search</label>
              <input type="text" id="bank-search" class="form-control" placeholder="Search description..." />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Content Card -->
    <div class="card" style="position: relative;">
      <div class="card-body" style="padding: 0;">
        <!-- Top Bar -->
        <div class="top-bar" id="bank-top-bar">
          <div class="top-bar-content">
            <div class="top-bar-left"></div>
            <div class="top-bar-center"></div>
            <div class="top-bar-right"></div>
          </div>
        </div>
        <div style="padding-top: 42px; padding-bottom: 36px;">
          <table class="data-table" style="margin: 0;">
            <thead>
              <tr>
                <th class="col-date">DATE</th>
                <th class="col-type">TYPE</th>
                <th class="col-description">DESCRIPTION</th>
                <th class="col-amount text-right">AMOUNT</th>
                <th class="col-balance text-right">REM. BALANCE</th>
                <th class="col-actions" style="text-align: center;">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="bank-tbody">
              <tr><td colspan="6" class="text-center text-muted">Loading bank movements...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="bottom-bar" id="bank-bottom-bar">
        <div class="bottom-bar-content">
          <div class="bottom-bar-left">
            <span id="bank-opening-balance" style="display:none; font-size: 13px;">
              <span class="text-muted">Opening Balance:&nbsp;&nbsp;</span>
              <strong id="bank-opening-amount" style="font-weight: 600;">â‚¬0.00</strong>
            </span>
          </div>
          <div class="bottom-bar-center" id="bank-loadmore-wrap" style="display:none;">
            <button class="btn btn-secondary btn-sm" id="bank-more">Load More</button>
          </div>
          <div class="bottom-bar-right">
            <span id="bank-items-info" class="text-muted" style="font-size: 13px;"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Unified Record Movement Modal -->
<div id="movement-modal" class="modal" style="display:none;">
  <div class="modal-content modal-movement">
    <div class="modal-header">
      <h3>Record Movement</h3>
      <button class="close-modal" onclick="closeMovementModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="movement-description">
        Record cash and bank movements including donations received, withdrawals, and deposits between accounts.
      </div>
      
      <div class="form-group">
        <label>Account</label>
        <div class="account-selector">
          <button type="button" class="account-option" data-account="cash" onclick="selectAccount('cash')">
            <svg class="account-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 7V5a2 2 0 0 0-2-2H10a2 2 0 0 0-2 2v2"></path>
              <circle cx="12" cy="14" r="2"></circle>
            </svg>
            <span>Cash</span>
          </button>
          <button type="button" class="account-option" data-account="bank" onclick="selectAccount('bank')">
            <svg class="account-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <span>Bank</span>
          </button>
        </div>
        <input type="hidden" id="movement-account" value="cash" />
      </div>
      
      <div class="form-row">
        <div class="form-group" style="flex: 1.5;">
          <label>Type</label>
          <select id="movement-type" class="form-control" onchange="updateMovementForm(true)">
            <option value="income">Income / Donation</option>
            <option value="withdrawal">Bank Withdrawal (to Cash)</option>
            <option value="deposit">Cash Deposit (to Bank)</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1;">
          <label>Date</label>
          <input type="date" id="movement-date" class="form-control" />
        </div>
      </div>
      
      <div class="form-group">
        <label>Amount (â‚¬)</label>
        <input type="number" id="movement-amount" class="form-control" step="0.01" min="0" />
      </div>
      
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="movement-description" class="form-control" placeholder="Enter description..." />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeMovementModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMovement()">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  // State management
  let allMovements = [];
  let filteredMovements = [];
  let currentFilters = {
    startDate: '',
    endDate: '',
    type: '',
    search: ''
  };
  let cashPageSize = 50;
  let cashCurrentPage = 1;
  let bankPageSize = 50;
  let bankCurrentPage = 1;
  let categories = [];

  // Utility functions
  function fmt(amount) {
    if (amount === null || amount === undefined) return 'â‚¬0.00';
    // Show negative amounts with minus sign
    if (amount < 0) {
      return '-â‚¬' + Math.abs(amount).toFixed(2);
    }
    return 'â‚¬' + amount.toFixed(2);
  }
  
  function fmtSigned(amount) {
    if (amount === null || amount === undefined) return 'â‚¬0.00';
    const sign = amount < 0 ? '-' : '+';
    return sign + 'â‚¬' + Math.abs(amount).toFixed(2);
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('en-GB');
  }
  
  function esc(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
  
  // Initialize date filters based on quick select
  function updateDateFilters() {
    const quick = document.getElementById('cb-quick').value;
    const endDate = new Date();
    let startDate = new Date();
    
    if (quick && quick !== 'all') {
      startDate.setDate(endDate.getDate() - parseInt(quick));
      const startStr = startDate.toISOString().split('T')[0];
      const endStr = endDate.toISOString().split('T')[0];
      
      document.getElementById('cb-start').value = startStr;
      document.getElementById('cb-end').value = endStr;
      currentFilters.startDate = startStr;
      currentFilters.endDate = endStr;
    } else if (quick === 'all' || !quick) {
      document.getElementById('cb-start').value = '';
      document.getElementById('cb-end').value = '';
      currentFilters.startDate = '';
      currentFilters.endDate = '';
    }
  }
  
  // Tab switching
  function switchTab(tabId) {
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.querySelectorAll('.tab-nav-button').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(`tab-${tabId}`).classList.add('active');
    document.querySelector(`.tab-nav-button[data-tab="${tabId}"]`).classList.add('active');
    
    // Load data for the active tab
    if (tabId === 'movements') {
      loadCashMovements();
    } else if (tabId === 'bank') {
      loadBankMovements();
    } else if (tabId === 'expected') {
      loadExpectedIncome();
    }
  }
  
  // Load summary data using new clean backend
  async function loadSummary() {
    try {
      console.log('Loading summary from clean backend...');
      
      // Get current balances from the new API
      const balances = await window.TransactionService.getBalances();
      
      const cashBalance = balances.cash || 0;
      const bankBalance = balances.bank || 0;
      
      console.log(`Clean backend balances: Cash = â‚¬${cashBalance.toFixed(2)}, Bank = â‚¬${bankBalance.toFixed(2)}`);
      
      // Calculate this month's received donations
      const thisMonth = new Date();
      const monthStart = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1).toISOString().split('T')[0];
      const monthEnd = new Date(thisMonth.getFullYear(), thisMonth.getMonth() + 1, 0).toISOString().split('T')[0];
      
      const monthTransactions = await window.TransactionService.getList({
        type: 'income',
        startDate: monthStart,
        endDate: monthEnd
      });
      
      const donationsThisMonth = monthTransactions.reduce((sum, txn) => sum + Math.abs(txn.amount), 0);
      const donationCount = monthTransactions.length;
      
      // Update the display
      document.getElementById('cb-cash').textContent = fmt(cashBalance);
      document.getElementById('cb-expected').textContent = fmt(0); // To be implemented with expected income feature
      document.getElementById('cb-received').textContent = fmt(donationsThisMonth);
      document.getElementById('cb-bank').textContent = fmt(bankBalance);
      
      document.getElementById('cb-expected-count').textContent = '0 pending';
      document.getElementById('cb-received-count').textContent = `${donationCount} donations`;
      document.getElementById('cb-cash-trend').textContent = 'Updated just now';
      
      // Store global balances
      window.currentCashBalance = cashBalance;
      window.currentBankBalance = bankBalance;
      
    } catch (error) {
      console.error('Failed to load summary:', error);
      document.getElementById('cb-cash').textContent = 'â‚¬-.--';
      document.getElementById('cb-expected').textContent = 'â‚¬-.--';
      document.getElementById('cb-received').textContent = 'â‚¬-.--';
      document.getElementById('cb-bank').textContent = 'â‚¬-.--';
      document.getElementById('cb-cash-trend').textContent = 'Error loading data';
    }
  }
  
  // Load cash movements using the new ledger API
  async function loadCashMovements(append = false) {
    try {
      // Get filters
      const params = {};
      if (currentFilters.startDate) params.startDate = currentFilters.startDate;
      if (currentFilters.endDate) params.endDate = currentFilters.endDate;
      params.limit = 1000; // Get more entries
      
      console.log('Loading cash movements with params:', params);
      
      // Load from the clean ledger API
      const ledgerEntries = await window.TransactionService.getLedger('cash', params);
      
      console.log('Cash ledger entries received:', ledgerEntries);
      
      if (ledgerEntries && ledgerEntries.length > 0) {
        displayCashMovements(ledgerEntries);
      } else {
        // No data
        console.log('No cash movements found in ledger');
        document.getElementById('cb-tbody').innerHTML = 
          '<tr><td colspan="6" class="text-center text-muted">No cash movements found</td></tr>';
      }
      
    } catch (error) {
      console.error('Error loading cash movements:', error);
      document.getElementById('cb-tbody').innerHTML = 
        '<tr><td colspan="6" class="text-center text-danger">Failed to load cash movements</td></tr>';
    }
  }
  
  // Display cash movements from ledger entries
  function displayCashMovements(ledgerEntries) {
    const tbody = document.getElementById('cb-tbody');
    
    if (!ledgerEntries || ledgerEntries.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No cash movements found</td></tr>';
      return;
    }
    
    // Cash movements show all cash account ledger entries (already filtered by account='cash' in the query)
    let filtered = ledgerEntries;
    
    if (currentFilters.type) {
      filtered = filtered.filter(entry => {
        if (currentFilters.type === 'cash-expense') return entry.type === 'expense';
        if (currentFilters.type === 'donation') return entry.type === 'income';
        if (currentFilters.type === 'withdrawal') return entry.subtype === 'withdrawal';
        if (currentFilters.type === 'deposit') return entry.subtype === 'deposit';
        return true;
      });
    }
    
    if (currentFilters.search) {
      const searchLower = currentFilters.search.toLowerCase();
      filtered = filtered.filter(entry => 
        entry.description?.toLowerCase().includes(searchLower)
      );
    }
    
    // Use filtered data directly - backend already handles sorting and limiting
    const displayItems = filtered;
    
    // Build table rows
    const rows = displayItems.map(entry => {
      const typeLabel = getTypeLabel(entry.type, entry.subtype, entry.paymentMethod);
      const typeClass = getTypeClass(entry.type, entry.subtype);
      const amountClass = entry.change_amount < 0 ? 'text-danger' : 'text-success';
      const isExpense = entry.type === 'expense';
      
      return `
        <tr>
          <td class="col-date">${formatDate(entry.date)}</td>
          <td class="col-type">
            <span class="badge badge-${typeClass}">${typeLabel}</span>
          </td>
          <td class="col-description">${esc(entry.description || '-')}</td>
          <td class="col-amount text-right ${amountClass}">
            ${fmt(Math.abs(entry.change_amount))}
          </td>
          <td class="col-balance text-right">
            <strong>${fmt(entry.display_balance || entry.balance_after)}</strong>
          </td>
          <td class="col-actions text-center">
            <div class="actions-cell">
              ${isExpense ? `
                <button class="action-btn view-receipt" onclick="viewReceipt('${entry.transaction_id}')" title="View receipt"></button>
              ` : `
                <div class="action-btn-placeholder"></div>
              `}
              <div class="action-dropdown">
                <button class="action-btn gear-btn" onclick="window.toggleActionMenu(this); return false;" title="More actions"></button>
                <div class="action-menu">
                  <button onclick="editMovement('${entry.transaction_id}')">Edit</button>
                  <button class="delete-action" onclick="deleteMovement('${entry.transaction_id}')">Delete</button>
                </div>
              </div>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows || '<tr><td colspan="6" class="text-center text-muted">No movements to display</td></tr>';
    
    // Update pagination info
    document.getElementById('cb-items-info').textContent = 
      `Showing ${displayItems.length} of ${filtered.length} items`;
    
    // Show/hide load more button
    const loadMoreWrap = document.getElementById('cb-loadmore-wrap');
    if (filtered.length > displayItems.length) {
      loadMoreWrap.style.display = 'block';
    } else {
      loadMoreWrap.style.display = 'none';
    }
    
    // Show opening balance if we have entries
    if (displayItems.length > 0) {
      const lastItem = displayItems[displayItems.length - 1];
      const openingBalance = lastItem.balance_before || 0;
      document.getElementById('cb-opening-balance').style.display = 'inline-block';
      document.getElementById('cb-opening-amount').textContent = fmt(openingBalance);
    }
  }
  
  // Load bank movements using the new ledger API
  async function loadBankMovements(append = false) {
    try {
      // Get filters from bank filter controls
      const params = {};
      const bankQuick = document.getElementById('bank-quick').value;
      
      if (bankQuick && bankQuick !== 'all') {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - parseInt(bankQuick));
        params.startDate = startDate.toISOString().split('T')[0];
        params.endDate = endDate.toISOString().split('T')[0];
      } else {
        const bankStart = document.getElementById('bank-start').value;
        const bankEnd = document.getElementById('bank-end').value;
        if (bankStart) params.startDate = bankStart;
        if (bankEnd) params.endDate = bankEnd;
      }
      
      params.limit = 1000;
      
      // Load from the clean ledger API
      const ledgerEntries = await window.TransactionService.getLedger('bank', params);
      
      if (ledgerEntries && ledgerEntries.length > 0) {
        displayBankMovements(ledgerEntries);
      } else {
        document.getElementById('bank-tbody').innerHTML = 
          '<tr><td colspan="6" class="text-center text-muted">No bank movements found</td></tr>';
      }
      
    } catch (error) {
      console.error('Error loading bank movements:', error);
      document.getElementById('bank-tbody').innerHTML = 
        '<tr><td colspan="6" class="text-center text-danger">Failed to load bank movements</td></tr>';
    }
  }
  
  // Display bank movements from ledger entries
  function displayBankMovements(ledgerEntries) {
    const tbody = document.getElementById('bank-tbody');
    
    if (!ledgerEntries || ledgerEntries.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No bank movements found</td></tr>';
      return;
    }
    
    // CRITICAL: Filter out cash expenses from bank movements
    // Bank movements should only show: Card payments, Bank transfers, Bank fees, Deposits/Withdrawals, Income
    let filtered = ledgerEntries.filter(entry => {
      // If it's an expense, only include if payment method is NOT Cash
      if (entry.type === 'expense') {
        return entry.paymentMethod !== 'Cash' && entry.paymentMethod !== null;
      }
      // Include all other types (income, transfers, etc.)
      return true;
    });
    const bankTypeFilter = document.getElementById('bank-type-filter').value;
    if (bankTypeFilter) {
      filtered = filtered.filter(entry => {
        if (bankTypeFilter === 'transfer') return entry.type === 'transfer';
        if (bankTypeFilter === 'payment') return entry.type === 'expense';
        if (bankTypeFilter === 'income') return entry.type === 'income';
        return true;
      });
    }
    
    // Apply search filter
    const bankSearch = document.getElementById('bank-search').value;
    if (bankSearch) {
      const searchLower = bankSearch.toLowerCase();
      filtered = filtered.filter(entry => 
        entry.description?.toLowerCase().includes(searchLower)
      );
    }
    
    // Use filtered data directly - backend already handles sorting and limiting
    const displayItems = filtered;
    
    // Build table rows
    const rows = displayItems.map(entry => {
      const typeLabel = getTypeLabel(entry.type, entry.subtype, entry.paymentMethod);
      const typeClass = getTypeClass(entry.type, entry.subtype);
      const amountClass = entry.change_amount < 0 ? 'text-danger' : 'text-success';
      const isExpense = entry.type === 'expense';
      
      return `
        <tr>
          <td class="col-date">${formatDate(entry.date)}</td>
          <td class="col-type">
            <span class="badge badge-${typeClass}">${typeLabel}</span>
          </td>
          <td class="col-description">${esc(entry.description || '-')}</td>
          <td class="col-amount text-right ${amountClass}">
            ${fmt(Math.abs(entry.change_amount))}
          </td>
          <td class="col-balance text-right">
            <strong>${fmt(entry.display_balance || entry.balance_after)}</strong>
          </td>
          <td class="col-actions text-center">
            <div class="actions-cell">
              ${isExpense ? `
                <button class="action-btn view-receipt" onclick="viewReceipt('${entry.transaction_id}')" title="View receipt"></button>
              ` : `
                <div class="action-btn-placeholder"></div>
              `}
              <div class="action-dropdown">
                <button class="action-btn gear-btn" onclick="window.toggleActionMenu(this); return false;" title="More actions"></button>
                <div class="action-menu">
                  <button onclick="editMovement('${entry.transaction_id}')">Edit</button>
                  <button class="delete-action" onclick="deleteMovement('${entry.transaction_id}')">Delete</button>
                </div>
              </div>
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    tbody.innerHTML = rows || '<tr><td colspan="6" class="text-center text-muted">No movements to display</td></tr>';
    
    // Update pagination info
    document.getElementById('bank-items-info').textContent = 
      `Showing ${displayItems.length} of ${filtered.length} items`;
    
    // Show/hide load more button
    const loadMoreWrap = document.getElementById('bank-loadmore-wrap');
    if (filtered.length > displayItems.length) {
      loadMoreWrap.style.display = 'block';
    } else {
      loadMoreWrap.style.display = 'none';
    }
    
    // Show opening balance if we have entries
    if (displayItems.length > 0) {
      const lastItem = displayItems[displayItems.length - 1];
      const openingBalance = lastItem.balance_before || 0;
      document.getElementById('bank-opening-balance').style.display = 'inline-block';
      document.getElementById('bank-opening-amount').textContent = fmt(openingBalance);
    }
  }
  
  // Helper functions for type display
  function getTypeLabel(type, subtype, paymentMethod) {
    if (type === 'expense') {
      // Display the actual payment method for expenses
      if (paymentMethod === 'Cash') return 'Cash Expense';
      if (paymentMethod === 'Card') return 'Card Expense';
      if (paymentMethod === 'Bank Transfer') return 'Bank Transfer';
      return 'Expense'; // Fallback if no payment method
    }
    if (type === 'income') return 'Donation';
    if (type === 'transfer') {
      if (subtype === 'withdrawal') return 'Withdrawal';
      if (subtype === 'deposit') return 'Deposit';
      return 'Transfer';
    }
    if (type === 'reversal') return 'Reversal';
    return type || 'Unknown';
  }
  
  function getTypeClass(type, subtype) {
    if (type === 'expense') return 'danger';
    if (type === 'income') return 'success';
    if (type === 'transfer') return 'info';
    if (type === 'reversal') return 'warning';
    return 'secondary';
  }
  
  // Load expected income (placeholder for now)
  function loadExpectedIncome() {
    // This feature can be implemented later
    console.log('Expected income feature to be implemented');
  }
  
  // Load categories for dropdowns
  async function loadCategories() {
    try {
      const response = await window.callApi('/categories');
      if (response.success) {
        categories = response.data;
        
        // Populate dropdown
        const categorySelect = document.getElementById('movement-category');
        const options = '<option value="">Select category...</option>' + 
          categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
        
        categorySelect.innerHTML = options;
      }
    } catch (error) {
      console.error('Failed to load categories:', error);
    }
  }
  
  // Modal functions
  function openMovementModal() {
    document.getElementById('movement-modal').style.display = 'flex';
    document.getElementById('movement-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('movement-amount').value = '';
    document.getElementById('movement-description').value = '';
    document.getElementById('movement-account').value = 'cash';
    // Set cash as default selected
    selectAccount('cash');
    // Don't pre-set to expense, let updateMovementForm set the first available option
    updateMovementForm(false);
  }
  
  function selectAccount(account) {
    // Update hidden input
    document.getElementById('movement-account').value = account;
    
    // Update button states
    document.querySelectorAll('.account-option').forEach(btn => {
      if (btn.dataset.account === account) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
    
    // Update form based on new account
    updateMovementForm(false);
  }
  
  function closeMovementModal() {
    const modal = document.getElementById('movement-modal');
    modal.style.display = 'none';
    delete modal.dataset.editId; // Clear any edit ID
  }
  
  function updateMovementForm(preserveType = true) {
    const account = document.getElementById('movement-account').value;
    const typeSelect = document.getElementById('movement-type');
    
    // Store current selected value before updating options
    const currentType = typeSelect.value;
    
    // Update type options based on account
    if (account === 'cash') {
      typeSelect.innerHTML = `
        <option value="income">Cash Donation</option>
        <option value="withdrawal">ATM Withdrawal (from Bank)</option>
        <option value="deposit">Cash Deposit (to Bank)</option>
      `;
    } else {
      typeSelect.innerHTML = `
        <option value="income">Bank Donation</option>
        <option value="withdrawal">Cash Withdrawal (to Cash)</option>
        <option value="deposit">Cash Deposit (from Cash)</option>
      `;
    }
    
    // Restore the selected value if it exists in the new options and preserveType is true
    if (preserveType) {
      const newOptions = Array.from(typeSelect.options).map(opt => opt.value);
      if (newOptions.includes(currentType)) {
        typeSelect.value = currentType;
      }
    }
  }
  
  // Save movement
  async function saveMovement() {
    try {
      const modal = document.getElementById('movement-modal');
      const editId = modal.dataset.editId;
      const account = document.getElementById('movement-account').value;
      const type = document.getElementById('movement-type').value;
      const date = document.getElementById('movement-date').value;
      const amount = parseFloat(document.getElementById('movement-amount').value);
      const description = document.getElementById('movement-description').value;
      
      if (!date || !amount || !description) {
        alert('Please fill in all required fields');
        return;
      }
      
      let transactionType, transactionData;
      
      if (type === 'expense') {
        transactionType = 'expense';
        transactionData = {
          date,
          amount,
          description,
          category,
          paymentMethod: account === 'cash' ? 'Cash' : document.getElementById('movement-payment').value
        };
      } else if (type === 'income') {
        transactionType = 'income';
        transactionData = {
          date,
          amount,
          description,
          account: account
        };
      } else if (type === 'withdrawal') {
        transactionType = 'transfer';
        transactionData = {
          date,
          amount,
          description,
          subtype: 'withdrawal'
        };
      } else if (type === 'deposit') {
        transactionType = 'transfer';
        transactionData = {
          date,
          amount,
          description,
          subtype: 'deposit'
        };
      }
      
      if (editId) {
        // Update existing transaction
        await window.TransactionService.update(editId, transactionType, transactionData);
        delete modal.dataset.editId; // Clear edit ID
        console.log('Transaction updated successfully');
      } else {
        // Create new transaction
        await window.TransactionService.create(transactionType, transactionData);
        console.log('Transaction created successfully');
      }
      
      closeMovementModal();
      
      // Reload all data to reflect changes
      await loadSummary();
      
      // Reload the appropriate tab based on what's currently active
      const currentTab = document.querySelector('.tab-nav-button.active').dataset.tab;
      if (currentTab === 'movements') {
        await loadCashMovements();
      } else if (currentTab === 'bank') {
        await loadBankMovements();
      } else if (currentTab === 'expected') {
        await loadExpectedIncome();
      }
      
    } catch (error) {
      console.error('Failed to save transaction:', error);
      alert('Failed to save transaction: ' + error.message);
    }
  }
  
  // Action menu functions
  window.toggleActionMenu = function(button) {
    // Close any other open menus
    document.querySelectorAll('.action-menu.show').forEach(menu => {
      if (menu !== button.nextElementSibling) {
        menu.classList.remove('show');
        menu.closest('.action-dropdown').classList.remove('active');
      }
    });
    
    // Toggle this menu
    const menu = button.nextElementSibling;
    const dropdown = button.closest('.action-dropdown');
    menu.classList.toggle('show');
    dropdown.classList.toggle('active');
    
    // Close menu when clicking outside
    if (menu.classList.contains('show')) {
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!dropdown.contains(e.target)) {
            menu.classList.remove('show');
            dropdown.classList.remove('active');
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 0);
    }
  };
  
  function viewReceipt(transactionId) {
    console.log('View receipt for:', transactionId);
    // To be implemented: open receipt viewer
    alert('Receipt viewing will be implemented with Firebase Storage integration.');
  }
  
  async function editMovement(transactionId) {
    // Close any open menus
    document.querySelectorAll('.action-menu.show').forEach(menu => {
      menu.classList.remove('show');
      menu.closest('.action-dropdown').classList.remove('active');
    });
    
    try {
      // Fetch the transaction details
      const transaction = await window.TransactionService.getById(transactionId);
      if (!transaction) {
        alert('Transaction not found');
        return;
      }
      
      // If it's an expense, open the expense modal instead
      if (transaction.type === 'expense') {
        // Check if the expense modal function exists
        if (window.openExpenseModal) {
          window.openExpenseModal(transactionId);
        } else {
          console.error('openExpenseModal not found');
          alert('Expense editing is not available. Please go to the Expenses page to edit this transaction.');
        }
        return;
      }
      
      // For non-expense transactions, open the movement modal
      document.getElementById('movement-modal').style.display = 'flex';
      document.getElementById('movement-modal').dataset.editId = transactionId;
      
      // Set the date
      document.getElementById('movement-date').value = transaction.date;
      
      // Set the amount (always positive for display)
      document.getElementById('movement-amount').value = Math.abs(transaction.amount);
      
      // Set the description
      document.getElementById('movement-description').value = transaction.description || '';
      
      // Determine account and type based on transaction data
      if (transaction.type === 'income') {
        // It's income/donation
        const accountValue = transaction.account || 'cash';
        document.getElementById('movement-account').value = accountValue;
        selectAccount(accountValue);
        document.getElementById('movement-type').value = 'income';
      } else if (transaction.type === 'transfer') {
        // It's a transfer (withdrawal or deposit)
        if (transaction.subtype === 'withdrawal') {
          document.getElementById('movement-account').value = 'bank';
          selectAccount('bank');
          document.getElementById('movement-type').value = 'withdrawal';
        } else if (transaction.subtype === 'deposit') {
          document.getElementById('movement-account').value = 'cash';
          selectAccount('cash');
          document.getElementById('movement-type').value = 'deposit';
        }
      }
      
      // Update the form based on selected values
      updateMovementForm(true);
      
    } catch (error) {
      console.error('Error loading transaction for edit:', error);
      alert('Failed to load transaction details');
    }
  }
  
  async function deleteMovement(transactionId) {
    // Close any open menus
    document.querySelectorAll('.action-menu.show').forEach(menu => {
      menu.classList.remove('show');
      menu.closest('.action-dropdown').classList.remove('active');
    });
    
    if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
      try {
        await window.TransactionService.delete(transactionId);
        
        // Reload the data
        await loadSummary();
        const currentTab = document.querySelector('.tab-nav-button.active').dataset.tab;
        if (currentTab === 'movements') {
          await loadCashMovements();
        } else if (currentTab === 'bank') {
          await loadBankMovements();
        }
        
        console.log('Transaction deleted successfully');
      } catch (error) {
        console.error('Failed to delete transaction:', error);
        alert('Failed to delete transaction: ' + error.message);
      }
    }
  }
  
  // Placeholder functions for actions
  function exportMovements() {
    console.log('Export cash movements');
    // To be implemented
  }
  
  function exportBankMovements() {
    console.log('Export bank movements');
    // To be implemented
  }
  
  function exportExpectedIncome() {
    console.log('Export expected income');
    // To be implemented
  }
  
  function openExpectedIncomeModal() {
    console.log('Open expected income modal');
    // To be implemented
  }
  
  // Initialize page function for SPA
  window.initializeCashBankingPage = async function() {
    console.log('Cash & Banking page initialized with clean backend');
    
    // Check if TransactionService is available
    if (!window.TransactionService) {
      console.error('Cash-Banking: TransactionService not loaded');
      document.getElementById('cb-tbody').innerHTML = 
        '<tr><td colspan="6" class="text-center text-danger">Service not available. Please refresh the page.</td></tr>';
      return;
    }
    
    // Load initial data
    await loadCategories();
    await loadSummary();
    await loadCashMovements();
    
    // Setup event listeners
    document.querySelectorAll('.tab-nav-button').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const tab = e.currentTarget.dataset.tab;
        switchTab(tab);
      });
    });
    
    // Cash filters
    const cbQuick = document.getElementById('cb-quick');
    if (cbQuick) {
      cbQuick.addEventListener('change', () => {
        updateDateFilters();
        loadCashMovements();
      });
    }
    
    const cbStart = document.getElementById('cb-start');
    if (cbStart) {
      cbStart.addEventListener('change', () => {
        currentFilters.startDate = cbStart.value;
        loadCashMovements();
      });
    }
    
    const cbEnd = document.getElementById('cb-end');
    if (cbEnd) {
      cbEnd.addEventListener('change', () => {
        currentFilters.endDate = cbEnd.value;
        loadCashMovements();
      });
    }
    
    const cbTypeFilter = document.getElementById('cb-type-filter');
    if (cbTypeFilter) {
      cbTypeFilter.addEventListener('change', () => {
        currentFilters.type = cbTypeFilter.value;
        loadCashMovements();
      });
    }
    
    const cbSearch = document.getElementById('cb-search');
    if (cbSearch) {
      cbSearch.addEventListener('input', () => {
        currentFilters.search = cbSearch.value;
        loadCashMovements();
      });
    }
    
    // Bank filters
    const bankQuick = document.getElementById('bank-quick');
    if (bankQuick) {
      bankQuick.addEventListener('change', () => {
        loadBankMovements();
      });
    }
    
    const bankStart = document.getElementById('bank-start');
    if (bankStart) {
      bankStart.addEventListener('change', () => {
        loadBankMovements();
      });
    }
    
    const bankEnd = document.getElementById('bank-end');
    if (bankEnd) {
      bankEnd.addEventListener('change', () => {
        loadBankMovements();
      });
    }
    
    const bankTypeFilter = document.getElementById('bank-type-filter');
    if (bankTypeFilter) {
      bankTypeFilter.addEventListener('change', () => {
        loadBankMovements();
      });
    }
    
    const bankSearch = document.getElementById('bank-search');
    if (bankSearch) {
      bankSearch.addEventListener('input', () => {
        loadBankMovements();
      });
    }
    
    // Load more buttons
    const cbMore = document.getElementById('cb-more');
    if (cbMore) {
      cbMore.addEventListener('click', () => {
        cashCurrentPage++;
        loadCashMovements(true);
      });
    }
    
    const bankMore = document.getElementById('bank-more');
    if (bankMore) {
      bankMore.addEventListener('click', () => {
        bankCurrentPage++;
        loadBankMovements(true);
      });
    }
    
    // Record movement button
    const recordMovementBtn = document.getElementById('record-movement');
    if (recordMovementBtn) {
      recordMovementBtn.addEventListener('click', openMovementModal);
    }
    
    // Initialize with 30 days of data
    updateDateFilters();
  };
  
  // Register the page initializer
  window.registerPageInitializer('cash-banking', window.initializeCashBankingPage);
  
  // Expose functions needed by inline event handlers
  window.closeMovementModal = closeMovementModal;
  window.updateMovementForm = updateMovementForm;
  window.saveMovement = saveMovement;
  window.viewReceipt = viewReceipt;
  window.editMovement = editMovement;
  window.deleteMovement = deleteMovement;
  window.exportExpectedIncome = exportExpectedIncome;
  window.selectAccount = selectAccount;
})(); // End IIFE
</script>

<style>
.modal {
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: #fff;
  border-radius: 8px;
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6b7280;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-modal:hover {
  color: #111827;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  padding: 20px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 4px;
  font-size: 14px;
  font-weight: 500;
  color: #374151;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
}

.badge-success { background: #d1fae5; color: #065f46; }
.badge-danger { background: #fee2e2; color: #991b1b; }
.badge-info { background: #dbeafe; color: #1e40af; }
.badge-warning { background: #fed7aa; color: #92400e; }
.badge-secondary { background: #f3f4f6; color: #4b5563; }

/* Action buttons styling - matching expenses page */
.actions-cell {
  display: flex;
  gap: 4px;
  justify-content: center;
  align-items: center;
}

.action-btn-placeholder {
  width: 32px;
  height: 32px;
  display: inline-block;
}

.action-btn {
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: #6b7280;
  transition: all 0.15s ease;
}

.action-btn:hover {
  background: #f3f4f6;
  color: #374151;
}

/* Professional SVG icons */
.action-btn.view-receipt::before {
  content: '';
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
  pointer-events: none;
}

.action-btn.gear-btn::before {
  content: '';
  width: 16px;
  height: 16px;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: center;
  pointer-events: none;
}

.action-btn.view-receipt:hover::before {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'/%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3C/svg%3E");
}

.action-btn.gear-btn:hover::before {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23374151' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='3'/%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'/%3E%3C/svg%3E");
}

/* Dropdown menu for gear wheel */
.action-dropdown {
  position: relative;
  display: inline-block;
  z-index: 1000;
}

.action-dropdown.active {
  z-index: 10000;
}

.action-menu {
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  min-width: 120px;
  z-index: 10001;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-4px);
  transition: all 0.15s ease;
  pointer-events: none;
  display: flex;
  flex-direction: column;
}

.action-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
  pointer-events: auto;
}

.action-menu button {
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  font-size: 14px;
  color: #374151;
  transition: background 0.15s ease;
  display: block;
  white-space: nowrap;
}

.action-menu button:hover {
  background: #f3f4f6;
}

.action-menu button:first-child {
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
}

.action-menu button:last-child {
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}

.action-menu button.delete-action {
  color: #374151;
}

.action-menu button.delete-action:hover {
  background: #fef2f2;
  color: #dc2626;
}

/* Filter styles - clean white background */
.filters {
  background: #fff;
  padding: 16px;
  margin: 0;
  width: 100%;
  box-sizing: border-box;
}

.filters-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: flex-end;
}

.filter-item {
  display: flex;
  flex-direction: column;
}

.filter-item .form-label {
  margin-bottom: 4px;
}

.filter-item .form-control {
  width: 100%;
}

/* Movement Modal Styles */
.modal-movement {
  max-width: 500px;
}

.movement-description {
  background: #f8fafc;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  font-size: 14px;
  color: #64748b;
  line-height: 1.5;
}

.account-selector {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}

.account-option {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 16px;
  background: #ffffff;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 14px;
  font-weight: 500;
  color: #64748b;
}

.account-option:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.account-option.active {
  background: #f0f4ff;
  border-color: var(--color-primary);
  color: var(--color-primary);
}

.account-option.active .account-icon {
  color: var(--color-primary);
}

.account-icon {
  width: 20px;
  height: 20px;
  color: #64748b;
}

.form-row {
  display: flex;
  gap: 12px;
}

.modal-movement .form-control {
  width: 100%;
  box-sizing: border-box;
}

.modal-movement .modal-body {
  max-width: 100%;
  overflow-x: hidden;
}

/* Top bar styles */
.top-bar {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 42px; /* Slightly taller than bottom bar for future buttons */
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  padding: 0 16px;
  z-index: 10;
}

.top-bar-content {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.top-bar-left {
  flex: 0 0 auto;
}

.top-bar-center {
  flex: 1 1 auto;
  display: flex;
  justify-content: center;
}

.top-bar-right {
  flex: 0 0 auto;
}

/* Bottom bar styles */
.bottom-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 36px; /* Reduced height from 42px */
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  padding: 0 16px;
}

.bottom-bar-content {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.bottom-bar-left {
  flex: 0 0 auto;
}

.bottom-bar-center {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
}

.bottom-bar-right {
  flex: 0 0 auto;
  margin-left: auto;
}

/* Adjust table container padding for new bottom bar height */
.card-body > div[style*="padding-bottom: 42px"] {
  padding-bottom: 36px !important;
}
</style>