<div class="content-area" id="settings-page">
  <!-- Page Header with Dynamic Actions -->
  <div class="page-header">
    <h2 class="page-title">Admin Console</h2>
    <div class="page-actions" id="settings-actions">
      <!-- Dynamic buttons will be inserted here based on active tab -->
    </div>
  </div>
  
  <!-- Admin Statistics Cards -->
  <div class="admin-stats-row">
    <div class="admin-stat-card">
      <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      <div class="stat-value" id="stat-users">12</div>
      <div class="stat-label">Total Users</div>
      <div class="stat-change">+2 this month</div>
    </div>
    
    <div class="admin-stat-card">
      <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"></path>
      </svg>
      <div class="stat-value" id="stat-roles">4</div>
      <div class="stat-label">Active Roles</div>
      <div class="stat-change">Admin, Manager, User, Viewer</div>
    </div>
    
    <div class="admin-stat-card">
      <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
      </svg>
      <div class="stat-value" id="stat-activity">47</div>
      <div class="stat-label">Recent Activity</div>
      <div class="stat-change">Actions today</div>
    </div>
    
    <div class="admin-stat-card">
      <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      <div class="stat-value" id="stat-health">100%</div>
      <div class="stat-label">System Health</div>
      <div class="stat-change">All systems operational</div>
    </div>
  </div>

  <!-- Tab Navigation (Cash-Banking Style) -->
  <div class="tab-nav-container">
    <div class="tab-nav">
      <button class="tab-nav-button active" data-tab="user-directory">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        User Directory
      </button>
      
      <button class="tab-nav-button" data-tab="roles">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6"></path>
        </svg>
        Roles & Permissions
      </button>
      
      <button class="tab-nav-button" data-tab="activity">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Activity Log
      </button>
      
      <button class="tab-nav-button" data-tab="budget">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="1" x2="12" y2="23"></line>
          <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
        </svg>
        Budget Settings
      </button>
      
      <button class="tab-nav-button" data-tab="system">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24"></path>
        </svg>
        System Settings
      </button>
    </div>
  </div>
  
  <!-- Tab Panel: User Directory -->
  <div class="tab-panel active" id="tab-user-directory">
    <div class="card">
      <div class="card-body">
        <!-- Search and Filter Bar -->
        <div class="filter-bar mb-3">
          <div class="filter-row">
            <input type="text" id="user-search" class="form-control" placeholder="Search users by name or email..." style="flex: 2;">
            <select id="user-role-filter" class="form-control" style="flex: 1;">
              <option value="">All Roles</option>
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
              <option value="user">User</option>
              <option value="viewer">Viewer</option>
            </select>
            <select id="user-status-filter" class="form-control" style="flex: 1;">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>
        
        <!-- User Table -->
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Department</th>
              <th>Status</th>
              <th>Last Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="users-table">
            <!-- Sample data for now -->
            <tr>
              <td>
                <div class="user-info">
                  <div class="user-avatar">JD</div>
                  <span>John Doe</span>
                </div>
              </td>
              <td>john.doe@example.com</td>
              <td><span class="role-badge role-admin">Admin</span></td>
              <td>Operations</td>
              <td><span class="status-badge status-active">Active</span></td>
              <td>2 hours ago</td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="editUser('user1')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('user1')">Remove</button>
              </td>
            </tr>
            <tr>
              <td>
                <div class="user-info">
                  <div class="user-avatar">JS</div>
                  <span>Jane Smith</span>
                </div>
              </td>
              <td>jane.smith@example.com</td>
              <td><span class="role-badge role-manager">Manager</span></td>
              <td>Finance</td>
              <td><span class="status-badge status-active">Active</span></td>
              <td>1 day ago</td>
              <td>
                <button class="btn btn-sm btn-secondary" onclick="editUser('user2')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser('user2')">Remove</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Tab Panel: Roles & Permissions -->
  <div class="tab-panel" id="tab-roles">
    <div class="card">
      <div class="card-body">
        <div class="section-header mb-3">
          <h3>Permission Matrix</h3>
          <p class="text-muted">Configure what each role can access and modify in the system</p>
        </div>
        
        <table class="permissions-matrix">
          <thead>
            <tr>
              <th style="width: 300px;">Permission</th>
              <th class="text-center">Admin</th>
              <th class="text-center">Manager</th>
              <th class="text-center">User</th>
              <th class="text-center">Viewer</th>
            </tr>
          </thead>
          <tbody>
            <tr class="permission-category">
              <td colspan="5"><strong>Expense Management</strong></td>
            </tr>
            <tr>
              <td>View Expenses</td>
              <td class="text-center"><input type="checkbox" id="perm-view-expenses-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-view-expenses-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-view-expenses-user" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-view-expenses-viewer" checked></td>
            </tr>
            <tr>
              <td>Create Expenses</td>
              <td class="text-center"><input type="checkbox" id="perm-create-expenses-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-create-expenses-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-create-expenses-user" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-create-expenses-viewer"></td>
            </tr>
            <tr>
              <td>Edit All Expenses</td>
              <td class="text-center"><input type="checkbox" id="perm-edit-all-expenses-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-edit-all-expenses-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-edit-all-expenses-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-edit-all-expenses-viewer"></td>
            </tr>
            <tr>
              <td>Delete Expenses</td>
              <td class="text-center"><input type="checkbox" id="perm-delete-expenses-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-delete-expenses-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-delete-expenses-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-delete-expenses-viewer"></td>
            </tr>
            
            <tr class="permission-category">
              <td colspan="5"><strong>Budget Management</strong></td>
            </tr>
            <tr>
              <td>View Budget</td>
              <td class="text-center"><input type="checkbox" id="perm-view-budget-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-view-budget-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-view-budget-user" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-view-budget-viewer" checked></td>
            </tr>
            <tr>
              <td>Modify Budget</td>
              <td class="text-center"><input type="checkbox" id="perm-modify-budget-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-modify-budget-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-modify-budget-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-modify-budget-viewer"></td>
            </tr>
            
            <tr class="permission-category">
              <td colspan="5"><strong>User Management</strong></td>
            </tr>
            <tr>
              <td>View Users</td>
              <td class="text-center"><input type="checkbox" id="perm-view-users-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-view-users-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-view-users-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-view-users-viewer"></td>
            </tr>
            <tr>
              <td>Manage Users</td>
              <td class="text-center"><input type="checkbox" id="perm-manage-users-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-manage-users-manager"></td>
              <td class="text-center"><input type="checkbox" id="perm-manage-users-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-manage-users-viewer"></td>
            </tr>
            
            <tr class="permission-category">
              <td colspan="5"><strong>System Settings</strong></td>
            </tr>
            <tr>
              <td>Access Settings</td>
              <td class="text-center"><input type="checkbox" id="perm-access-settings-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-access-settings-manager" checked></td>
              <td class="text-center"><input type="checkbox" id="perm-access-settings-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-access-settings-viewer"></td>
            </tr>
            <tr>
              <td>Modify Settings</td>
              <td class="text-center"><input type="checkbox" id="perm-modify-settings-admin" checked disabled></td>
              <td class="text-center"><input type="checkbox" id="perm-modify-settings-manager"></td>
              <td class="text-center"><input type="checkbox" id="perm-modify-settings-user"></td>
              <td class="text-center"><input type="checkbox" id="perm-modify-settings-viewer"></td>
            </tr>
          </tbody>
        </table>
        
        <div class="mt-3">
          <button class="btn btn-secondary" id="save-permissions-btn" onclick="savePermissions()">Save Permission Changes</button>
          <button class="btn btn-secondary" onclick="resetPermissions()">Reset to Defaults</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Panel: Activity Log -->
  <div class="tab-panel" id="tab-activity">
    <div class="card">
      <div class="card-body">
        <!-- Activity Filters -->
        <div class="filter-bar mb-3">
          <div class="filter-row">
            <input type="date" id="activity-start" class="form-control" style="flex: 1;">
            <input type="date" id="activity-end" class="form-control" style="flex: 1;">
            <select id="activity-type" class="form-control" style="flex: 1;">
              <option value="">All Activities</option>
              <option value="user">User Management</option>
              <option value="expense">Expense Changes</option>
              <option value="budget">Budget Updates</option>
              <option value="system">System Changes</option>
              <option value="login">Login/Logout</option>
            </select>
            <select id="activity-user" class="form-control" style="flex: 1;">
              <option value="">All Users</option>
              <!-- Dynamic user list -->
            </select>
            <button class="btn btn-secondary" onclick="filterActivities()">Filter</button>
          </div>
        </div>
        
        <!-- Activity Timeline -->
        <div class="activity-timeline">
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <div class="timeline-header">
                <strong>John Doe</strong> modified expense #1234
                <span class="timeline-time">2 hours ago</span>
              </div>
              <div class="timeline-body">
                Changed amount from €500.00 to €550.00 and updated category to "Office Supplies"
              </div>
            </div>
          </div>
          
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <div class="timeline-header">
                <strong>Jane Smith</strong> created new user account
                <span class="timeline-time">5 hours ago</span>
              </div>
              <div class="timeline-body">
                Added user "Bob Johnson" with Manager role
              </div>
            </div>
          </div>
          
          <div class="timeline-item">
            <div class="timeline-marker"></div>
            <div class="timeline-content">
              <div class="timeline-header">
                <strong>System</strong> automatic backup completed
                <span class="timeline-time">1 day ago</span>
              </div>
              <div class="timeline-body">
                Daily backup completed successfully. 1,234 records backed up.
              </div>
            </div>
          </div>
        </div>
        
        <!-- Load More -->
        <div class="text-center mt-3">
          <button class="btn btn-secondary" id="load-more-activities" onclick="loadMoreActivities()">Load More Activities</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Panel: Budget Settings -->
  <div class="tab-panel" id="tab-budget">
    <!-- Planning Period Configuration -->
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="card-title">Budget Planning Period</h3>
      </div>
      <div class="card-body">
        <div class="grid grid-3">
          <div class="form-group">
            <label class="form-label">Planning Period</label>
            <select id="budget-period" class="form-control">
              <option value="3">Quarterly (3 months)</option>
              <option value="6">Bi-annually (6 months)</option>
              <option value="12" selected>Annually (12 months)</option>
              <option value="custom">Custom Period</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" id="start-month-label">Fiscal Year Start</label>
            <select id="budget-start-month" class="form-control">
              <option value="1" selected>January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          
          <div class="form-group" id="custom-period-group" style="display: none;">
            <label class="form-label">Custom Period (months)</label>
            <input type="number" id="budget-custom-months" class="form-control" min="1" max="60" value="12">
          </div>
        </div>
        
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="budget-recurring" checked>
            <span>Automatically renew budget after period ends</span>
          </label>
        </div>
        
        <!-- Settings Summary -->
        <div class="settings-summary">
          <strong>Current Configuration:</strong>
          <span id="budget-config-summary">12 months starting from January, with automatic renewal</span>
        </div>
      </div>
    </div>
    
    <!-- Monthly Budget Allocation -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Monthly Budget Allocation</h3>
      </div>
      <div class="card-body">
        <!-- Month Tabs -->
        <div class="budget-month-tabs" id="month-tabs">
          <!-- Dynamically generated month tabs -->
        </div>
        
        <!-- Month Actions Bar -->
        <div class="budget-actions-bar">
          <div class="budget-actions-group">
            <button class="btn btn-sm btn-secondary" id="expand-toggle-btn" onclick="toggleAllCategories()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
              <span id="expand-toggle-text">Expand All</span>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="copyFromPreviousMonth()" title="Copy allocations from previous month">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 9H11a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-9a2 2 0 0 0-2-2Z"></path>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy from Previous
            </button>
            <button class="btn btn-sm btn-secondary" onclick="copyToRemainingMonths()" title="Copy current month to all remaining months">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy to Remaining
            </button>
          </div>
        </div>
        
        <!-- Budget Categories Container -->
        <div class="budget-categories-container" id="budget-categories">
          <!-- Category cards will be loaded here -->
        </div>
        
        <!-- Add Category Card -->
        <div class="budget-category-add-card" onclick="openAddCategoryModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          <span>Add Budget Category</span>
        </div>
        
        <!-- Total Budget Summary -->
        <div class="budget-total-section">
          <div class="budget-total-card">
            <div class="budget-total-info">
              <div class="budget-total-label">Total Monthly Budget</div>
              <div class="budget-total-breakdown">
                <span id="category-count">0</span> categories • 
                <span id="subcategory-count">0</span> subcategories
              </div>
            </div>
            <div class="budget-total-amount">
              <span class="currency-symbol">€</span>
              <span id="budget-total-value">0</span>
            </div>
          </div>
        </div>
        
        <!-- Save Actions -->
        <div class="save-actions mt-3" style="display: flex; justify-content: flex-end; gap: 12px;">
          <button class="btn btn-outline" onclick="exportBudgetSettings()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export
          </button>
          <button class="btn btn-secondary" onclick="resetBudgetChanges()">Reset Changes</button>
          <button class="btn btn-primary" onclick="saveBudgetAllocations()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save Budget
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tab Panel: System Settings -->
  <div class="tab-panel" id="tab-system">
    <!-- Application Configuration -->
    <div class="card mb-3">
      <div class="card-header">
        <h3>Application Configuration</h3>
      </div>
      <div class="card-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">Application Name</label>
            <input type="text" id="app-name" class="form-control" placeholder="Budget Management System">
          </div>
          
          <div class="form-group">
            <label class="form-label">Organization Name</label>
            <input type="text" id="org-name" class="form-control" placeholder="Your Organization">
          </div>
          
          <div class="form-group">
            <label class="form-label">Time Zone</label>
            <select id="timezone" class="form-control">
              <option value="UTC">UTC</option>
              <option value="Europe/London">Europe/London</option>
              <option value="Europe/Berlin">Europe/Berlin</option>
              <option value="Europe/Athens">Europe/Athens</option>
              <option value="America/New_York">America/New_York</option>
              <option value="America/Chicago">America/Chicago</option>
              <option value="America/Los_Angeles">America/Los_Angeles</option>
              <option value="Asia/Tokyo">Asia/Tokyo</option>
              <option value="Asia/Shanghai">Asia/Shanghai</option>
              <option value="Australia/Sydney">Australia/Sydney</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Date Format</label>
            <select id="date-format" class="form-control">
              <option value="DD/MM/YYYY">DD/MM/YYYY</option>
              <option value="MM/DD/YYYY">MM/DD/YYYY</option>
              <option value="YYYY-MM-DD">YYYY-MM-DD</option>
              <option value="DD.MM.YYYY">DD.MM.YYYY</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Currency</label>
            <select id="currency" class="form-control">
              <option value="EUR">EUR (€)</option>
              <option value="USD">USD ($)</option>
              <option value="GBP">GBP (£)</option>
              <option value="CHF">CHF (Fr.)</option>
              <option value="JPY">JPY (¥)</option>
              <option value="CAD">CAD ($)</option>
              <option value="AUD">AUD ($)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Fiscal Year Start</label>
            <select id="fiscal-year-start" class="form-control">
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Language</label>
            <select id="language" class="form-control">
              <option value="en">English</option>
              <option value="de">German</option>
              <option value="fr">French</option>
              <option value="es">Spanish</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="el">Greek</option>
              <option value="nl">Dutch</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Session Timeout (minutes)</label>
            <input type="number" id="session-timeout" class="form-control" min="5" max="1440" value="30">
          </div>
        </div>
        
        <div class="mt-3">
          <label class="checkbox-label">
            <input type="checkbox" id="auto-backup">
            <span>Enable automatic backups</span>
          </label>
          
          <label class="checkbox-label">
            <input type="checkbox" id="maintenance-mode">
            <span>Maintenance mode (disable user access)</span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- Email Configuration -->
    <div class="card mb-3">
      <div class="card-header">
        <h3>Email Configuration</h3>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="checkbox-label mb-3">
            <input type="checkbox" id="email-enabled" onchange="toggleEmailSettings()">
            <span>Enable email notifications</span>
          </label>
        </div>
        
        <div id="email-settings-group" style="display: none;">
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">SMTP Host</label>
              <input type="text" id="smtp-host" class="form-control" placeholder="smtp.gmail.com">
            </div>
            
            <div class="form-group">
              <label class="form-label">SMTP Port</label>
              <input type="number" id="smtp-port" class="form-control" value="587">
            </div>
            
            <div class="form-group">
              <label class="form-label">SMTP Username</label>
              <input type="text" id="smtp-username" class="form-control">
            </div>
            
            <div class="form-group">
              <label class="form-label">SMTP Password</label>
              <input type="password" id="smtp-password" class="form-control">
            </div>
            
            <div class="form-group">
              <label class="form-label">From Email</label>
              <input type="email" id="from-email" class="form-control">
            </div>
            
            <div class="form-group">
              <label class="form-label">From Name</label>
              <input type="text" id="from-name" class="form-control">
            </div>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="smtp-secure">
              <span>Use secure connection (TLS/SSL)</span>
            </label>
          </div>
          
          <h4 class="mt-3 mb-2">Email Notifications</h4>
          <div class="notification-settings">
            <label class="checkbox-label">
              <input type="checkbox" id="notify-new-expense">
              <span>New expense notifications</span>
            </label>
            
            <label class="checkbox-label">
              <input type="checkbox" id="notify-budget-exceeded">
              <span>Budget exceeded alerts</span>
            </label>
            
            <label class="checkbox-label">
              <input type="checkbox" id="notify-weekly-report">
              <span>Weekly summary reports</span>
            </label>
            
            <label class="checkbox-label">
              <input type="checkbox" id="notify-monthly-report">
              <span>Monthly summary reports</span>
            </label>
          </div>
          
          <div class="mt-3">
            <button class="btn btn-secondary" onclick="testEmailSettings()">Send Test Email</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Integrations -->
    <div class="card mb-3">
      <div class="card-header">
        <h3>Integrations</h3>
      </div>
      <div class="card-body">
        <div class="integration-item mb-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h4>Google Sheets</h4>
            <label class="switch">
              <input type="checkbox" id="google-sheets-enabled" onchange="toggleIntegration('google-sheets')">
              <span class="slider"></span>
            </label>
          </div>
          <div id="google-sheets-settings" style="display: none;">
            <div class="grid grid-2">
              <div class="form-group">
                <label class="form-label">API Key</label>
                <input type="password" id="google-sheets-api-key" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">Sheet ID</label>
                <input type="text" id="google-sheets-id" class="form-control">
              </div>
            </div>
          </div>
        </div>
        
        <div class="integration-item mb-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h4>Slack</h4>
            <label class="switch">
              <input type="checkbox" id="slack-enabled" onchange="toggleIntegration('slack')">
              <span class="slider"></span>
            </label>
          </div>
          <div id="slack-settings" style="display: none;">
            <div class="form-group">
              <label class="form-label">Webhook URL</label>
              <input type="text" id="slack-webhook-url" class="form-control" placeholder="https://hooks.slack.com/services/...">
            </div>
          </div>
        </div>
        
        <div class="integration-item mb-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h4>QuickBooks</h4>
            <label class="switch">
              <input type="checkbox" id="quickbooks-enabled" onchange="toggleIntegration('quickbooks')">
              <span class="slider"></span>
            </label>
          </div>
          <div id="quickbooks-settings" style="display: none;">
            <div class="grid grid-2">
              <div class="form-group">
                <label class="form-label">Client ID</label>
                <input type="text" id="quickbooks-client-id" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">Client Secret</label>
                <input type="password" id="quickbooks-client-secret" class="form-control">
              </div>
            </div>
            <button class="btn btn-secondary" onclick="connectQuickBooks()">Connect QuickBooks</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Data Management -->
    <div class="card mb-3">
      <div class="card-header">
        <h3>Data Management</h3>
      </div>
      <div class="card-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">Backup Frequency</label>
            <select id="backup-frequency" class="form-control">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="never">Never</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Data Retention</label>
            <select id="data-retention" class="form-control">
              <option value="1">1 Year</option>
              <option value="2">2 Years</option>
              <option value="3">3 Years</option>
              <option value="5">5 Years</option>
              <option value="unlimited">Unlimited</option>
            </select>
          </div>
        </div>
        
        <div class="action-buttons mt-3">
          <button class="btn btn-secondary" onclick="exportAllData()">
            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export All Data
          </button>
          <button class="btn btn-secondary" onclick="importData()">
            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Import Data
          </button>
          <button class="btn btn-warning" onclick="createManualBackup()">Create Backup Now</button>
        </div>
      </div>
    </div>
    
    <!-- Security Settings -->
    <div class="card mb-3">
      <div class="card-header">
        <h3>Security Settings</h3>
      </div>
      <div class="card-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">Max Login Attempts</label>
            <input type="number" id="max-login-attempts" class="form-control" min="3" max="10" value="5">
          </div>
          
          <div class="form-group">
            <label class="form-label">Password Min Length</label>
            <input type="number" id="password-min-length" class="form-control" min="6" max="20" value="8">
          </div>
        </div>
        
        <div class="mt-3">
          <label class="checkbox-label">
            <input type="checkbox" id="require-email-verification">
            <span>Require email verification for new users</span>
          </label>
          
          <label class="checkbox-label">
            <input type="checkbox" id="enforce-strong-passwords">
            <span>Enforce strong passwords</span>
          </label>
          
          <label class="checkbox-label">
            <input type="checkbox" id="allow-public-registration">
            <span>Allow public registration</span>
          </label>
        </div>
      </div>
    </div>
    
    <!-- Save Actions -->
    <div class="save-actions mt-4">
      <button class="btn btn-primary" onclick="saveSystemSettings()">
        <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        Save All Settings
      </button>
      <button class="btn btn-secondary" onclick="loadSystemSettings()">Reset Changes</button>
      <button class="btn btn-outline" onclick="exportSystemConfig()">Export Configuration</button>
    </div>
  </div>
</div>

<script>
(function() {
  // Tab switching functionality
  function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-nav-button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // Update tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
      panel.classList.remove('active');
    });
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Update page actions based on active tab
    updatePageActions(tabName);
  }
  
  // Update dynamic action buttons based on active tab
  function updatePageActions(tabName) {
    const actionsContainer = document.getElementById('settings-actions');
    let actionsHTML = '';
    
    switch(tabName) {
      case 'user-directory':
        actionsHTML = `
          <button class="btn btn-primary" onclick="openAddUserModal()">
            <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add User
          </button>
          <button class="btn btn-secondary" onclick="exportUsers()">Export Users</button>
        `;
        break;
      case 'roles':
        actionsHTML = `
          <button class="btn btn-primary" onclick="addRole()">Add Role</button>
          <button class="btn btn-secondary" onclick="exportPermissions()">Export Permissions</button>
        `;
        break;
      case 'activity':
        actionsHTML = `
          <button class="btn btn-secondary" onclick="exportActivityLog()">Export Log</button>
          <button class="btn btn-secondary" onclick="clearOldLogs()">Clear Old Logs</button>
        `;
        break;
      case 'budget':
        actionsHTML = `
          <button class="btn btn-primary" onclick="importBudget()">Import Budget</button>
          <button class="btn btn-secondary" onclick="exportBudget()">Export Budget</button>
        `;
        break;
      case 'system':
        actionsHTML = `
          <button class="btn btn-secondary" onclick="viewSystemInfo()">System Info</button>
          <button class="btn btn-danger" onclick="resetAllSettings()">Reset All</button>
        `;
        break;
    }
    
    actionsContainer.innerHTML = actionsHTML;
  }
  
  // Initialize Budget Settings functionality
  function initializeBudgetSettings() {
    const periodSelect = document.getElementById('budget-period');
    const customGroup = document.getElementById('custom-period-group');
    const startMonthLabel = document.getElementById('start-month-label');
    
    // Handle period change
    periodSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customGroup.style.display = 'block';
      } else {
        customGroup.style.display = 'none';
      }
      
      // Update label based on period
      if (this.value === '12') {
        startMonthLabel.textContent = 'Fiscal Year Start';
      } else {
        startMonthLabel.textContent = 'Starting Month';
      }
      
      updateBudgetSummary();
      generateMonthTabs();
    });
    
    // Generate initial month tabs
    generateMonthTabs();
    
    // Load initial categories
    loadBudgetCategories();
  }
  
  // Generate month tabs with new design
  function generateMonthTabs() {
    const period = document.getElementById('budget-period').value;
    const startMonth = parseInt(document.getElementById('budget-start-month').value);
    const monthTabsContainer = document.getElementById('month-tabs');
    
    let numMonths = period === 'custom' ? 
      parseInt(document.getElementById('budget-custom-months').value) : 
      parseInt(period);
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let tabsHTML = '';
    
    for (let i = 0; i < numMonths; i++) {
      const monthIndex = (startMonth - 1 + i) % 12;
      const monthName = period === '12' ? monthNames[monthIndex] : `Month ${i + 1}`;
      const isActive = i === 0 ? 'active' : '';
      
      tabsHTML += `
        <button class="budget-month-tab ${isActive}" data-month="${i}" onclick="loadMonthBudget(${i})">
          ${monthName}
        </button>
      `;
    }
    
    monthTabsContainer.innerHTML = tabsHTML;
  }
  
  // Helper function to safely extract budget value
  function getBudgetValue(allocation) {
    if (!allocation) return '';
    if (typeof allocation === 'number') return allocation;
    if (typeof allocation === 'string') {
      const num = parseFloat(allocation);
      return isNaN(num) ? '' : num;
    }
    if (typeof allocation === 'object') {
      // Check for budget or amount property
      if (allocation.budget !== undefined) {
        return typeof allocation.budget === 'number' ? allocation.budget : '';
      }
      if (allocation.amount !== undefined) {
        return typeof allocation.amount === 'number' ? allocation.amount : '';
      }
    }
    return '';
  }
  
  // Load budget categories with new card-based UI
  async function loadBudgetCategories(monthAllocations = {}) {
    try {
      const res = await window.callApi('/categories');
      categories = res.data || [];
      const container = document.getElementById('budget-categories');
      
      let html = '';
      
      categories.forEach(cat => {
        // Use category name as the key for allocations (not ID)
        const categoryName = cat.name;
        const categoryAllocation = monthAllocations.categories?.[categoryName] || {};
        const categoryBudgetValue = categoryAllocation['All'] || '';
        
        html += `
          <div class="budget-category-card" data-category-id="${cat.id}" data-cat-id="${cat.category_id || cat.id}">
            <div class="budget-category-header" onclick="toggleBudgetCategory('${cat.id}')">
              <div class="budget-category-expand" id="expand-${cat.id}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </div>
              
              <div class="budget-category-info">
                <div class="budget-category-name">
                  ${cat.name}
                  <span class="budget-category-id">${cat.category_id || cat.id}</span>
                </div>
                ${cat.description ? `<div class="budget-category-description">${cat.description}</div>` : ''}
              </div>
              
              <div class="budget-category-actions">
                <button class="budget-edit-btn" onclick="editBudgetCategory('${cat.id}', event)" title="Edit Category">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
              </div>
              
              <div class="budget-category-amount">
                <span style="color: #6b7280; font-size: 14px; margin-right: 4px;">€</span>
                <input type="number" 
                       class="budget-amount-input category-amount" 
                       id="cat-amount-${cat.id}"
                       data-category-name="${categoryName}"
                       data-category-code="${cat.code || cat.category_id || cat.id}"
                       value="${categoryBudgetValue}"
                       placeholder="0"
                       min="0"
                       step="100"
                       onclick="event.stopPropagation()"
                       onchange="updateCategoryTotal('${cat.id}')">
              </div>
            </div>
            
            <div class="budget-category-content" id="content-${cat.id}">
        `;
        
        // Add subcategories
        if (cat.subcategories && cat.subcategories.length > 0) {
          cat.subcategories.forEach(subcat => {
            // Extract subcategory name properly - handle when subcategory allocation is an object
            let subcatName = '';
            let subcatDesc = '';
            let subcatId = '';
            
            if (typeof subcat === 'string') {
              subcatName = subcat;
              subcatId = subcat;
            } else if (typeof subcat === 'object' && subcat) {
              // Handle malformed data structure where name is nested
              if (typeof subcat.name === 'object' && subcat.name) {
                // Handle case where name field contains an object with name and description
                subcatName = subcat.name.name || '';
                subcatDesc = subcat.name.description || subcat.description || '';
              } else {
                // Handle normal object structure
                subcatName = subcat.name || '';
                subcatDesc = subcat.description || '';
              }
              subcatId = subcat.subcategory_id || subcat.id || subcatName || '';
            }
            
            // Fallback to prevent [object Object] display
            if (!subcatName && subcat) {
              console.warn('Unable to extract subcategory name from:', subcat);
              subcatName = 'Unnamed Subcategory';
            }
            
            // Use subcategory name as the key for allocations
            const subcatAllocation = categoryAllocation[subcatName];
            const subcatBudgetValue = subcatAllocation || '';
            
            html += `
              <div class="budget-subcategory-item" data-subcat-id="${subcatId}">
                <div class="budget-subcategory-info">
                  <div class="budget-subcategory-name">
                    ${subcatName}
                    <span class="subcategory-code">${subcatId}</span>
                  </div>
                  ${subcatDesc ? `<div class="budget-subcategory-description">${subcatDesc}</div>` : ''}
                </div>
                <div></div> <!-- Empty column for alignment -->
                <input type="number" 
                       class="budget-subcategory-amount subcategory-amount" 
                       data-category-name="${categoryName}"
                       data-subcategory-name="${subcatName}"
                       value="${subcatBudgetValue}"
                       placeholder="0"
                       min="0"
                       step="50"
                       onchange="updateSubcategoryTotals('${cat.id}')">
              </div>
            `;
          });
        } else {
          html += '<div style="padding: 12px; color: #9ca3af; font-size: 13px;">No subcategories defined</div>';
        }
        
        html += `
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Initialize totals
      updateAllTotals();
      
    } catch (error) {
      console.error('Failed to load categories:', error);
    }
  }
  
  // Reload budget categories (called from modal)
  window.reloadBudgetCategories = function() {
    loadMonthBudget(currentMonth);
  }
  
  // Update budget configuration summary
  function updateBudgetSummary() {
    const period = document.getElementById('budget-period').value;
    const startMonth = document.getElementById('budget-start-month').value;
    const recurring = document.getElementById('budget-recurring').checked;
    const summary = document.getElementById('budget-config-summary');
    
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    let periodText = '';
    if (period === 'custom') {
      const months = document.getElementById('budget-custom-months').value;
      periodText = `${months} month${months > 1 ? 's' : ''}`;
    } else {
      periodText = `${period} months`;
    }
    
    const startMonthName = monthNames[parseInt(startMonth) - 1];
    const recurringText = recurring ? ', with automatic renewal' : ', without automatic renewal';
    
    summary.textContent = `${periodText} starting from ${startMonthName}${recurringText}`;
  }
  
  // Initialize when page loads
  window.initializeSettingsPage = function() {
    // Set up tab navigation
    document.querySelectorAll('.tab-nav-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        switchTab(tabName);
        
        // Load data specific to each tab when accessed
        if (tabName === 'roles') {
          window.loadPermissions();
        } else if (tabName === 'user-directory') {
          window.loadUsers();
        } else if (tabName === 'activity') {
          window.loadActivityLogs(true);
          loadActivityUserFilter();
        } else if (tabName === 'budget') {
          initializeBudgetSettings();
        }
      });
    });
    
    // Initialize with first tab
    updatePageActions('user-directory');
    
    // Set up budget period listeners
    document.getElementById('budget-start-month').addEventListener('change', updateBudgetSummary);
    document.getElementById('budget-recurring').addEventListener('change', updateBudgetSummary);
    document.getElementById('budget-custom-months').addEventListener('change', () => {
      updateBudgetSummary();
      generateMonthTabs();
    });
    
    // Expand/Collapse all categories
    document.getElementById('expand-all-categories').addEventListener('click', function() {
      const isExpanded = this.textContent === 'Collapse All';
      document.querySelectorAll('.subcategories-list').forEach(list => {
        list.style.display = isExpanded ? 'none' : 'block';
      });
      this.textContent = isExpanded ? 'Expand All' : 'Collapse All';
    });
    
    // Set up search and filter listeners
    document.getElementById('user-search').addEventListener('input', () => window.loadUsers());
    document.getElementById('user-role-filter').addEventListener('change', () => window.loadUsers());
    document.getElementById('user-status-filter').addEventListener('change', () => window.loadUsers());
    
    // Load initial data
    window.loadUsers(); // Load users for User Directory tab
  };
  
  // Global functions for onclick handlers
  window.toggleCategory = function(categoryId) {
    const subcatsList = document.getElementById(`subcats-${categoryId}`);
    const categoryItem = document.querySelector(`[data-category-id="${categoryId}"]`);
    const icon = categoryItem.querySelector('.expand-icon');
    
    if (subcatsList.style.display === 'none') {
      subcatsList.style.display = 'block';
      icon.style.transform = 'rotate(180deg)';
    } else {
      subcatsList.style.display = 'none';
      icon.style.transform = 'rotate(0deg)';
    }
  };
  
  window.switchMonth = function(monthIndex) {
    document.querySelectorAll('.month-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`[data-month="${monthIndex}"]`).classList.add('active');
    
    // Load budget data for selected month
    loadMonthBudget(monthIndex);
  };
  
  window.loadMonthBudget = function(monthIndex) {
    // This will load saved budget data for the selected month
    console.log('Loading budget for month:', monthIndex);
  };
  
  // ============================================================================
  // USER MANAGEMENT FUNCTIONS
  // ============================================================================
  
  // Load users from backend
  window.loadUsers = async function() {
    try {
      const response = await window.callApi('/users');
      if (response.success) {
        const users = response.data || [];
        displayUsers(users);
        updateUserStats(users);
      }
    } catch (error) {
      console.error('Error loading users:', error);
      document.getElementById('users-table').innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-danger">
            Failed to load users. Please refresh the page.
          </td>
        </tr>
      `;
    }
  };
  
  // Display users in table
  function displayUsers(users) {
    const tbody = document.getElementById('users-table');
    
    if (users.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center text-muted">
            No users found. Click "Add User" to create one.
          </td>
        </tr>
      `;
      return;
    }
    
    // Apply filters
    const searchTerm = document.getElementById('user-search').value.toLowerCase();
    const roleFilter = document.getElementById('user-role-filter').value;
    const statusFilter = document.getElementById('user-status-filter').value;
    
    let filteredUsers = users.filter(user => {
      const matchesSearch = !searchTerm || 
        user.name.toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm);
      const matchesRole = !roleFilter || user.role === roleFilter;
      const matchesStatus = !statusFilter || user.status === statusFilter;
      return matchesSearch && matchesRole && matchesStatus;
    });
    
    tbody.innerHTML = filteredUsers.map(user => {
      const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
      const roleClass = `role-${user.role}`;
      const statusClass = `status-${user.status}`;
      
      // Format last active time
      let lastActiveText = 'Never';
      if (user.lastActive) {
        const lastActive = new Date(user.lastActive);
        const now = new Date();
        const diffMs = now - lastActive;
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffHours < 1) {
          lastActiveText = 'Just now';
        } else if (diffHours < 24) {
          lastActiveText = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        } else if (diffDays < 30) {
          lastActiveText = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else {
          lastActiveText = lastActive.toLocaleDateString();
        }
      }
      
      return `
        <tr>
          <td>
            <div class="user-info">
              <div class="user-avatar">${initials}</div>
              <span>${user.name}</span>
            </div>
          </td>
          <td>${user.email}</td>
          <td><span class="role-badge ${roleClass}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span></td>
          <td>${user.department || '-'}</td>
          <td><span class="status-badge ${statusClass}">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span></td>
          <td>${lastActiveText}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="editUser('${user.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}', '${user.name}')">Remove</button>
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // Update user statistics
  function updateUserStats(users) {
    document.getElementById('stat-users').textContent = users.length;
    
    // Count active users this month
    const thisMonth = new Date().getMonth();
    const newUsersThisMonth = users.filter(u => {
      if (u.createdAt) {
        const createdDate = new Date(u.createdAt);
        return createdDate.getMonth() === thisMonth;
      }
      return false;
    }).length;
    
    document.querySelector('#stat-users').nextElementSibling.nextElementSibling.textContent = 
      `+${newUsersThisMonth} this month`;
  }
  
  // Open Add User Modal
  window.openAddUserModal = function() {
    if (window.openUserModal) {
      window.openUserModal(null);
    } else {
      // Load modal if not loaded
      loadModal('/modals/user-modal.html', () => {
        window.openUserModal(null);
      });
    }
  };
  
  // Edit user
  window.editUser = async function(userId) {
    try {
      // Get user data
      const response = await window.callApi('/users');
      if (response.success) {
        const user = response.data.find(u => u.id === userId);
        if (user) {
          if (window.openUserModal) {
            window.openUserModal(user);
          } else {
            loadModal('/modals/user-modal.html', () => {
              window.openUserModal(user);
            });
          }
        }
      }
    } catch (error) {
      console.error('Error loading user:', error);
      alert('Failed to load user data');
    }
  };
  
  // Delete user
  window.deleteUser = async function(userId, userName) {
    if (!confirm(`Are you sure you want to remove ${userName}? This action cannot be undone.`)) {
      return;
    }
    
    try {
      const response = await window.callApi(`/users/${userId}`, {
        method: 'DELETE'
      });
      
      if (response.success) {
        window.loadUsers();
        alert('User removed successfully');
      } else {
        alert('Failed to remove user: ' + (response.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error deleting user:', error);
      alert('Failed to remove user. Please try again.');
    }
  };
  
  // Export users
  window.exportUsers = function() {
    console.log('Exporting users...');
    // TODO: Implement CSV export
  };
  
  // ============================================================================
  // ROLES & PERMISSIONS FUNCTIONS
  // ============================================================================
  
  let currentPermissions = {};
  let hasPermissionChanges = false;
  
  // Load permissions from backend
  window.loadPermissions = async function() {
    try {
      const response = await window.callApi('/permissions');
      if (response.success) {
        currentPermissions = response.data || getDefaultPermissions();
        displayPermissions();
      }
    } catch (error) {
      console.error('Error loading permissions:', error);
      currentPermissions = getDefaultPermissions();
      displayPermissions();
    }
  };
  
  // Display permissions in the UI
  function displayPermissions() {
    // Update checkboxes based on current permissions
    const roles = ['admin', 'manager', 'user', 'viewer'];
    const permissions = [
      // Expense Management
      {id: 'view-expenses', key: 'viewExpenses'},
      {id: 'create-expenses', key: 'createExpenses'},
      {id: 'edit-all-expenses', key: 'editAllExpenses'},
      {id: 'delete-expenses', key: 'deleteExpenses'},
      // Budget Management
      {id: 'view-budget', key: 'viewBudget'},
      {id: 'modify-budget', key: 'modifyBudget'},
      // User Management
      {id: 'view-users', key: 'viewUsers'},
      {id: 'manage-users', key: 'manageUsers'},
      // System Settings
      {id: 'access-settings', key: 'accessSettings'},
      {id: 'modify-settings', key: 'modifySettings'}
    ];
    
    roles.forEach(role => {
      permissions.forEach(perm => {
        const checkbox = document.querySelector(`#perm-${perm.id}-${role}`);
        if (checkbox) {
          checkbox.checked = currentPermissions[role]?.[perm.key] || false;
          
          // Admin permissions are always enabled and disabled
          if (role === 'admin') {
            checkbox.checked = true;
            checkbox.disabled = true;
          } else {
            checkbox.disabled = false;
            // Add change listener
            checkbox.onchange = () => markPermissionChanged();
          }
        }
      });
    });
  }
  
  // Mark that permissions have changed
  function markPermissionChanged() {
    hasPermissionChanges = true;
    // Enable save button
    const saveBtn = document.querySelector('#save-permissions-btn');
    if (saveBtn) {
      saveBtn.classList.remove('btn-secondary');
      saveBtn.classList.add('btn-primary');
    }
  }
  
  // Save permissions to backend
  window.savePermissions = async function() {
    if (!hasPermissionChanges) {
      alert('No changes to save');
      return;
    }
    
    // Collect permissions from checkboxes
    const roles = ['admin', 'manager', 'user', 'viewer'];
    const updatedPermissions = {};
    
    roles.forEach(role => {
      updatedPermissions[role] = {
        viewExpenses: document.querySelector(`#perm-view-expenses-${role}`)?.checked || false,
        createExpenses: document.querySelector(`#perm-create-expenses-${role}`)?.checked || false,
        editAllExpenses: document.querySelector(`#perm-edit-all-expenses-${role}`)?.checked || false,
        deleteExpenses: document.querySelector(`#perm-delete-expenses-${role}`)?.checked || false,
        viewBudget: document.querySelector(`#perm-view-budget-${role}`)?.checked || false,
        modifyBudget: document.querySelector(`#perm-modify-budget-${role}`)?.checked || false,
        viewUsers: document.querySelector(`#perm-view-users-${role}`)?.checked || false,
        manageUsers: document.querySelector(`#perm-manage-users-${role}`)?.checked || false,
        accessSettings: document.querySelector(`#perm-access-settings-${role}`)?.checked || false,
        modifySettings: document.querySelector(`#perm-modify-settings-${role}`)?.checked || false
      };
    });
    
    try {
      const response = await window.callApi('/permissions', {
        method: 'PUT',
        body: JSON.stringify(updatedPermissions)
      });
      
      if (response.success) {
        currentPermissions = updatedPermissions;
        hasPermissionChanges = false;
        alert('Permissions saved successfully');
        
        // Reset save button
        const saveBtn = document.querySelector('#save-permissions-btn');
        if (saveBtn) {
          saveBtn.classList.remove('btn-primary');
          saveBtn.classList.add('btn-secondary');
        }
      } else {
        alert('Failed to save permissions: ' + (response.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error saving permissions:', error);
      alert('Failed to save permissions. Please try again.');
    }
  };
  
  // Reset permissions to defaults
  window.resetPermissions = function() {
    if (!confirm('Are you sure you want to reset all permissions to defaults? This cannot be undone.')) {
      return;
    }
    
    currentPermissions = getDefaultPermissions();
    displayPermissions();
    markPermissionChanged();
  };
  
  // Get default permissions
  function getDefaultPermissions() {
    return {
      admin: {
        viewExpenses: true,
        createExpenses: true,
        editAllExpenses: true,
        deleteExpenses: true,
        viewBudget: true,
        modifyBudget: true,
        viewUsers: true,
        manageUsers: true,
        accessSettings: true,
        modifySettings: true
      },
      manager: {
        viewExpenses: true,
        createExpenses: true,
        editAllExpenses: true,
        deleteExpenses: true,
        viewBudget: true,
        modifyBudget: true,
        viewUsers: true,
        manageUsers: false,
        accessSettings: true,
        modifySettings: false
      },
      user: {
        viewExpenses: true,
        createExpenses: true,
        editAllExpenses: false,
        deleteExpenses: false,
        viewBudget: true,
        modifyBudget: false,
        viewUsers: false,
        manageUsers: false,
        accessSettings: false,
        modifySettings: false
      },
      viewer: {
        viewExpenses: true,
        createExpenses: false,
        editAllExpenses: false,
        deleteExpenses: false,
        viewBudget: true,
        modifyBudget: false,
        viewUsers: false,
        manageUsers: false,
        accessSettings: false,
        modifySettings: false
      }
    };
  }
  
  // Export permissions as JSON
  window.exportPermissions = function() {
    const dataStr = JSON.stringify(currentPermissions, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `permissions_${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };
  
  // Add new role (placeholder)
  window.addRole = function() {
    alert('Custom roles feature coming soon!');
  };
  
  // ============================================================================
  // ACTIVITY LOG FUNCTIONS
  // ============================================================================
  
  let currentActivityOffset = 0;
  const activityLimit = 20;
  let isLoadingActivities = false;
  let hasMoreActivities = true;
  
  // Load activity logs
  window.loadActivityLogs = async function(reset = false) {
    if (isLoadingActivities) return;
    if (!hasMoreActivities && !reset) return;
    
    isLoadingActivities = true;
    
    if (reset) {
      currentActivityOffset = 0;
      hasMoreActivities = true;
      document.querySelector('.activity-timeline').innerHTML = '';
    }
    
    try {
      // Build query parameters
      const params = new URLSearchParams({
        limit: activityLimit,
        offset: currentActivityOffset
      });
      
      // Add filters if set
      const startDate = document.getElementById('activity-start')?.value;
      const endDate = document.getElementById('activity-end')?.value;
      const type = document.getElementById('activity-type')?.value;
      const userId = document.getElementById('activity-user')?.value;
      
      if (startDate) params.append('startDate', startDate);
      if (endDate) params.append('endDate', endDate);
      if (type) params.append('type', type);
      if (userId) params.append('userId', userId);
      
      const response = await window.callApi(`/activity-logs?${params}`);
      
      if (response.success) {
        const logs = response.data || [];
        hasMoreActivities = response.hasMore;
        
        if (logs.length === 0 && currentActivityOffset === 0) {
          document.querySelector('.activity-timeline').innerHTML = `
            <div class="text-center text-muted py-4">
              No activity logs found for the selected filters.
            </div>
          `;
        } else {
          displayActivityLogs(logs, reset);
          currentActivityOffset += logs.length;
        }
        
        // Update load more button
        const loadMoreBtn = document.querySelector('#load-more-activities');
        if (loadMoreBtn) {
          loadMoreBtn.style.display = hasMoreActivities ? 'inline-block' : 'none';
        }
      }
    } catch (error) {
      console.error('Error loading activity logs:', error);
      if (currentActivityOffset === 0) {
        document.querySelector('.activity-timeline').innerHTML = `
          <div class="text-center text-danger py-4">
            Failed to load activity logs. Please try again.
          </div>
        `;
      }
    } finally {
      isLoadingActivities = false;
    }
  };
  
  // Display activity logs in the timeline
  function displayActivityLogs(logs, reset) {
    const timeline = document.querySelector('.activity-timeline');
    
    if (reset) {
      timeline.innerHTML = '';
    }
    
    logs.forEach(log => {
      const timelineItem = createTimelineItem(log);
      timeline.appendChild(timelineItem);
    });
  }
  
  // Create a timeline item element
  function createTimelineItem(log) {
    const item = document.createElement('div');
    item.className = 'timeline-item';
    
    // Format timestamp
    const timestamp = new Date(log.timestamp);
    const timeAgo = formatTimeAgo(timestamp);
    
    // Get icon and color based on type
    const {icon, color} = getActivityTypeInfo(log.type);
    
    item.innerHTML = `
      <div class="timeline-marker" style="background-color: ${color}"></div>
      <div class="timeline-content">
        <div class="timeline-header">
          <strong>${log.userName || 'Unknown User'}</strong> ${formatAction(log.action, log.type)}
          <span class="timeline-time">${timeAgo}</span>
        </div>
        <div class="timeline-body">
          ${log.details || ''}
        </div>
      </div>
    `;
    
    return item;
  }
  
  // Format action text
  function formatAction(action, type) {
    const actionMap = {
      'created': 'created',
      'updated': 'updated',
      'deleted': 'deleted',
      'logged_in': 'logged in',
      'logged_out': 'logged out',
      'approved': 'approved',
      'rejected': 'rejected',
      'exported': 'exported',
      'imported': 'imported'
    };
    
    const typeMap = {
      'user': 'a user',
      'expense': 'an expense',
      'budget': 'the budget',
      'system': 'system settings',
      'login': ''
    };
    
    const actionText = actionMap[action] || action;
    const typeText = typeMap[type] || type;
    
    if (type === 'login') {
      return actionText;
    }
    
    return `${actionText} ${typeText}`;
  }
  
  // Get activity type info (icon and color)
  function getActivityTypeInfo(type) {
    const typeInfo = {
      'user': {icon: '👤', color: '#8B5CF6'},
      'expense': {icon: '💰', color: '#10B981'},
      'budget': {icon: '📊', color: '#F59E0B'},
      'system': {icon: '⚙️', color: '#6B7280'},
      'login': {icon: '🔐', color: '#3B82F6'}
    };
    
    return typeInfo[type] || {icon: '📝', color: '#6B7280'};
  }
  
  // Format time ago
  function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSecs < 60) {
      return 'just now';
    } else if (diffMins < 60) {
      return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
    } else if (diffHours < 24) {
      return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    } else if (diffDays < 30) {
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    } else {
      return date.toLocaleDateString();
    }
  }
  
  // Filter activities
  window.filterActivities = function() {
    loadActivityLogs(true);
  };
  
  // Load more activities
  window.loadMoreActivities = function() {
    loadActivityLogs(false);
  };
  
  // Export activity log
  window.exportActivityLog = async function() {
    try {
      // Fetch all logs without pagination
      const params = new URLSearchParams({limit: 1000});
      
      const startDate = document.getElementById('activity-start')?.value;
      const endDate = document.getElementById('activity-end')?.value;
      const type = document.getElementById('activity-type')?.value;
      
      if (startDate) params.append('startDate', startDate);
      if (endDate) params.append('endDate', endDate);
      if (type) params.append('type', type);
      
      const response = await window.callApi(`/activity-logs?${params}`);
      
      if (response.success) {
        const logs = response.data || [];
        
        // Convert to CSV
        const csv = convertLogsToCSV(logs);
        
        // Download file
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `activity_log_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      }
    } catch (error) {
      console.error('Error exporting activity log:', error);
      alert('Failed to export activity log');
    }
  };
  
  // Convert logs to CSV
  function convertLogsToCSV(logs) {
    const headers = ['Date/Time', 'User', 'Type', 'Action', 'Details'];
    const rows = logs.map(log => [
      new Date(log.timestamp).toLocaleString(),
      log.userName || 'Unknown',
      log.type,
      log.action,
      log.details || ''
    ]);
    
    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');
    
    return csvContent;
  }
  
  // Clear old logs
  window.clearOldLogs = async function() {
    const daysToKeep = prompt('Keep logs from the last how many days?', '90');
    
    if (!daysToKeep || isNaN(daysToKeep)) {
      return;
    }
    
    if (!confirm(`Are you sure you want to delete all activity logs older than ${daysToKeep} days? This cannot be undone.`)) {
      return;
    }
    
    try {
      const response = await window.callApi(`/activity-logs/old?daysToKeep=${daysToKeep}`, {
        method: 'DELETE'
      });
      
      if (response.success) {
        alert(`Successfully deleted ${response.deletedCount} old activity logs`);
        loadActivityLogs(true);
      } else {
        alert('Failed to clear old logs: ' + (response.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error clearing old logs:', error);
      alert('Failed to clear old logs');
    }
  };
  
  // Load users for activity filter dropdown
  async function loadActivityUserFilter() {
    try {
      const response = await window.callApi('/users');
      if (response.success) {
        const users = response.data || [];
        const select = document.getElementById('activity-user');
        
        if (select) {
          select.innerHTML = '<option value="">All Users</option>' +
            users.map(user => `
              <option value="${user.id}">${user.name}</option>
            `).join('');
        }
      }
    } catch (error) {
      console.error('Error loading users for filter:', error);
    }
  }
  
  // ============================================================================
  // BUDGET SETTINGS FUNCTIONS
  // ============================================================================
  
  let currentBudgetSettings = {};
  let currentAllocations = {};
  let currentMonth = 0;
  let categories = [];
  let allCategoriesExpanded = false;
  
  // Initialize budget settings
  async function initializeBudgetSettings() {
    try {
      // Load budget settings
      const settingsRes = await window.callApi('/budget-settings');
      if (settingsRes.success) {
        currentBudgetSettings = settingsRes.data;
        applyBudgetSettings();
      }
      
      // Load categories
      const catRes = await window.callApi('/categories');
      if (catRes.success) {
        categories = catRes.data || [];
      }
      
      // Generate month tabs
      generateMonthTabs();
      
      // Load allocations for current year
      const year = currentBudgetSettings.fiscalYear || new Date().getFullYear();
      const allocRes = await window.callApi(`/budget-allocations?year=${year}`);
      if (allocRes.success) {
        currentAllocations = allocRes.data || {};
      }
      
      // Load first month
      loadMonthBudget(0);
      
    } catch (error) {
      console.error('Error initializing budget settings:', error);
    }
  }
  
  // Apply budget settings to UI
  function applyBudgetSettings() {
    document.getElementById('budget-period').value = currentBudgetSettings.period || 12;
    document.getElementById('budget-start-month').value = currentBudgetSettings.startMonth || 1;
    document.getElementById('budget-recurring').checked = currentBudgetSettings.autoRenew !== false;
    
    // Show/hide custom period input
    const period = currentBudgetSettings.period;
    const customGroup = document.getElementById('custom-period-group');
    if (period === 'custom') {
      customGroup.style.display = 'block';
    } else {
      customGroup.style.display = 'none';
    }
    
    updateBudgetSummary();
  }
  
  // Save budget settings
  window.saveBudgetSettings = async function() {
    try {
      const period = document.getElementById('budget-period').value;
      const startMonth = document.getElementById('budget-start-month').value;
      const autoRenew = document.getElementById('budget-recurring').checked;
      
      const settings = {
        period: period === 'custom' ? 
          parseInt(document.getElementById('budget-custom-months').value) : 
          parseInt(period),
        startMonth: parseInt(startMonth),
        fiscalYear: currentBudgetSettings.fiscalYear || new Date().getFullYear(),
        autoRenew,
        currency: "EUR"
      };
      
      const response = await window.callApi('/budget-settings', {
        method: 'PUT',
        body: JSON.stringify(settings)
      });
      
      if (response.success) {
        currentBudgetSettings = settings;
        alert('Budget settings saved successfully');
      } else {
        alert('Failed to save budget settings: ' + (response.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error saving budget settings:', error);
      alert('Failed to save budget settings');
    }
  };
  
  // Reset budget settings
  window.resetBudgetSettings = function() {
    if (!confirm('Are you sure you want to reset budget settings to defaults?')) {
      return;
    }
    
    currentBudgetSettings = {
      period: 12,
      startMonth: 1,
      fiscalYear: new Date().getFullYear(),
      autoRenew: true,
      currency: "EUR"
    };
    
    applyBudgetSettings();
    generateMonthTabs();
  };
  
  // Export budget settings
  window.exportBudgetSettings = async function() {
    try {
      const exportData = {
        settings: currentBudgetSettings,
        allocations: currentAllocations,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = `budget_config_${new Date().toISOString().slice(0,10)}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    } catch (error) {
      console.error('Error exporting budget settings:', error);
      alert('Failed to export budget settings');
    }
  };
  
  // Import budget settings
  window.importBudget = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (!data.settings || !data.allocations) {
          alert('Invalid budget file format');
          return;
        }
        
        if (confirm('This will replace your current budget configuration. Continue?')) {
          currentBudgetSettings = data.settings;
          currentAllocations = data.allocations;
          
          applyBudgetSettings();
          generateMonthTabs();
          loadMonthBudget(0);
          
          alert('Budget configuration imported successfully');
        }
      } catch (error) {
        console.error('Error importing budget:', error);
        alert('Failed to import budget file');
      }
    };
    
    input.click();
  };
  
  // Export budget (alias for exportBudgetSettings)
  window.exportBudget = window.exportBudgetSettings;
  
  // Apply total budget to categories
  window.applyTotalBudget = function() {
    const total = parseFloat(document.getElementById('total-monthly-budget').value) || 0;
    
    if (total <= 0) {
      alert('Please enter a valid total budget amount');
      return;
    }
    
    // Get all category budget inputs
    const categoryInputs = document.querySelectorAll('.category-budget-input');
    const numCategories = categoryInputs.length;
    
    if (numCategories === 0) return;
    
    // Distribute equally among categories
    const perCategory = Math.floor(total / numCategories);
    const remainder = total - (perCategory * numCategories);
    
    categoryInputs.forEach((input, index) => {
      // Add remainder to first category
      input.value = index === 0 ? perCategory + remainder : perCategory;
      
      // Trigger change event
      input.dispatchEvent(new Event('change'));
    });
    
    updateBudgetTotals();
  };
  
  // Load budget for specific month
  window.loadMonthBudget = function(monthIndex) {
    currentMonth = monthIndex;
    
    // Update active tab - using correct class name
    document.querySelectorAll('.budget-month-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    const activeTab = document.querySelector(`.budget-month-tab[data-month="${monthIndex}"]`);
    if (activeTab) {
      activeTab.classList.add('active');
    }
    
    // Calculate month key
    const year = currentBudgetSettings.fiscalYear || new Date().getFullYear();
    const startMonth = currentBudgetSettings.startMonth || 1;
    const actualMonth = ((startMonth - 1 + monthIndex) % 12) + 1;
    const actualYear = year + Math.floor((startMonth - 1 + monthIndex) / 12);
    const monthKey = `${actualYear}-${String(actualMonth).padStart(2, '0')}`;
    
    // Load allocations for this month
    const monthAllocations = currentAllocations[monthKey] || {};
    
    // Load categories and display budget form
    loadBudgetCategories(monthAllocations);
  };
  
  // Toggle budget category expansion
  window.toggleBudgetCategory = function(categoryId) {
    const card = document.querySelector(`.budget-category-card[data-category-id="${categoryId}"]`);
    const expand = document.getElementById(`expand-${categoryId}`);
    
    if (card) {
      if (card.classList.contains('expanded')) {
        card.classList.remove('expanded');
        if (expand) expand.classList.remove('expanded');
      } else {
        card.classList.add('expanded');
        if (expand) expand.classList.add('expanded');
      }
    }
  };
  
  // Toggle all categories expand/collapse
  window.toggleAllCategories = function() {
    const allCards = document.querySelectorAll('.budget-category-card');
    const allExpands = document.querySelectorAll('.budget-category-expand');
    const toggleText = document.getElementById('expand-toggle-text');
    
    if (!allCategoriesExpanded) {
      allCards.forEach(card => card.classList.add('expanded'));
      allExpands.forEach(expand => expand.classList.add('expanded'));
      if (toggleText) toggleText.textContent = 'Collapse All';
      allCategoriesExpanded = true;
    } else {
      allCards.forEach(card => card.classList.remove('expanded'));
      allExpands.forEach(expand => expand.classList.remove('expanded'));
      if (toggleText) toggleText.textContent = 'Expand All';
      allCategoriesExpanded = false;
    }
  };
  
  // Update category total from subcategories
  window.updateSubcategoryTotals = function(categoryId) {
    let total = 0;
    const card = document.querySelector(`[data-category-id="${categoryId}"]`);
    
    // Sum all subcategory amounts
    card.querySelectorAll('.subcategory-amount').forEach(input => {
      total += parseFloat(input.value) || 0;
    });
    
    // Update category amount input
    const categoryInput = document.getElementById(`cat-amount-${categoryId}`);
    if (categoryInput) {
      categoryInput.value = total || '';
      categoryInput.disabled = total > 0; // Disable if subcategories have values
    }
    
    // Update grand total
    updateAllTotals();
  };
  
  // Update category total (manual entry)
  window.updateCategoryTotal = function(categoryId) {
    const categoryInput = document.getElementById(`cat-amount-${categoryId}`);
    const card = document.querySelector(`[data-category-id="${categoryId}"]`);
    
    // If category has a value, clear subcategory values
    if (categoryInput && parseFloat(categoryInput.value) > 0) {
      card.querySelectorAll('.subcategory-amount').forEach(input => {
        input.value = '';
        input.disabled = true;
      });
    } else {
      // Re-enable subcategory inputs if category is cleared
      card.querySelectorAll('.subcategory-amount').forEach(input => {
        input.disabled = false;
      });
    }
    
    updateAllTotals();
  };
  
  // Update all totals
  function updateAllTotals() {
    let grandTotal = 0;
    let categoryCount = 0;
    let subcategoryCount = 0;
    
    // Count and sum categories
    document.querySelectorAll('.budget-category-card').forEach(card => {
      const categoryInput = card.querySelector('.category-amount');
      if (categoryInput) {
        const amount = parseFloat(categoryInput.value) || 0;
        if (amount > 0) {
          grandTotal += amount;
          categoryCount++;
        }
      }
      
      // Count subcategories with values
      card.querySelectorAll('.subcategory-amount').forEach(input => {
        if (parseFloat(input.value) > 0) {
          subcategoryCount++;
        }
      });
    });
    
    // Update display
    const totalElement = document.getElementById('budget-total-value');
    if (totalElement) {
      totalElement.textContent = grandTotal.toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      });
    }
    
    // These elements were removed but might be referenced elsewhere
    const categoryCountEl = document.getElementById('category-count');
    if (categoryCountEl) categoryCountEl.textContent = categoryCount;
    
    const subcategoryCountEl = document.getElementById('subcategory-count');
    if (subcategoryCountEl) subcategoryCountEl.textContent = subcategoryCount;
  }
  
  // Open add category modal
  window.openAddCategoryModal = async function() {
    // Load the modal if not already loaded
    if (!document.getElementById('budgetCategoryModal')) {
      try {
        const response = await fetch('/modals/budget-category-modal.html');
        if (!response.ok) throw new Error('Modal not found');
        const html = await response.text();
        
        // Create a temporary container
        const temp = document.createElement('div');
        temp.innerHTML = html;
        
        // Extract and append the modal HTML
        const modalDiv = temp.querySelector('#budgetCategoryModal');
        if (modalDiv) {
          document.body.appendChild(modalDiv);
        }
        
        // Extract and append styles
        const styles = temp.querySelectorAll('style');
        styles.forEach(style => {
          document.head.appendChild(style.cloneNode(true));
        });
        
        // Extract and execute scripts
        const scripts = temp.querySelectorAll('script');
        scripts.forEach(script => {
          const newScript = document.createElement('script');
          newScript.textContent = script.textContent;
          document.head.appendChild(newScript);
        });
        
        // Small delay to ensure everything is initialized
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Now open the modal
        if (typeof window.openBudgetCategoryModal === 'function') {
          window.openBudgetCategoryModal();
        } else {
          // Fallback: just show the modal
          const modal = document.getElementById('budgetCategoryModal');
          if (modal) modal.style.display = 'flex';
        }
      } catch (error) {
        console.error('Error loading modal:', error);
        alert('Failed to load category modal. Please refresh and try again.');
      }
    } else {
      // Modal already loaded, just open it
      if (typeof window.openBudgetCategoryModal === 'function') {
        window.openBudgetCategoryModal();
      } else {
        // Fallback: just show the modal
        const modal = document.getElementById('budgetCategoryModal');
        if (modal) modal.style.display = 'flex';
      }
    }
  };
  
  // Edit budget category
  window.editBudgetCategory = async function(categoryId, event) {
    if (event) {
      event.stopPropagation();
    }
    
    // Find category data
    const category = categories.find(c => c.id === categoryId);
    if (!category) return;
    
    // Load modal first if needed
    if (!document.getElementById('budgetCategoryModal')) {
      await openAddCategoryModal();
    }
    
    // Modal should now be loaded, open with data
    if (typeof window.openBudgetCategoryModal === 'function') {
      window.openBudgetCategoryModal(category);
    }
  };
  
  // Copy from previous month
  window.copyFromPreviousMonth = async function() {
    if (currentMonth === 0) {
      alert('This is the first month. No previous month to copy from.');
      return;
    }
    
    if (!confirm('Copy budget allocations from the previous month? This will overwrite current values.')) {
      return;
    }
    
    try {
      // Get previous month's key
      const year = currentBudgetSettings.fiscalYear || new Date().getFullYear();
      const startMonth = currentBudgetSettings.startMonth || 1;
      const prevMonthIndex = currentMonth - 1;
      const prevActualMonth = ((startMonth - 1 + prevMonthIndex) % 12) + 1;
      const prevActualYear = year + Math.floor((startMonth - 1 + prevMonthIndex) / 12);
      const prevMonthKey = `${prevActualYear}-${String(prevActualMonth).padStart(2, '0')}`;
      
      // Get previous month's allocations
      const prevAllocations = currentAllocations[prevMonthKey] || {};
      
      if (!prevAllocations.categories || Object.keys(prevAllocations.categories).length === 0) {
        alert('No budget data found for the previous month');
        return;
      }
      
      // Apply to current month's UI
      applyAllocationsToUI(prevAllocations);
      
      alert('Budget allocations copied from previous month. Remember to save!');
    } catch (error) {
      console.error('Error copying from previous month:', error);
      alert('Failed to copy from previous month');
    }
  };
  
  // Copy to remaining months
  window.copyToRemainingMonths = async function() {
    if (!confirm('Copy current month allocations to all remaining months? This will overwrite their values.')) {
      return;
    }
    
    try {
      // Get current allocations from UI
      const allocationsToApply = gatherCurrentAllocations();
      
      if (!allocationsToApply.categories || Object.keys(allocationsToApply.categories).length === 0) {
        alert('No budget allocations to copy');
        return;
      }
      
      // Apply to all remaining months
      const totalMonths = document.querySelectorAll('.budget-month-tab').length;
      let savedCount = 0;
      
      for (let i = currentMonth + 1; i < totalMonths; i++) {
        // Calculate month key
        const year = currentBudgetSettings.fiscalYear || new Date().getFullYear();
        const startMonth = currentBudgetSettings.startMonth || 1;
        const actualMonth = ((startMonth - 1 + i) % 12) + 1;
        const actualYear = year + Math.floor((startMonth - 1 + i) / 12);
        const monthKey = `${actualYear}-${String(actualMonth).padStart(2, '0')}`;
        
        // Save to backend immediately
        const response = await window.callApi('/budget-allocations', {
          method: 'PUT',
          body: JSON.stringify({
            monthKey,
            allocations: allocationsToApply
          })
        });
        
        if (response.success) {
          // Store in local cache
          currentAllocations[monthKey] = allocationsToApply;
          savedCount++;
        }
      }
      
      if (savedCount > 0) {
        alert(`Budget allocations copied to ${savedCount} remaining months`);
      } else {
        alert('Failed to copy allocations to remaining months');
      }
    } catch (error) {
      console.error('Error copying to remaining months:', error);
      alert('Failed to copy to remaining months');
    }
  };
  
  // Apply allocations to UI
  function applyAllocationsToUI(allocations) {
    if (!allocations || !allocations.categories) return;
    
    document.querySelectorAll('.category-item').forEach(item => {
      const categoryName = item.querySelector('.category-name').textContent.trim();
      const categoryData = allocations.categories[categoryName];
      
      if (categoryData) {
        // Set category-level budget if exists
        const categoryInput = item.querySelector('.category-budget-input');
        if (categoryInput && categoryData['All']) {
          categoryInput.value = categoryData['All'] || 0;
        }
        
        // Set subcategory budgets
        item.querySelectorAll('.subcategory-row').forEach(subRow => {
          const subName = subRow.querySelector('.subcategory-name').textContent.trim();
          const subInput = subRow.querySelector('.subcategory-budget-input');
          if (subInput && categoryData[subName] !== undefined) {
            subInput.value = categoryData[subName] || 0;
          }
        });
      }
    });
    
    updateBudgetTotals();
  }
  
  // Gather current allocations from UI - dynamic version
  function gatherCurrentAllocations() {
    const allocations = {
      total: 0,
      categories: {}
    };
    
    // Get all category-level budget inputs
    const categoryInputs = document.querySelectorAll('.category-amount');
    categoryInputs.forEach(input => {
      const value = parseFloat(input.value) || 0;
      if (value > 0) {
        const categoryName = input.getAttribute('data-category-name');
        
        if (categoryName) {
          if (!allocations.categories[categoryName]) {
            allocations.categories[categoryName] = {};
          }
          allocations.categories[categoryName]['All'] = value;
          allocations.total += value;
        }
      }
    });
    
    // Get all subcategory-level budget inputs
    const subcategoryInputs = document.querySelectorAll('.subcategory-amount');
    subcategoryInputs.forEach(input => {
      const value = parseFloat(input.value) || 0;
      if (value > 0) {
        const categoryName = input.getAttribute('data-category-name');
        const subcategoryName = input.getAttribute('data-subcategory-name');
        
        if (categoryName && subcategoryName) {
          if (!allocations.categories[categoryName]) {
            allocations.categories[categoryName] = {};
          }
          allocations.categories[categoryName][subcategoryName] = value;
          allocations.total += value;
        }
      }
    });
    
    return allocations;
  };
  
  // Reset budget changes
  window.resetBudgetChanges = function() {
    if (!confirm('Reset all unsaved changes?')) {
      return;
    }
    
    loadMonthBudget(currentMonth);
  };
  
  // Save budget allocations
  window.saveBudgetAllocations = async function() {
    try {
      const year = currentBudgetSettings.fiscalYear || new Date().getFullYear();
      const startMonth = currentBudgetSettings.startMonth || 1;
      const actualMonth = ((startMonth - 1 + currentMonth) % 12) + 1;
      const actualYear = year + Math.floor((startMonth - 1 + currentMonth) / 12);
      const monthKey = `${actualYear}-${String(actualMonth).padStart(2, '0')}`;
      
      // Gather allocations from UI
      const allocations = gatherCurrentAllocations();
      
      // Save to backend
      const response = await window.callApi('/budget-allocations', {
        method: 'PUT',
        body: JSON.stringify({
          monthKey,
          allocations
        })
      });
      
      if (response.success) {
        currentAllocations[monthKey] = allocations;
        alert('Budget allocations saved successfully');
      } else {
        alert('Failed to save budget allocations');
      }
    } catch (error) {
      console.error('Error saving allocations:', error);
      alert('Failed to save budget allocations');
    }
  };
  
  // Update budget totals
  function updateBudgetTotals() {
    let total = 0;
    
    // Sum all category budgets
    document.querySelectorAll('.category-budget-input').forEach(input => {
      total += parseFloat(input.value) || 0;
    });
    
    // Update total display
    const totalInput = document.getElementById('total-monthly-budget');
    if (totalInput) {
      totalInput.value = total;
    }
    
    // Update category totals
    document.querySelectorAll('.category-item').forEach(item => {
      let categoryTotal = 0;
      
      // Main category budget
      const mainInput = item.querySelector('.category-budget-input');
      categoryTotal += parseFloat(mainInput?.value) || 0;
      
      // Subcategory budgets
      item.querySelectorAll('.subcategory-budget-input').forEach(subInput => {
        categoryTotal += parseFloat(subInput.value) || 0;
      });
      
      // Update display
      const totalSpan = item.querySelector('.category-total');
      if (totalSpan) {
        totalSpan.textContent = `€${categoryTotal.toFixed(2)}`;
      }
    });
  }
  
  // Save current month allocations
  async function saveCurrentMonthAllocations() {
    try {
      // Calculate month key
      const year = currentBudgetSettings.fiscalYear || new Date().getFullYear();
      const startMonth = currentBudgetSettings.startMonth || 1;
      const actualMonth = ((startMonth - 1 + currentMonth) % 12) + 1;
      const actualYear = year + Math.floor((startMonth - 1 + currentMonth) / 12);
      const monthKey = `${actualYear}-${String(actualMonth).padStart(2, '0')}`;
      
      // Collect allocations using category IDs
      const allocations = {
        total: parseFloat(document.getElementById('total-monthly-budget').value) || 0,
        categories: {}
      };
      
      document.querySelectorAll('.category-item').forEach(item => {
        const categoryId = item.dataset.catId; // Get category ID from data attribute
        const categoryName = item.querySelector('.category-name')?.textContent;
        if (!categoryId) return;
        
        const categoryBudget = parseFloat(item.querySelector('.category-budget-input')?.value) || 0;
        
        allocations.categories[categoryId] = {
          budget: categoryBudget,
          name: categoryName, // Store name for reference
          subcategories: {}
        };
        
        // Collect subcategories using their IDs
        item.querySelectorAll('.subcategory-item').forEach(subItem => {
          const subcatId = subItem.dataset.subcatId;
          const subcatName = subItem.querySelector('.subcategory-name')?.textContent;
          const subcatBudget = parseFloat(subItem.querySelector('.subcategory-budget-input')?.value) || 0;
          
          if (subcatId) {
            allocations.categories[categoryId].subcategories[subcatId] = {
              budget: subcatBudget,
              name: subcatName
            };
          }
        });
      });
      
      // Save to backend
      const response = await window.callApi('/budget-allocations', {
        method: 'PUT',
        body: JSON.stringify({
          monthKey,
          allocations
        })
      });
      
      if (response.success) {
        currentAllocations[monthKey] = allocations;
        alert('Budget allocations saved successfully');
      } else {
        alert('Failed to save budget allocations');
      }
    } catch (error) {
      console.error('Error saving allocations:', error);
      alert('Failed to save budget allocations');
    }
  }
  
  // ============================================================================
  // SYSTEM SETTINGS FUNCTIONS
  // ============================================================================
  
  let currentSystemSettings = {};
  let currentEmailSettings = {};
  let currentIntegrations = {};
  
  // Load system settings
  async function loadSystemSettings() {
    try {
      // Load system configuration
      const sysResponse = await window.callApi('/system-settings');
      if (sysResponse.success) {
        currentSystemSettings = sysResponse.data;
        displaySystemSettings(currentSystemSettings);
      }
      
      // Load email settings
      const emailResponse = await window.callApi('/email-settings');
      if (emailResponse.success) {
        currentEmailSettings = emailResponse.data;
        displayEmailSettings(currentEmailSettings);
      }
      
      // Load integrations
      const intResponse = await window.callApi('/integrations');
      if (intResponse.success) {
        currentIntegrations = intResponse.data;
        displayIntegrations(currentIntegrations);
      }
    } catch (error) {
      console.error('Error loading system settings:', error);
    }
  }
  
  // Display system settings in the form
  function displaySystemSettings(settings) {
    document.getElementById('app-name').value = settings.appName || '';
    document.getElementById('org-name').value = settings.organizationName || '';
    document.getElementById('timezone').value = settings.timezone || 'Europe/Berlin';
    document.getElementById('date-format').value = settings.dateFormat || 'DD/MM/YYYY';
    document.getElementById('currency').value = settings.currency || 'EUR';
    document.getElementById('fiscal-year-start').value = settings.fiscalYearStart || '1';
    document.getElementById('language').value = settings.language || 'en';
    document.getElementById('session-timeout').value = settings.sessionTimeout || 30;
    document.getElementById('auto-backup').checked = settings.autoBackup || false;
    document.getElementById('maintenance-mode').checked = settings.maintenanceMode || false;
    document.getElementById('backup-frequency').value = settings.backupFrequency || 'weekly';
    document.getElementById('max-login-attempts').value = settings.maxLoginAttempts || 5;
    document.getElementById('password-min-length').value = settings.passwordMinLength || 8;
    document.getElementById('require-email-verification').checked = settings.requireEmailVerification || false;
    document.getElementById('enforce-strong-passwords').checked = settings.enforceStrongPasswords || false;
    document.getElementById('allow-public-registration').checked = settings.allowPublicRegistration || false;
  }
  
  // Display email settings
  function displayEmailSettings(settings) {
    document.getElementById('email-enabled').checked = settings.enabled || false;
    toggleEmailSettings();
    
    if (settings.smtp) {
      document.getElementById('smtp-host').value = settings.smtp.host || '';
      document.getElementById('smtp-port').value = settings.smtp.port || 587;
      document.getElementById('smtp-username').value = settings.smtp.username || '';
      document.getElementById('smtp-password').value = settings.smtp.password || '';
      document.getElementById('smtp-secure').checked = settings.smtp.secure || false;
    }
    
    document.getElementById('from-email').value = settings.fromEmail || '';
    document.getElementById('from-name').value = settings.fromName || '';
    
    if (settings.notifications) {
      document.getElementById('notify-new-expense').checked = settings.notifications.newExpense || false;
      document.getElementById('notify-budget-exceeded').checked = settings.notifications.budgetExceeded || false;
      document.getElementById('notify-weekly-report').checked = settings.notifications.weeklyReport || false;
      document.getElementById('notify-monthly-report').checked = settings.notifications.monthlyReport || false;
    }
  }
  
  // Display integrations
  function displayIntegrations(integrations) {
    // Google Sheets
    if (integrations.googleSheets) {
      document.getElementById('google-sheets-enabled').checked = integrations.googleSheets.enabled || false;
      document.getElementById('google-sheets-api-key').value = integrations.googleSheets.apiKey || '';
      document.getElementById('google-sheets-id').value = integrations.googleSheets.sheetId || '';
      toggleIntegration('google-sheets');
    }
    
    // Slack
    if (integrations.slack) {
      document.getElementById('slack-enabled').checked = integrations.slack.enabled || false;
      document.getElementById('slack-webhook-url').value = integrations.slack.webhookUrl || '';
      toggleIntegration('slack');
    }
    
    // QuickBooks
    if (integrations.quickbooks) {
      document.getElementById('quickbooks-enabled').checked = integrations.quickbooks.enabled || false;
      document.getElementById('quickbooks-client-id').value = integrations.quickbooks.clientId || '';
      document.getElementById('quickbooks-client-secret').value = integrations.quickbooks.clientSecret || '';
      toggleIntegration('quickbooks');
    }
  }
  
  // Save system settings
  window.saveSystemSettings = async function() {
    try {
      // Gather system settings
      const systemSettings = {
        appName: document.getElementById('app-name').value,
        organizationName: document.getElementById('org-name').value,
        timezone: document.getElementById('timezone').value,
        dateFormat: document.getElementById('date-format').value,
        currency: document.getElementById('currency').value,
        fiscalYearStart: parseInt(document.getElementById('fiscal-year-start').value),
        language: document.getElementById('language').value,
        sessionTimeout: parseInt(document.getElementById('session-timeout').value),
        autoBackup: document.getElementById('auto-backup').checked,
        backupFrequency: document.getElementById('backup-frequency').value,
        maintenanceMode: document.getElementById('maintenance-mode').checked,
        maxLoginAttempts: parseInt(document.getElementById('max-login-attempts').value),
        passwordMinLength: parseInt(document.getElementById('password-min-length').value),
        requireEmailVerification: document.getElementById('require-email-verification').checked,
        enforceStrongPasswords: document.getElementById('enforce-strong-passwords').checked,
        allowPublicRegistration: document.getElementById('allow-public-registration').checked,
      };
      
      // Save system settings
      const sysResponse = await window.callApi('/system-settings', {
        method: 'PUT',
        body: JSON.stringify(systemSettings)
      });
      
      // Gather email settings
      const emailSettings = {
        enabled: document.getElementById('email-enabled').checked,
        provider: 'smtp',
        smtp: {
          host: document.getElementById('smtp-host').value,
          port: parseInt(document.getElementById('smtp-port').value),
          secure: document.getElementById('smtp-secure').checked,
          username: document.getElementById('smtp-username').value,
          password: document.getElementById('smtp-password').value,
        },
        fromEmail: document.getElementById('from-email').value,
        fromName: document.getElementById('from-name').value,
        replyTo: document.getElementById('from-email').value,
        notifications: {
          newExpense: document.getElementById('notify-new-expense').checked,
          budgetExceeded: document.getElementById('notify-budget-exceeded').checked,
          weeklyReport: document.getElementById('notify-weekly-report').checked,
          monthlyReport: document.getElementById('notify-monthly-report').checked,
        }
      };
      
      // Save email settings
      const emailResponse = await window.callApi('/email-settings', {
        method: 'PUT',
        body: JSON.stringify(emailSettings)
      });
      
      // Gather integration settings
      const integrations = {
        googleSheets: {
          enabled: document.getElementById('google-sheets-enabled').checked,
          apiKey: document.getElementById('google-sheets-api-key').value,
          sheetId: document.getElementById('google-sheets-id').value,
        },
        slack: {
          enabled: document.getElementById('slack-enabled').checked,
          webhookUrl: document.getElementById('slack-webhook-url').value,
        },
        quickbooks: {
          enabled: document.getElementById('quickbooks-enabled').checked,
          clientId: document.getElementById('quickbooks-client-id').value,
          clientSecret: document.getElementById('quickbooks-client-secret').value,
        },
        xero: {enabled: false, clientId: '', clientSecret: ''},
        zapier: {enabled: false, apiKey: ''},
        webhooks: []
      };
      
      // Save integrations
      const intResponse = await window.callApi('/integrations', {
        method: 'PUT',
        body: JSON.stringify(integrations)
      });
      
      if (sysResponse.success && emailResponse.success && intResponse.success) {
        alert('System settings saved successfully');
      } else {
        alert('Some settings failed to save. Please try again.');
      }
    } catch (error) {
      console.error('Error saving system settings:', error);
      alert('Failed to save system settings');
    }
  };
  
  // Toggle email settings visibility
  window.toggleEmailSettings = function() {
    const enabled = document.getElementById('email-enabled').checked;
    document.getElementById('email-settings-group').style.display = enabled ? 'block' : 'none';
  };
  
  // Toggle integration settings
  window.toggleIntegration = function(integration) {
    const enabled = document.getElementById(`${integration}-enabled`).checked;
    document.getElementById(`${integration}-settings`).style.display = enabled ? 'block' : 'none';
  };
  
  // Test email settings
  window.testEmailSettings = async function() {
    const testEmail = prompt('Enter email address to send test to:');
    if (!testEmail) return;
    
    try {
      const response = await window.callApi('/test-email', {
        method: 'POST',
        body: JSON.stringify({testEmail})
      });
      
      alert(response.message || 'Test email sent');
    } catch (error) {
      console.error('Error testing email:', error);
      alert('Failed to send test email');
    }
  };
  
  // Export all data
  window.exportAllData = async function() {
    try {
      const response = await window.callApi('/export-data', {
        method: 'POST',
        body: JSON.stringify({format: 'json'})
      });
      
      if (response.success) {
        // Download JSON file
        const blob = new Blob([JSON.stringify(response.data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `budget-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
    } catch (error) {
      console.error('Error exporting data:', error);
      alert('Failed to export data');
    }
  };
  
  // Import data
  window.importData = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (confirm('Are you sure you want to import this data? This may overwrite existing data.')) {
          const response = await window.callApi('/import-data', {
            method: 'POST',
            body: JSON.stringify({data, mergeMode: 'replace'})
          });
          
          if (response.success) {
            alert('Data import started. This may take a few minutes.');
          }
        }
      } catch (error) {
        console.error('Error importing data:', error);
        alert('Failed to import data. Please check the file format.');
      }
    };
    input.click();
  };
  
  // Export system configuration
  window.exportSystemConfig = function() {
    const config = {
      system: currentSystemSettings,
      email: currentEmailSettings,
      integrations: currentIntegrations,
      exportDate: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system-config-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };
  
  // Create manual backup
  window.createManualBackup = async function() {
    if (confirm('Create a backup of all data now?')) {
      try {
        await exportAllData();
        alert('Backup created successfully');
      } catch (error) {
        alert('Failed to create backup');
      }
    }
  };
  
  // Connect QuickBooks
  window.connectQuickBooks = function() {
    alert('QuickBooks OAuth connection would open here in production');
  };
  
  // Initialize system settings on tab switch
  if (!window.systemSettingsInitialized) {
    window.systemSettingsInitialized = true;
    // Load settings when System tab is clicked
    document.addEventListener('DOMContentLoaded', () => {
      const systemTabButton = document.querySelector('[data-tab="system"]');
      if (systemTabButton) {
        systemTabButton.addEventListener('click', () => {
          if (!currentSystemSettings.appName) {
            loadSystemSettings();
          }
        });
      }
    });
  }
  
  // ============================================================================
  // UTILITY FUNCTIONS
  // ============================================================================
  
  // Load modal helper
  function loadModal(modalPath, callback) {
    fetch(modalPath)
      .then(response => response.text())
      .then(html => {
        // Check if modal is already loaded
        const modalId = modalPath.split('/').pop().replace('.html', '');
        if (!document.getElementById(modalId + 'Modal')) {
          // Add modal to page
          const modalContainer = document.createElement('div');
          modalContainer.innerHTML = html;
          document.body.appendChild(modalContainer);
          
          // Execute any scripts in the modal
          const scripts = modalContainer.getElementsByTagName('script');
          for (let script of scripts) {
            eval(script.innerHTML);
          }
        }
        
        if (callback) callback();
      })
      .catch(error => {
        console.error('Error loading modal:', error);
      });
  }
  
  // Register page initializer
  window.registerPageInitializer('settings', window.initializeSettingsPage);
})();
</script>