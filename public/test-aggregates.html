<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Aggregation System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-success:hover {
            background: #059669;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .output {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 6px;
            font-weight: 500;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Aggregation System Test</h1>
        
        <div class="status info" id="status">
            Ready to test the new aggregation system
        </div>
        
        <div class="button-group">
            <button class="btn-primary" onclick="checkStatus()">Check Status</button>
            <button class="btn-success" onclick="rebuildAggregates()">Rebuild Aggregates</button>
            <button class="btn-warning" onclick="testReportGeneration()">Test Report Generation</button>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="monthly-count">0</div>
                <div class="stat-label">Monthly Aggregates</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ytd-count">0</div>
                <div class="stat-label">YTD Aggregates</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="response-time">0ms</div>
                <div class="stat-label">Response Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="query-count">0</div>
                <div class="stat-label">Queries Used</div>
            </div>
        </div>
        
        <div class="output" id="output"></div>
    </div>

    <script>
        const API_URL = '/api';
        const mockUserId = 'test-admin-user-001';
        
        function log(message, data = null) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            let text = `[${timestamp}] ${message}`;
            if (data) {
                text += '\n' + JSON.stringify(data, null, 2);
            }
            output.textContent += text + '\n\n';
            output.scrollTop = output.scrollHeight;
        }
        
        function setStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        async function checkStatus() {
            setStatus('Checking aggregate status...', 'info');
            log('Checking aggregate status...');
            
            try {
                const response = await fetch(`${API_URL}/admin/aggregate-status`, {
                    headers: {
                        'x-user-id': mockUserId,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    setStatus('Status check complete', 'success');
                    log('Aggregate Status:', data.data);
                    
                    // Update stats
                    document.getElementById('stats').style.display = 'grid';
                    document.getElementById('monthly-count').textContent = data.data.monthlyAggregates.count;
                    document.getElementById('ytd-count').textContent = data.data.ytdAggregates.count;
                    
                    if (data.data.status === 'not_initialized') {
                        setStatus('Aggregates not initialized. Click "Rebuild Aggregates" to initialize.', 'warning');
                    }
                } else {
                    setStatus('Status check failed', 'error');
                    log('Error:', data.error);
                }
            } catch (error) {
                setStatus('Network error', 'error');
                log('Error:', error.message);
            }
        }
        
        async function rebuildAggregates() {
            setStatus('Rebuilding aggregates... This may take a moment.', 'info');
            log('Starting aggregate rebuild...');
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${API_URL}/admin/rebuild-aggregates`, {
                    method: 'POST',
                    headers: {
                        'x-user-id': mockUserId,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                if (data.success) {
                    setStatus(`Aggregates rebuilt successfully in ${duration}ms`, 'success');
                    log('Rebuild complete:', data.data);
                    
                    // Update stats
                    document.getElementById('stats').style.display = 'grid';
                    document.getElementById('monthly-count').textContent = data.data.monthlyAggregates;
                    document.getElementById('ytd-count').textContent = data.data.ytdAggregates;
                    document.getElementById('response-time').textContent = `${duration}ms`;
                } else {
                    setStatus('Rebuild failed', 'error');
                    log('Error:', data.error);
                }
            } catch (error) {
                setStatus('Network error', 'error');
                log('Error:', error.message);
            }
        }
        
        async function testReportGeneration() {
            const year = new Date().getFullYear();
            const month = new Date().getMonth() + 1;
            
            setStatus(`Testing report generation for ${month}/${year}...`, 'info');
            log(`Generating report for ${month}/${year}...`);
            
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${API_URL}/reports/generate/${year}/${month}`, {
                    headers: {
                        'x-user-id': mockUserId,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                if (data.success) {
                    setStatus(`Report generated in ${duration}ms`, 'success');
                    
                    // Extract performance metrics
                    const perf = data.data._performance || {};
                    
                    // Update stats
                    document.getElementById('stats').style.display = 'grid';
                    document.getElementById('response-time').textContent = `${perf.responseTime || duration}ms`;
                    document.getElementById('query-count').textContent = perf.queries || 'N/A';
                    
                    // Log summary
                    log('Report Generation Summary:', {
                        month: data.data.month,
                        year: data.data.year,
                        totalBudget: data.data.totalBudget,
                        totalSpent: data.data.totalSpent,
                        categoriesCount: Object.keys(data.data.categories || {}).length,
                        ytdMonths: data.data.ytdData ? data.data.ytdData.length : 0,
                        performance: perf
                    });
                    
                    // Show improvement
                    if (perf.method === 'aggregates') {
                        log(`ðŸŽ‰ Performance Improvement: ${perf.queries} queries vs 46+ in old system!`);
                    }
                } else {
                    setStatus('Report generation failed', 'error');
                    log('Error:', data.error);
                }
            } catch (error) {
                setStatus('Network error', 'error');
                log('Error:', error.message);
            }
        }
        
        // Auto-check status on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Aggregation System Test Tool Loaded');
            log('This tool tests the new scalable report generation system');
            checkStatus();
        });
    </script>
</body>
</html>