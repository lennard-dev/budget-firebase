<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Auth Test - Budget Management</title>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script defer src="/__/firebase/12.1.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script defer src="/__/firebase/12.1.0/firebase-auth-compat.js"></script>
    <!-- Initialize Firebase -->
    <script defer src="/__/firebase/init.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #666; font-size: 18px; margin-top: 0; }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background: #357ae8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { margin: 4px 0; padding: 4px; }
        .log-info { color: #0066cc; }
        .log-success { color: #008800; background: #f0fff0; }
        .log-error { color: #cc0000; background: #fff0f0; }
        .log-warn { color: #ff6600; }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .user-info {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        code {
            background: #f4f4f4;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîê Firebase Authentication Test</h1>
        <p>This page helps diagnose authentication issues with your Firebase setup.</p>
    </div>

    <div class="card">
        <h2>Current Status</h2>
        <div id="status" class="status info">Initializing Firebase...</div>
        <div id="user-info" style="display:none;" class="user-info"></div>
    </div>

    <div class="card">
        <h2>Actions</h2>
        <button id="btn-signin-popup" disabled>Sign In (Popup)</button>
        <button id="btn-signin-redirect" disabled>Sign In (Redirect)</button>
        <button id="btn-signout" disabled>Sign Out</button>
        <button id="btn-refresh-token" disabled>Refresh Token</button>
        <button id="btn-check-persistence" disabled>Check Persistence</button>
        <button id="btn-clear-cache" disabled>Clear Cache & Reload</button>
    </div>

    <div class="card">
        <h2>Configuration</h2>
        <div id="config-info"></div>
    </div>

    <div class="card">
        <h2>Debug Log</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[AUTH TEST] ${message}`);
        };

        const updateStatus = (message, type = 'info') => {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        };

        const updateUserInfo = (user) => {
            const userInfoEl = document.getElementById('user-info');
            if (user) {
                userInfoEl.innerHTML = `
                    <strong>Signed in as:</strong><br>
                    Email: ${user.email}<br>
                    UID: ${user.uid}<br>
                    Provider: ${user.providerData[0]?.providerId || 'Unknown'}<br>
                    Email Verified: ${user.emailVerified}<br>
                    Last Sign-In: ${user.metadata.lastSignInTime}
                `;
                userInfoEl.style.display = 'block';
            } else {
                userInfoEl.style.display = 'none';
            }
        };

        const enableButtons = (enabled) => {
            document.querySelectorAll('button').forEach(btn => {
                if (btn.id !== 'btn-clear-cache') {
                    btn.disabled = !enabled;
                }
            });
        };

        document.addEventListener('DOMContentLoaded', async () => {
            log('DOM loaded, waiting for Firebase...', 'info');
            
            // Wait for Firebase to load
            let attempts = 0;
            while (!window.firebase && attempts < 30) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            
            if (!window.firebase) {
                log('Firebase failed to load after 3 seconds', 'error');
                updateStatus('Firebase failed to load', 'error');
                return;
            }
            
            log('Firebase loaded successfully', 'success');
            
            try {
                const auth = firebase.auth();
                log('Firebase Auth initialized', 'success');
                
                // Display config
                const configEl = document.getElementById('config-info');
                configEl.innerHTML = `
                    <code>Auth Domain: ${auth.app.options.authDomain || 'Not configured'}</code><br>
                    <code>Project ID: ${auth.app.options.projectId || 'Not configured'}</code><br>
                    <code>Current Domain: ${window.location.hostname}</code><br>
                    <code>Protocol: ${window.location.protocol}</code>
                `;
                
                // Set up auth state listener
                auth.onAuthStateChanged((user) => {
                    log(`Auth state changed: ${user ? user.email : 'null'}`, user ? 'success' : 'info');
                    updateUserInfo(user);
                    
                    if (user) {
                        updateStatus(`Signed in as ${user.email}`, 'success');
                        document.getElementById('btn-signin-popup').disabled = true;
                        document.getElementById('btn-signin-redirect').disabled = true;
                        document.getElementById('btn-signout').disabled = false;
                        document.getElementById('btn-refresh-token').disabled = false;
                    } else {
                        updateStatus('Not signed in', 'info');
                        document.getElementById('btn-signin-popup').disabled = false;
                        document.getElementById('btn-signin-redirect').disabled = false;
                        document.getElementById('btn-signout').disabled = true;
                        document.getElementById('btn-refresh-token').disabled = true;
                    }
                });
                
                // Check for redirect result
                try {
                    log('Checking for redirect result...', 'info');
                    const result = await auth.getRedirectResult();
                    if (result.user) {
                        log(`Redirect sign-in successful: ${result.user.email}`, 'success');
                    } else {
                        log('No redirect result found', 'info');
                    }
                } catch (e) {
                    log(`Redirect check error: ${e.message}`, 'error');
                }
                
                // Set persistence
                try {
                    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    log('Persistence set to LOCAL', 'success');
                } catch (e) {
                    log(`Failed to set persistence: ${e.message}`, 'error');
                }
                
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // Sign in with popup
                document.getElementById('btn-signin-popup').addEventListener('click', async () => {
                    log('Attempting popup sign-in...', 'info');
                    try {
                        const result = await auth.signInWithPopup(provider);
                        log(`Popup sign-in successful: ${result.user.email}`, 'success');
                    } catch (e) {
                        log(`Popup sign-in failed: ${e.code} - ${e.message}`, 'error');
                    }
                });
                
                // Sign in with redirect
                document.getElementById('btn-signin-redirect').addEventListener('click', async () => {
                    log('Initiating redirect sign-in...', 'info');
                    try {
                        await auth.signInWithRedirect(provider);
                    } catch (e) {
                        log(`Redirect sign-in failed: ${e.code} - ${e.message}`, 'error');
                    }
                });
                
                // Sign out
                document.getElementById('btn-signout').addEventListener('click', async () => {
                    log('Signing out...', 'info');
                    try {
                        await auth.signOut();
                        log('Sign out successful', 'success');
                    } catch (e) {
                        log(`Sign out failed: ${e.message}`, 'error');
                    }
                });
                
                // Refresh token
                document.getElementById('btn-refresh-token').addEventListener('click', async () => {
                    const user = auth.currentUser;
                    if (user) {
                        try {
                            const token = await user.getIdToken(true);
                            log(`Token refreshed successfully (length: ${token.length})`, 'success');
                        } catch (e) {
                            log(`Token refresh failed: ${e.message}`, 'error');
                        }
                    }
                });
                
                // Check persistence
                document.getElementById('btn-check-persistence').addEventListener('click', () => {
                    const persistence = auth.currentUser ? 'User persisted' : 'No persisted user';
                    log(`Persistence check: ${persistence}`, 'info');
                    
                    // Check local storage
                    const keys = Object.keys(localStorage).filter(k => k.includes('firebase'));
                    log(`Firebase keys in localStorage: ${keys.length > 0 ? keys.join(', ') : 'None'}`, 'info');
                    
                    // Check session storage
                    const sessionKeys = Object.keys(sessionStorage).filter(k => k.includes('firebase'));
                    log(`Firebase keys in sessionStorage: ${sessionKeys.length > 0 ? sessionKeys.join(', ') : 'None'}`, 'info');
                });
                
                // Clear cache
                document.getElementById('btn-clear-cache').addEventListener('click', () => {
                    if (confirm('This will clear all local data and reload the page. Continue?')) {
                        localStorage.clear();
                        sessionStorage.clear();
                        log('Cache cleared, reloading...', 'warn');
                        setTimeout(() => location.reload(), 500);
                    }
                });
                
                enableButtons(true);
                document.getElementById('btn-clear-cache').disabled = false;
                
                updateStatus('Firebase Auth ready', 'success');
                log('All systems ready', 'success');
                
            } catch (e) {
                log(`Initialization error: ${e.message}`, 'error');
                updateStatus('Initialization failed', 'error');
            }
        });
    </script>
</body>
</html>
