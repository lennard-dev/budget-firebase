<div id="void-transaction-modal" class="modal">
  <div class="modal-content modal-void-confirm">
    <div class="modal-header">
      <h2>‚ö†Ô∏è Void Transaction</h2>
      <button class="modal-close" onclick="closeModal('void-transaction-modal')" aria-label="Close">
        <span>√ó</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="void-warning">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <div class="warning-text">
          <h3>Void this transaction?</h3>
          <p>Voiding will zero out the amount but keep the record for audit purposes.</p>
        </div>
      </div>
      
      <!-- Transaction Details -->
      <div class="transaction-details">
        <h4>Transaction Details:</h4>
        <div id="void-transaction-info" class="info-grid">
          <!-- Populated dynamically -->
        </div>
      </div>
      
      <!-- Void vs Delete Explanation -->
      <div class="void-explanation">
        <h4>Void vs Delete:</h4>
        <div class="comparison-grid">
          <div class="comparison-item void-option">
            <div class="option-header">
              <span class="option-icon">üö´</span>
              <span class="option-title">Void</span>
            </div>
            <ul class="option-benefits">
              <li>Keeps transaction record</li>
              <li>Maintains audit trail</li>
              <li>Shows in reports as voided</li>
              <li>Can be unvoided if needed</li>
            </ul>
          </div>
          <div class="comparison-item delete-option">
            <div class="option-header">
              <span class="option-icon">üóëÔ∏è</span>
              <span class="option-title">Delete</span>
            </div>
            <ul class="option-benefits">
              <li>Completely removes record</li>
              <li>Cannot be recovered</li>
              <li>Better for data entry errors</li>
              <li>Recalculates all balances</li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Void Reason -->
      <div class="void-reason-section">
        <h4>Reason for Voiding:</h4>
        <select id="void-reason-select" class="form-control">
          <option value="">Select a reason...</option>
          <option value="cancelled">Transaction Cancelled</option>
          <option value="duplicate">Duplicate Entry</option>
          <option value="error">Data Entry Error</option>
          <option value="refunded">Refunded by Vendor</option>
          <option value="disputed">Disputed Charge</option>
          <option value="other">Other (specify below)</option>
        </select>
        <textarea id="void-reason-notes" class="form-control" rows="3" 
                  placeholder="Additional details..." style="margin-top: 8px;"></textarea>
      </div>
      
      <!-- Balance Impact Preview -->
      <div class="balance-impact-section">
        <h4>Balance Impact:</h4>
        <div id="void-balance-impact" class="impact-preview">
          <!-- Populated dynamically -->
        </div>
      </div>
      
      <!-- Reconciliation Warning -->
      <div id="reconciliation-warning" class="reconciliation-warning" style="display: none;">
        <div class="recon-icon">üîí</div>
        <div class="recon-text">
          <strong>Reconciliation Warning:</strong>
          <span id="reconciliation-message"></span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('void-transaction-modal')">Cancel</button>
      <button class="btn btn-danger" onclick="chooseDeleteInstead()" id="delete-instead-btn">
        Delete Instead
      </button>
      <button class="btn btn-warning" onclick="confirmVoid()" id="confirm-void-btn">
        Void Transaction
      </button>
    </div>
  </div>
</div>

<style>
.modal-void-confirm {
  background-color: #fff;
  margin: 5% auto;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  max-width: 600px;
  width: 90%;
  overflow: hidden;
}

.modal-void-confirm .modal-header {
  background: #fff3cd;
  border-bottom: 1px solid #ffc107;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
}

.modal-void-confirm .modal-header h2 {
  color: #856404;
  font-size: 18px;
  margin: 0;
}

.void-warning {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 20px;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 6px;
  margin-bottom: 20px;
}

.warning-icon {
  font-size: 32px;
  flex-shrink: 0;
}

.warning-text h3 {
  margin: 0 0 8px 0;
  color: #856404;
  font-size: 16px;
}

.warning-text p {
  margin: 0;
  color: #856404;
  font-size: 14px;
}

.transaction-details {
  margin-bottom: 20px;
}

.transaction-details h4 {
  color: #495057;
  font-size: 14px;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.info-grid {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 8px;
  background: #f8f9fa;
  padding: 12px;
  border-radius: 4px;
  font-size: 13px;
}

.info-label {
  color: #6c757d;
  font-weight: 500;
}

.info-value {
  color: #212529;
}

.void-explanation {
  margin-bottom: 20px;
}

.void-explanation h4 {
  color: #495057;
  font-size: 14px;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.comparison-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.comparison-item {
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  padding: 16px;
  background: #f8f9fa;
}

.void-option {
  border-color: #ffc107;
  background: #fff3cd;
}

.delete-option {
  border-color: #dc3545;
  background: #fee;
}

.option-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.option-icon {
  font-size: 20px;
}

.option-title {
  font-weight: 600;
  font-size: 16px;
  color: #495057;
}

.option-benefits {
  margin: 0;
  padding-left: 16px;
  font-size: 13px;
  color: #6c757d;
}

.option-benefits li {
  margin-bottom: 4px;
}

.void-reason-section {
  margin-bottom: 20px;
}

.void-reason-section h4 {
  color: #495057;
  font-size: 14px;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.balance-impact-section {
  margin-bottom: 20px;
}

.balance-impact-section h4 {
  color: #495057;
  font-size: 14px;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.impact-preview {
  background: #e8f0fe;
  border: 1px solid #1a73e8;
  border-radius: 4px;
  padding: 12px;
}

.impact-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 13px;
}

.impact-item:last-child {
  margin-bottom: 0;
}

.impact-label {
  color: #495057;
}

.impact-value {
  font-weight: 600;
}

.impact-value.positive {
  color: #28a745;
}

.impact-value.negative {
  color: #dc3545;
}

.reconciliation-warning {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #fee;
  border: 1px solid #dc3545;
  border-radius: 4px;
  margin-bottom: 20px;
}

.recon-icon {
  font-size: 24px;
}

.recon-text {
  font-size: 14px;
  color: #721c24;
}

.modal-void-confirm .modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid #e8eaed;
  background: #f8f9fa;
}

.btn-warning {
  background-color: #ffc107;
  color: #212529;
  border: none;
}

.btn-warning:hover:not(:disabled) {
  background-color: #e0a800;
}

.btn-warning:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
  opacity: 0.65;
}

@media (max-width: 600px) {
  .comparison-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
(function() {
  let pendingVoid = null;
  
  // Open void confirmation modal
  window.openVoidConfirmation = async function(transactionId, transactionType, transactionData) {
    console.log('Opening void confirmation for:', transactionId, transactionType);
    
    pendingVoid = {
      id: transactionId,
      type: transactionType,
      data: transactionData
    };
    
    // Populate transaction details
    const infoEl = document.getElementById('void-transaction-info');
    let infoHTML = '';
    
    if (transactionType === 'expense') {
      infoHTML = `
        <span class="info-label">Date:</span>
        <span class="info-value">${transactionData.date}</span>
        <span class="info-label">Amount:</span>
        <span class="info-value">‚Ç¨${transactionData.amount.toFixed(2)}</span>
        <span class="info-label">Category:</span>
        <span class="info-value">${transactionData.category} - ${transactionData.subcategory}</span>
        <span class="info-label">Payment:</span>
        <span class="info-value">${transactionData.paymentMethod}</span>
        <span class="info-label">Description:</span>
        <span class="info-value">${transactionData.description || 'N/A'}</span>
      `;
    } else {
      infoHTML = `
        <span class="info-label">Date:</span>
        <span class="info-value">${transactionData.date}</span>
        <span class="info-label">Amount:</span>
        <span class="info-value">‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
        <span class="info-label">Type:</span>
        <span class="info-value">${transactionData.type}</span>
        <span class="info-label">Description:</span>
        <span class="info-value">${transactionData.description || 'N/A'}</span>
      `;
    }
    
    infoEl.innerHTML = infoHTML;
    
    // Calculate void impact
    calculateVoidImpact(transactionData, transactionType);
    
    // Check reconciliation status
    await checkReconciliationStatus(transactionId, transactionType);
    
    // Show modal
    document.getElementById('void-transaction-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
  };
  
  // Calculate void impact
  function calculateVoidImpact(transactionData, transactionType) {
    const impactEl = document.getElementById('void-balance-impact');
    
    let impactHTML = `
      <div class="impact-item">
        <span class="impact-label">Current Amount:</span>
        <span class="impact-value">‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
      </div>
      <div class="impact-item">
        <span class="impact-label">After Voiding:</span>
        <span class="impact-value">‚Ç¨0.00</span>
      </div>
    `;
    
    // Determine which balances will be affected
    if (transactionType === 'expense') {
      if (transactionData.paymentMethod === 'Cash') {
        impactHTML += `
          <div class="impact-item">
            <span class="impact-label">Cash Balance Change:</span>
            <span class="impact-value positive">+‚Ç¨${transactionData.amount.toFixed(2)}</span>
          </div>
          <div class="impact-item">
            <span class="impact-label">Effect:</span>
            <span class="impact-value">Money restored to cash</span>
          </div>
        `;
      } else if (transactionData.paymentMethod === 'Card' || transactionData.paymentMethod === 'Bank Transfer') {
        impactHTML += `
          <div class="impact-item">
            <span class="impact-label">Bank Balance Change:</span>
            <span class="impact-value positive">+‚Ç¨${transactionData.amount.toFixed(2)}</span>
          </div>
          <div class="impact-item">
            <span class="impact-label">Effect:</span>
            <span class="impact-value">Money restored to bank</span>
          </div>
        `;
      }
    } else {
      // Cash movement impacts
      switch(transactionData.type) {
        case 'withdrawal':
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">Cash Balance:</span>
              <span class="impact-value negative">-‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
            <div class="impact-item">
              <span class="impact-label">Bank Balance:</span>
              <span class="impact-value positive">+‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
          `;
          break;
        case 'deposit':
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">Cash Balance:</span>
              <span class="impact-value positive">+‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
            <div class="impact-item">
              <span class="impact-label">Bank Balance:</span>
              <span class="impact-value negative">-‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
          `;
          break;
        case 'donation':
          const account = transactionData.toBank ? 'Bank' : 'Cash';
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">${account} Balance:</span>
              <span class="impact-value negative">-‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
          `;
          break;
      }
    }
    
    impactHTML += `
      <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #dee2e6;">
        <strong style="color: #856404;">Note:</strong> Voided transaction will remain in records but with ‚Ç¨0.00 amount.
      </div>
    `;
    
    impactEl.innerHTML = impactHTML;
  }
  
  // Check reconciliation status
  async function checkReconciliationStatus(transactionId, transactionType) {
    const warningEl = document.getElementById('reconciliation-warning');
    const messageEl = document.getElementById('reconciliation-message');
    
    try {
      if (window.ReconciliationManager) {
        const canEdit = await window.ReconciliationManager.canEditTransaction(transactionId, transactionType);
        
        if (!canEdit.canEdit && canEdit.reason === 'Transaction is reconciled') {
          warningEl.style.display = 'flex';
          messageEl.textContent = `This transaction is reconciled (${canEdit.reconciledDate}). Voiding will break the reconciliation.`;
        } else {
          warningEl.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('Failed to check reconciliation status:', error);
    }
  }
  
  // Confirm void
  window.confirmVoid = async function() {
    if (!pendingVoid) {
      console.error('No pending void');
      return;
    }
    
    const confirmBtn = document.getElementById('confirm-void-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Voiding...';
    
    try {
      // Get void reason
      const reasonSelect = document.getElementById('void-reason-select');
      const reasonNotes = document.getElementById('void-reason-notes');
      
      if (!reasonSelect.value) {
        alert('Please select a reason for voiding');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Void Transaction';
        return;
      }
      
      let voidReason = reasonSelect.value;
      if (reasonNotes.value.trim()) {
        voidReason += ': ' + reasonNotes.value.trim();
      }
      
      // Check if reconciled and handle
      if (window.ReconciliationManager) {
        const canEdit = await window.ReconciliationManager.canEditTransaction(
          pendingVoid.id, 
          pendingVoid.type
        );
        
        if (!canEdit.canEdit && canEdit.reason === 'Transaction is reconciled') {
          if (!confirm('This transaction is reconciled. Voiding will break the reconciliation. Continue?')) {
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Void Transaction';
            return;
          }
          
          // Un-reconcile first
          await window.ReconciliationManager.unreconcileTransaction(
            pendingVoid.id,
            pendingVoid.type,
            'Un-reconciled for voiding: ' + voidReason
          );
        }
      }
      
      // Void the transaction
      if (window.PendingTransactionManager) {
        confirmBtn.textContent = 'Recalculating balances...';
        const result = await window.PendingTransactionManager.voidTransaction(
          pendingVoid.id,
          pendingVoid.type,
          voidReason
        );
        
        console.log('Void result:', result);
        
        // Close modal
        closeModal('void-transaction-modal');
        
        // Show success message
        alert(`Transaction voided successfully!\nOriginal amount: ‚Ç¨${result.originalAmount.toFixed(2)}\nReason: ${voidReason}`);
        
        // Refresh the current page
        refreshCurrentPage();
      } else {
        throw new Error('Void transaction service not available');
      }
      
      pendingVoid = null;
      
    } catch (error) {
      console.error('Failed to void transaction:', error);
      alert('Failed to void transaction: ' + error.message);
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Void Transaction';
    }
  };
  
  // Choose delete instead
  window.chooseDeleteInstead = function() {
    if (!pendingVoid) return;
    
    // Close void modal
    closeModal('void-transaction-modal');
    
    // Open delete confirmation modal if available
    if (window.openDeleteConfirmation) {
      window.openDeleteConfirmation(pendingVoid.id, pendingVoid.type, pendingVoid.data);
    } else {
      // Fallback to simple confirmation
      if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
        deleteTransactionDirectly(pendingVoid.id, pendingVoid.type);
      }
    }
  };
  
  // Direct deletion fallback
  async function deleteTransactionDirectly(transactionId, transactionType) {
    try {
      if (window.TransactionEditor) {
        const result = await window.TransactionEditor.deleteTransaction(transactionId, transactionType);
        if (result.success) {
          alert(`Transaction deleted! ${result.recalculation.affectedCount} transactions recalculated.`);
          refreshCurrentPage();
        }
      } else {
        const endpoint = transactionType === 'expense' 
          ? `/expenses/${transactionId}`
          : `/cash-movements/${transactionId}`;
        
        const response = await window.callApi(endpoint, { method: 'DELETE' });
        if (response.success) {
          alert('Transaction deleted!');
          refreshCurrentPage();
        }
      }
    } catch (error) {
      console.error('Failed to delete transaction:', error);
      alert('Failed to delete transaction: ' + error.message);
    }
  }
  
  // Refresh current page
  function refreshCurrentPage() {
    if (window.refreshCurrentPage) {
      window.refreshCurrentPage();
    } else if (location.hash === '#expenses' && window.initializeExpensesPage) {
      window.initializeExpensesPage();
    } else if (location.hash === '#cash-banking' && window.initializeCashBankingPage) {
      window.initializeCashBankingPage();
    }
  }
  
  console.log('Void Transaction Modal initialized');
})();
</script>