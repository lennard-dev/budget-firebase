<div id="edit-expense-modal" class="modal">
  <div class="modal-content modal-expense">
    <div class="modal-header">
      <h2>Edit Expense</h2>
      <button class="modal-close" onclick="closeModal('edit-expense-modal')" aria-label="Close">
        <span>√ó</span>
      </button>
    </div>
    <div class="modal-body">
      <form id="edit-expense-form">
        <input type="hidden" id="edit-id" />
        
        <!-- Date Field -->
        <div class="form-group">
          <label class="form-label">Date<span class="required">*</span></label>
          <div class="input-with-icon">
            <input type="date" id="edit-date" class="form-control" required>
            <span class="input-icon">üìÖ</span>
          </div>
        </div>

        <!-- Receipt ID Field -->
        <div class="form-group">
          <label class="form-label">Receipt ID<span class="required">*</span></label>
          <input type="text" id="edit-receipt" class="form-control" placeholder="20250813-001" required>
        </div>

        <!-- Category Field -->
        <div class="form-group">
          <label class="form-label">Category<span class="required">*</span></label>
          <select id="edit-category" class="form-control" required>
            <option value="">Select Category</option>
            <option value="Food">Food</option>
            <option value="Transport">Transport</option>
            <option value="Utilities">Utilities</option>
            <option value="Medical">Medical</option>
            <option value="Education">Education</option>
            <option value="Housing">Housing</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <!-- Subcategory Field -->
        <div class="form-group">
          <label class="form-label">Subcategory<span class="required">*</span></label>
          <select id="edit-subcategory" class="form-control" required>
            <option value="">Select Category First</option>
          </select>
        </div>

        <!-- Description Field -->
        <div class="form-group">
          <label class="form-label">Description<span class="required">*</span></label>
          <textarea id="edit-desc" class="form-control" rows="3" placeholder="Enter expense description..." required></textarea>
        </div>

        <!-- Amount Field -->
        <div class="form-group">
          <label class="form-label">Amount (‚Ç¨)<span class="required">*</span></label>
          <input type="number" id="edit-amount" class="form-control" step="0.01" min="0.01" placeholder="0.00" required>
        </div>

        <!-- Payment Method Field -->
        <div class="form-group">
          <label class="form-label">Payment Method<span class="required">*</span></label>
          <div class="payment-method-buttons">
            <button type="button" class="payment-btn edit-payment-btn" data-method="Cash">
              <span class="payment-icon">üíµ</span>
              <span class="payment-label">Cash</span>
              <span class="payment-sublabel">Pay with cash</span>
            </button>
            <button type="button" class="payment-btn edit-payment-btn" data-method="Card">
              <span class="payment-icon">üí≥</span>
              <span class="payment-label">Card</span>
              <span class="payment-sublabel">Credit/Debit card</span>
            </button>
            <button type="button" class="payment-btn edit-payment-btn" data-method="Bank Transfer">
              <span class="payment-icon">üè¶</span>
              <span class="payment-label">Bank Transfer</span>
              <span class="payment-sublabel">Direct transfer</span>
            </button>
          </div>
          <input type="hidden" id="edit-payment" value="">
        </div>

        <!-- Receipt Upload Field -->
        <div class="form-group">
          <label class="form-label">Receipt/Invoice Upload</label>
          <div class="file-upload-area" id="edit-file-upload-area">
            <input type="file" id="edit-files" class="file-input" accept="image/*,.pdf" multiple>
            <div class="file-upload-content">
              <span class="upload-icon">üìé</span>
              <span class="upload-text">Choose Files</span>
              <span class="upload-subtext">or drag and drop files here</span>
            </div>
            <div class="file-upload-hint">Accepted: Images (JPG, PNG) and PDF files. Max 10MB per file.</div>
          </div>
          <div id="edit-files-preview" class="file-preview"></div>
          <div id="existing-receipts" class="existing-receipts"></div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="deleteCurrentExpense()" style="margin-right: auto;">Delete</button>
      <button class="btn btn-secondary" onclick="closeModal('edit-expense-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditExpense()">Update Expense</button>
    </div>
  </div>
</div>

<style>
/* Existing receipts display */
.existing-receipts {
  margin-top: 12px;
}

.existing-receipts-title {
  font-size: 13px;
  font-weight: 500;
  color: #5f6368;
  margin-bottom: 8px;
}

.existing-receipt-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background-color: #e8f0fe;
  border-radius: 4px;
  margin-bottom: 8px;
}

.existing-receipt-name {
  font-size: 13px;
  color: #1a73e8;
  text-decoration: none;
  flex: 1;
}

.existing-receipt-name:hover {
  text-decoration: underline;
}
</style>

<script>
(function(){
  let editSelectedFiles = [];
  let currentExpenseData = null;
  
  // Initialize modal functions
  window.openEditExpenseModal = function(exp){
    currentExpenseData = exp;
    document.getElementById('edit-id').value = exp.id || '';
    document.getElementById('edit-date').value = (exp.date||'').slice(0,10);
    document.getElementById('edit-amount').value = exp.amount || 0;
    document.getElementById('edit-receipt').value = exp.receiptId || '';
    document.getElementById('edit-category').value = exp.category || '';
    document.getElementById('edit-desc').value = exp.description || '';
    document.getElementById('edit-payment').value = exp.paymentMethod || '';
    
    // Update subcategory dropdown based on category
    updateEditSubcategories(exp.category, exp.subcategory);
    
    // Reset file input
    document.getElementById('edit-files').value = '';
    document.getElementById('edit-files-preview').innerHTML = '';
    editSelectedFiles = [];
    
    // Update payment method selection
    document.querySelectorAll('.edit-payment-btn').forEach(btn => {
      btn.classList.remove('selected');
      if (btn.dataset.method === (exp.paymentMethod || 'Cash')) {
        btn.classList.add('selected');
      }
    });
    
    // Show existing receipts if any
    showExistingReceipts(exp);
    
    // Show modal
    document.getElementById('edit-expense-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
  
  // Payment method button handling for edit modal
  document.querySelectorAll('.edit-payment-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.edit-payment-btn').forEach(b => b.classList.remove('selected'));
      this.classList.add('selected');
      document.getElementById('edit-payment').value = this.dataset.method;
    });
  });
  
  // Category/Subcategory handling
  const subcategories = {
    'Food': ['Groceries', 'Restaurant', 'Takeout', 'Snacks'],
    'Transport': ['Fuel', 'Public Transport', 'Taxi', 'Parking', 'Maintenance'],
    'Utilities': ['Electricity', 'Water', 'Gas', 'Internet', 'Phone'],
    'Medical': ['Doctor', 'Pharmacy', 'Hospital', 'Insurance'],
    'Education': ['Books', 'Courses', 'School Supplies', 'Tuition'],
    'Housing': ['Rent', 'Mortgage', 'Repairs', 'Furniture', 'Cleaning'],
    'Other': ['General', 'Miscellaneous']
  };
  
  function updateEditSubcategories(category, selectedSubcategory) {
    const subcategorySelect = document.getElementById('edit-subcategory');
    subcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
    
    if (category && subcategories[category]) {
      subcategories[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub;
        option.textContent = sub;
        if (sub === selectedSubcategory) {
          option.selected = true;
        }
        subcategorySelect.appendChild(option);
      });
    }
    
    // If subcategory doesn't exist in list, add it as an option
    if (selectedSubcategory && !subcategories[category]?.includes(selectedSubcategory)) {
      const option = document.createElement('option');
      option.value = selectedSubcategory;
      option.textContent = selectedSubcategory;
      option.selected = true;
      subcategorySelect.appendChild(option);
    }
  }
  
  document.getElementById('edit-category').addEventListener('change', function() {
    updateEditSubcategories(this.value);
  });
  
  // File upload handling for edit modal
  const editFileInput = document.getElementById('edit-files');
  const editUploadArea = document.getElementById('edit-file-upload-area');
  const editPreviewArea = document.getElementById('edit-files-preview');
  
  // Click to upload
  editUploadArea.addEventListener('click', function(e) {
    if (e.target !== editFileInput) {
      editFileInput.click();
    }
  });
  
  // Drag and drop
  editUploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
  });
  
  editUploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
  });
  
  editUploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    handleEditFiles(files);
  });
  
  // File input change
  editFileInput.addEventListener('change', function(e) {
    handleEditFiles(this.files);
  });
  
  function handleEditFiles(files) {
    editSelectedFiles = Array.from(files);
    updateEditFilePreview();
  }
  
  function updateEditFilePreview() {
    editPreviewArea.innerHTML = '';
    
    editSelectedFiles.forEach((file, index) => {
      const item = document.createElement('div');
      item.className = 'file-preview-item';
      
      const name = document.createElement('span');
      name.className = 'file-preview-name';
      name.textContent = file.name;
      
      const size = document.createElement('span');
      size.className = 'file-preview-size';
      size.textContent = formatFileSize(file.size);
      
      const removeBtn = document.createElement('button');
      removeBtn.className = 'file-preview-remove';
      removeBtn.innerHTML = '√ó';
      removeBtn.onclick = function() {
        removeEditFile(index);
      };
      
      item.appendChild(name);
      item.appendChild(size);
      item.appendChild(removeBtn);
      editPreviewArea.appendChild(item);
    });
  }
  
  function removeEditFile(index) {
    editSelectedFiles.splice(index, 1);
    updateEditFilePreview();
    
    // Reset file input
    const dt = new DataTransfer();
    editSelectedFiles.forEach(file => dt.items.add(file));
    editFileInput.files = dt.files;
  }
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
  
  async function showExistingReceipts(expense) {
    const container = document.getElementById('existing-receipts');
    container.innerHTML = '';
    
    if (!expense.receiptId) return;
    
    try {
      // Get receipt URLs from the backend
      const response = await window.callApi(`/expenses/${expense.id}/receipts`);
      if (response && response.urls && response.urls.length > 0) {
        const title = document.createElement('div');
        title.className = 'existing-receipts-title';
        title.textContent = 'Existing Receipts:';
        container.appendChild(title);
        
        response.urls.forEach(url => {
          const item = document.createElement('div');
          item.className = 'existing-receipt-item';
          
          const link = document.createElement('a');
          link.className = 'existing-receipt-name';
          link.href = url;
          link.target = '_blank';
          link.textContent = url.split('/').pop().split('?')[0]; // Extract filename
          
          item.appendChild(link);
          container.appendChild(item);
        });
      }
    } catch (e) {
      console.log('Could not load existing receipts:', e);
    }
  }
  
  // Submit edited expense
  window.saveEditExpense = async function(){
    const form = document.getElementById('edit-expense-form');
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    
    const submitBtn = event.target;
    submitBtn.disabled = true;
    submitBtn.textContent = 'Updating...';
    
    try {
      const expenseId = document.getElementById('edit-id').value;
      const updates = {
        date: document.getElementById('edit-date').value,
        amount: Number(document.getElementById('edit-amount').value) || 0,
        receiptId: document.getElementById('edit-receipt').value.trim(),
        category: document.getElementById('edit-category').value.trim(),
        subcategory: document.getElementById('edit-subcategory').value.trim(),
        paymentMethod: document.getElementById('edit-payment').value.trim(),
        description: document.getElementById('edit-desc').value.trim()
      };
      
      // Check if significant changes were made that require balance recalculation
      const needsRecalc = currentExpenseData && (
        currentExpenseData.amount !== updates.amount ||
        currentExpenseData.date !== updates.date ||
        currentExpenseData.paymentMethod !== updates.paymentMethod
      );
      
      if (needsRecalc && window.TransactionEditor) {
        // Use transaction editor for proper balance recalculation
        submitBtn.textContent = 'Recalculating balances...';
        const result = await window.TransactionEditor.editExpense(expenseId, updates);
        
        if (result.recalculation) {
          console.log(`Updated expense and recalculated ${result.recalculation.affectedCount} transactions`);
        }
      } else {
        // Simple update via API
        await window.callApi(`/expenses/${expenseId}`, { 
          method: 'PATCH', 
          body: JSON.stringify(updates) 
        });
      }
      
      // Upload new files if any
      if (editSelectedFiles.length > 0) {
        try {
          const user = window.getCurrentUser && window.getCurrentUser();
          const uid = user?.uid;
          
          if (window.firebase && window.firebase.storage) {
            const storage = firebase.storage();
            const folder = `users/${uid}/receipts/${body.receiptId || body.id}`;
            
            for (const file of editSelectedFiles) {
              await storage.ref().child(`${folder}/${file.name}`).put(file, { contentType: file.type });
            }
          }
        } catch(e) { 
          console.error('Edit receipt upload failed', e);
          alert('Expense updated, but receipt upload failed. You can try again.');
        }
      }
      
      closeModal('edit-expense-modal');
      
      // Refresh if on expenses page
      if (location.hash.replace('#','') === 'expenses' && window.initializeExpensesPage) { 
        window.initializeExpensesPage(); 
      }
    } catch (error) {
      console.error('Failed to update expense:', error);
      alert('Failed to update expense. Please try again.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Update Expense';
    }
  }
  
  // Close modal on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('edit-expense-modal');
      if (modal && modal.style.display === 'block') {
        closeModal('edit-expense-modal');
      }
    }
  });
  
  // Close modal on background click
  document.getElementById('edit-expense-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeModal('edit-expense-modal');
    }
  });
  
  // Delete current expense with confirmation
  window.deleteCurrentExpense = function() {
    if (!currentExpenseData) {
      console.error('No expense data available');
      return;
    }
    
    // Close edit modal first
    closeModal('edit-expense-modal');
    
    // Open delete confirmation modal if available
    if (window.openDeleteConfirmation) {
      window.openDeleteConfirmation(currentExpenseData.id, 'expense', currentExpenseData);
    } else {
      // Fallback to simple confirmation
      if (confirm('Are you sure you want to delete this expense? This will trigger balance recalculation for all subsequent transactions.')) {
        deleteExpenseDirectly(currentExpenseData.id);
      }
    }
  };
  
  // Direct deletion fallback
  async function deleteExpenseDirectly(expenseId) {
    try {
      if (window.TransactionEditor) {
        const result = await window.TransactionEditor.deleteTransaction(expenseId, 'expense');
        if (result.success) {
          alert(`Expense deleted! ${result.recalculation.affectedCount} transactions recalculated.`);
          if (window.initializeExpensesPage) {
            window.initializeExpensesPage();
          }
        }
      } else {
        const response = await window.callApi(`/expenses/${expenseId}`, { method: 'DELETE' });
        if (response.success) {
          alert('Expense deleted!');
          if (window.initializeExpensesPage) {
            window.initializeExpensesPage();
          }
        }
      }
    } catch (error) {
      console.error('Failed to delete expense:', error);
      alert('Failed to delete expense: ' + error.message);
    }
  }
})();
</script>