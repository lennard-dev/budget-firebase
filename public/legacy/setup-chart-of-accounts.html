<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Chart of Accounts - Professional Backend</title>
    <link rel="stylesheet" href="/legacy/shared.css">
    <style>
        body {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .chart-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .chart-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .chart-table tr:hover {
            background: #f9fafb;
        }
        .level-1 {
            font-weight: 600;
            background: #f0f9ff;
        }
        .level-2 {
            padding-left: 40px !important;
        }
        .account-code {
            font-family: monospace;
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .progress {
            background: #fef3c7;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Chart of Accounts Setup</h1>
        <p>Professional accounting backend with frontend-compatible display fields</p>
    </div>

    <div class="section">
        <h2>Current System Status</h2>
        <div id="currentStatus">
            <p>Loading current categories...</p>
        </div>
    </div>

    <div class="section">
        <h2>Actions</h2>
        <button class="btn btn-primary" onclick="setupChartOfAccounts()">
            Setup Chart of Accounts
        </button>
        <button class="btn btn-success" onclick="migrateExistingData()">
            Migrate Existing Categories
        </button>
        <button class="btn btn-danger" onclick="clearAllData()">
            Clear All Data (Dev Only)
        </button>
        <div id="actionStatus"></div>
    </div>

    <div class="section">
        <h2>Default Chart of Accounts (Preview)</h2>
        <table class="chart-table">
            <thead>
                <tr>
                    <th>Account Code</th>
                    <th>Account Name</th>
                    <th>Display As</th>
                    <th>Category Name</th>
                    <th>Subcategory Name</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody id="chartPreview"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDocs, 
            deleteDoc,
            writeBatch,
            serverTimestamp,
            query,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCVLij8nih7vPqLfmxTTrNGDGaY8wJrGBY",
            authDomain: "budget-v01.firebaseapp.com",
            projectId: "budget-v01",
            storageBucket: "budget-v01.firebasestorage.app",
            messagingSenderId: "459584204952",
            appId: "1:459584204952:web:0c1e0f2fb3b1eb37508c52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Use the mock user from shared.js auto-login
        const uid = 'test-user-001';

        // Default Chart of Accounts structure
        const defaultChart = [
            // Hidden Backend Accounts (for proper double-entry)
            { code: '1000', name: 'Cash on Hand', type: 'asset', displayAs: 'hidden', level: 0 },
            { code: '1100', name: 'Bank Account', type: 'asset', displayAs: 'hidden', level: 0 },
            { code: '4000', name: 'Income', type: 'income', displayAs: 'hidden', level: 0 },
            { code: '4010', name: 'Donations', type: 'income', displayAs: 'hidden', level: 1, parent: '4000' },
            { code: '4020', name: 'Grants', type: 'income', displayAs: 'hidden', level: 1, parent: '4000' },
            
            // Expense Categories (What users see)
            // Operations Category
            { 
                code: '5100', 
                name: 'Administrative Expenses', 
                type: 'expense', 
                displayAs: 'category',
                categoryName: 'Operations',
                legacyCategoryId: 'CAT-001',
                level: 1 
            },
            { 
                code: '5110', 
                name: 'Office Supplies', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Operations',
                subcategoryName: 'Office Supplies',
                legacyCategoryId: 'CAT-001',
                legacySubcategoryId: 'SUB-001',
                level: 2,
                parent: '5100'
            },
            { 
                code: '5120', 
                name: 'Administrative Salaries', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Operations',
                subcategoryName: 'Salaries',
                legacyCategoryId: 'CAT-001',
                legacySubcategoryId: 'SUB-002',
                level: 2,
                parent: '5100'
            },
            { 
                code: '5130', 
                name: 'Utilities', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Operations',
                subcategoryName: 'Utilities',
                legacyCategoryId: 'CAT-001',
                legacySubcategoryId: 'SUB-003',
                level: 2,
                parent: '5100'
            },
            
            // Programs Category
            { 
                code: '5000', 
                name: 'Program Expenses', 
                type: 'expense', 
                displayAs: 'category',
                categoryName: 'Programs',
                legacyCategoryId: 'CAT-002',
                level: 1 
            },
            { 
                code: '5010', 
                name: 'Direct Program Costs', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Programs',
                subcategoryName: 'Direct Costs',
                legacyCategoryId: 'CAT-002',
                legacySubcategoryId: 'SUB-004',
                level: 2,
                parent: '5000'
            },
            { 
                code: '5020', 
                name: 'Program Materials', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Programs',
                subcategoryName: 'Materials',
                legacyCategoryId: 'CAT-002',
                legacySubcategoryId: 'SUB-005',
                level: 2,
                parent: '5000'
            },
            
            // Travel Category
            { 
                code: '5200', 
                name: 'Travel Expenses', 
                type: 'expense', 
                displayAs: 'category',
                categoryName: 'Travel',
                legacyCategoryId: 'CAT-003',
                level: 1 
            },
            { 
                code: '5210', 
                name: 'Transportation', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Travel',
                subcategoryName: 'Transportation',
                legacyCategoryId: 'CAT-003',
                legacySubcategoryId: 'SUB-006',
                level: 2,
                parent: '5200'
            },
            { 
                code: '5220', 
                name: 'Lodging', 
                type: 'expense', 
                displayAs: 'subcategory',
                categoryName: 'Travel',
                subcategoryName: 'Accommodation',
                legacyCategoryId: 'CAT-003',
                legacySubcategoryId: 'SUB-007',
                level: 2,
                parent: '5200'
            }
        ];

        // Load current status
        async function loadCurrentStatus() {
            try {
                const categoriesSnap = await getDocs(
                    collection(db, 'users', uid, 'categories')
                );
                
                const accountsSnap = await getDocs(
                    collection(db, 'users', uid, 'chart_of_accounts')
                );
                
                const statusDiv = document.getElementById('currentStatus');
                statusDiv.innerHTML = `
                    <p><strong>Categories Collection:</strong> ${categoriesSnap.size} documents</p>
                    <p><strong>Chart of Accounts:</strong> ${accountsSnap.size} documents</p>
                    ${accountsSnap.size > 0 ? 
                        '<p class="status success">Chart of Accounts already initialized!</p>' : 
                        '<p class="status progress">Chart of Accounts not yet created</p>'
                    }
                `;
                
                // Load preview
                loadChartPreview();
                
            } catch (error) {
                console.error('Error loading status:', error);
                document.getElementById('currentStatus').innerHTML = 
                    '<p class="status error">Error loading status: ' + error.message + '</p>';
            }
        }

        // Load chart preview
        function loadChartPreview() {
            const tbody = document.getElementById('chartPreview');
            tbody.innerHTML = defaultChart.map(account => `
                <tr class="${account.level === 1 ? 'level-1' : 'level-2'}">
                    <td><span class="account-code">${account.code}</span></td>
                    <td>${account.name}</td>
                    <td>${account.displayAs || 'hidden'}</td>
                    <td>${account.categoryName || '-'}</td>
                    <td>${account.subcategoryName || '-'}</td>
                    <td>${account.type}</td>
                </tr>
            `).join('');
        }

        // Setup Chart of Accounts
        window.setupChartOfAccounts = async function() {
            const statusDiv = document.getElementById('actionStatus');
            statusDiv.innerHTML = '<p class="status progress">Setting up Chart of Accounts...</p>';
            
            try {
                const batch = writeBatch(db);
                let count = 0;
                
                for (const account of defaultChart) {
                    const accountDoc = {
                        account_code: account.code,
                        account_name: account.name,
                        account_type: account.type,
                        display_as: account.displayAs || 'hidden',
                        level: account.level,
                        parent_code: account.parent || null,
                        
                        // Frontend compatibility fields
                        category_name: account.categoryName || null,
                        subcategory_name: account.subcategoryName || null,
                        legacy_category_id: account.legacyCategoryId || null,
                        legacy_subcategory_id: account.legacySubcategoryId || null,
                        
                        // Accounting fields
                        normal_balance: account.type === 'expense' || account.type === 'asset' ? 'debit' : 'credit',
                        financial_statement: account.type === 'asset' ? 'balance_sheet' : 'income_statement',
                        is_active: true,
                        system_account: account.displayAs === 'hidden',
                        
                        // Budget (will be populated from existing data)
                        budget_monthly: 0,
                        budget_annual: 0,
                        
                        // Metadata
                        created_at: serverTimestamp(),
                        created_by: 'system'
                    };
                    
                    batch.set(
                        doc(db, 'users', uid, 'chart_of_accounts', account.code),
                        accountDoc
                    );
                    count++;
                }
                
                await batch.commit();
                
                statusDiv.innerHTML = `
                    <p class="status success">
                        ✅ Successfully created ${count} accounts in Chart of Accounts!
                    </p>
                `;
                
                // Reload status
                await loadCurrentStatus();
                
            } catch (error) {
                console.error('Error setting up chart:', error);
                statusDiv.innerHTML = `
                    <p class="status error">❌ Error: ${error.message}</p>
                `;
            }
        };

        // Migrate existing categories to chart
        window.migrateExistingData = async function() {
            const statusDiv = document.getElementById('actionStatus');
            statusDiv.innerHTML = '<p class="status progress">Migrating existing categories...</p>';
            
            try {
                // Get existing categories
                const categoriesSnap = await getDocs(
                    collection(db, 'users', uid, 'categories')
                );
                
                const batch = writeBatch(db);
                let accountCode = 5300; // Start after our default accounts
                let migrated = 0;
                
                for (const catDoc of categoriesSnap.docs) {
                    const category = catDoc.data();
                    
                    // Skip if already in our default chart
                    if (defaultChart.some(a => a.legacyCategoryId === category.category_id)) {
                        continue;
                    }
                    
                    // Create parent account for category
                    const parentCode = String(accountCode);
                    batch.set(
                        doc(db, 'users', uid, 'chart_of_accounts', parentCode),
                        {
                            account_code: parentCode,
                            account_name: category.name + ' Expenses',
                            account_type: 'expense',
                            display_as: 'category',
                            level: 1,
                            parent_code: null,
                            
                            category_name: category.name,
                            subcategory_name: null,
                            legacy_category_id: category.category_id,
                            legacy_subcategory_id: null,
                            
                            normal_balance: 'debit',
                            financial_statement: 'income_statement',
                            is_active: category.active !== false,
                            system_account: false,
                            
                            budget_monthly: 0,
                            budget_annual: 0,
                            
                            created_at: serverTimestamp(),
                            created_by: 'migration'
                        }
                    );
                    migrated++;
                    
                    // Create child accounts for subcategories
                    if (category.subcategories && Array.isArray(category.subcategories)) {
                        let subCode = 10;
                        for (const sub of category.subcategories) {
                            const childCode = parentCode + String(subCode);
                            batch.set(
                                doc(db, 'users', uid, 'chart_of_accounts', childCode),
                                {
                                    account_code: childCode,
                                    account_name: sub.name,
                                    account_type: 'expense',
                                    display_as: 'subcategory',
                                    level: 2,
                                    parent_code: parentCode,
                                    
                                    category_name: category.name,
                                    subcategory_name: sub.name,
                                    legacy_category_id: category.category_id,
                                    legacy_subcategory_id: sub.id,
                                    
                                    normal_balance: 'debit',
                                    financial_statement: 'income_statement',
                                    is_active: true,
                                    system_account: false,
                                    
                                    budget_monthly: 0,
                                    budget_annual: 0,
                                    
                                    created_at: serverTimestamp(),
                                    created_by: 'migration'
                                }
                            );
                            migrated++;
                            subCode += 10;
                        }
                    }
                    
                    accountCode += 100;
                }
                
                await batch.commit();
                
                statusDiv.innerHTML = `
                    <p class="status success">
                        ✅ Migrated ${migrated} accounts from existing categories!
                    </p>
                `;
                
                await loadCurrentStatus();
                
            } catch (error) {
                console.error('Error migrating:', error);
                statusDiv.innerHTML = `
                    <p class="status error">❌ Error: ${error.message}</p>
                `;
            }
        };

        // Clear all data (dev only)
        window.clearAllData = async function() {
            if (!confirm('⚠️ This will DELETE all data! Are you sure?')) return;
            
            const statusDiv = document.getElementById('actionStatus');
            statusDiv.innerHTML = '<p class="status progress">Clearing all data...</p>';
            
            try {
                // Clear chart_of_accounts
                const accountsSnap = await getDocs(
                    collection(db, 'users', uid, 'chart_of_accounts')
                );
                
                const batch = writeBatch(db);
                accountsSnap.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                statusDiv.innerHTML = `
                    <p class="status success">✅ Cleared all chart_of_accounts data</p>
                `;
                
                await loadCurrentStatus();
                
            } catch (error) {
                console.error('Error clearing data:', error);
                statusDiv.innerHTML = `
                    <p class="status error">❌ Error: ${error.message}</p>
                `;
            }
        };

        // Initialize on load
        loadCurrentStatus();
    </script>
</body>
</html>