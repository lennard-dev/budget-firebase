<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Category IDs</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .description {
      color: #666;
      margin-bottom: 30px;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    .btn-primary:hover {
      background: #45a049;
    }
    .btn-danger {
      background: #f44336;
      color: white;
    }
    .btn-danger:hover {
      background: #da190b;
    }
    .btn-info {
      background: #2196F3;
      color: white;
    }
    .btn-info:hover {
      background: #0b7dda;
    }
    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 500px;
      overflow-y: auto;
    }
    .error {
      color: #f44336;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .success {
      color: #4CAF50;
      background: #e8f5e9;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .warning {
      color: #ff9800;
      background: #fff3e0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f2f2f2;
      font-weight: 600;
    }
    .duplicate {
      background: #ffebee;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #333;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fix Category IDs</h1>
    <p class="description">This tool helps diagnose and fix duplicate category IDs in the system.</p>
    
    <div class="actions">
      <button class="btn-info" onclick="checkCategories()">
        Check Current Categories
      </button>
      <button class="btn-primary" onclick="fixDuplicates()">
        Fix Duplicate IDs
      </button>
      <button class="btn-danger" onclick="regenerateAllIds()">
        Regenerate All IDs (Danger!)
      </button>
    </div>
    
    <div id="results" class="results" style="display: none;"></div>
  </div>

  <!-- Firebase -->
  <script src="/__/firebase/9.6.1/firebase-app-compat.js"></script>
  <script src="/__/firebase/9.6.1/firebase-auth-compat.js"></script>
  <script src="/__/firebase/9.6.1/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js"></script>
  <script src="/app.js"></script>

  <script>
    async function showLoading(message) {
      const results = document.getElementById('results');
      results.style.display = 'block';
      results.innerHTML = `${message} <span class="loading"></span>`;
    }

    async function showResults(html) {
      const results = document.getElementById('results');
      results.style.display = 'block';
      results.innerHTML = html;
    }

    async function checkCategories() {
      try {
        showLoading('Fetching categories...');
        
        const response = await window.callApi('/categories');
        
        if (response.success) {
          const categories = response.data || [];
          
          // Group by category_id to find duplicates
          const idMap = {};
          categories.forEach(cat => {
            const id = cat.category_id || 'NO_ID';
            if (!idMap[id]) idMap[id] = [];
            idMap[id].push(cat);
          });
          
          // Build HTML table
          let html = '<h3>Current Categories</h3>';
          html += '<table>';
          html += '<tr><th>Name</th><th>Category ID</th><th>Code</th><th>Subcategories</th><th>Status</th></tr>';
          
          categories.sort((a, b) => (a.category_id || '').localeCompare(b.category_id || '')).forEach(cat => {
            const isDuplicate = idMap[cat.category_id] && idMap[cat.category_id].length > 1;
            const rowClass = isDuplicate ? 'duplicate' : '';
            const subcatCount = cat.subcategories ? cat.subcategories.length : 0;
            const status = isDuplicate ? '⚠️ DUPLICATE' : '✅ OK';
            
            html += `<tr class="${rowClass}">`;
            html += `<td>${cat.name}</td>`;
            html += `<td><strong>${cat.category_id || 'MISSING'}</strong></td>`;
            html += `<td>${cat.code || '-'}</td>`;
            html += `<td>${subcatCount}</td>`;
            html += `<td>${status}</td>`;
            html += '</tr>';
          });
          
          html += '</table>';
          
          // Show duplicate summary
          const duplicateIds = Object.keys(idMap).filter(id => idMap[id].length > 1);
          if (duplicateIds.length > 0) {
            html += '<div class="warning"><strong>⚠️ Found duplicate IDs:</strong><br>';
            duplicateIds.forEach(id => {
              const names = idMap[id].map(c => c.name).join(', ');
              html += `ID ${id}: ${names}<br>`;
            });
            html += '</div>';
          } else {
            html += '<div class="success">✅ No duplicate IDs found!</div>';
          }
          
          showResults(html);
        } else {
          showResults(`<div class="error">Failed to fetch categories: ${response.error}</div>`);
        }
      } catch (error) {
        console.error('Error:', error);
        showResults(`<div class="error">Error: ${error.message}</div>`);
      }
    }

    async function fixDuplicates() {
      try {
        showLoading('Fixing duplicate IDs...');
        
        const response = await window.callApi('/categories/fix-duplicates', {
          method: 'POST'
        });
        
        if (response.success) {
          let html = '<h3>Fix Results</h3>';
          html += `<div class="success">`;
          html += `✅ Fixed ${response.fixed} duplicate IDs<br>`;
          html += `Found: ${response.duplicatesFound} duplicates<br>`;
          html += `Fixed: ${response.fixed}<br>`;
          html += '</div>';
          
          if (response.changes && response.changes.length > 0) {
            html += '<h4>Changes Made:</h4>';
            html += '<ul>';
            response.changes.forEach(change => {
              html += `<li>${change}</li>`;
            });
            html += '</ul>';
          }
          
          html += '<p><button class="btn-info" onclick="checkCategories()">Check Categories Again</button></p>';
          
          showResults(html);
        } else {
          showResults(`<div class="error">Failed to fix duplicates: ${response.error}</div>`);
        }
      } catch (error) {
        console.error('Error:', error);
        showResults(`<div class="error">Error: ${error.message}</div>`);
      }
    }

    async function regenerateAllIds() {
      if (!confirm('⚠️ WARNING: This will regenerate ALL category IDs. This action cannot be undone. Continue?')) {
        return;
      }
      
      try {
        showLoading('Regenerating all IDs...');
        
        // First get all categories
        const response = await window.callApi('/categories');
        
        if (response.success) {
          const categories = response.data || [];
          let updatedCount = 0;
          let errors = [];
          
          // Update each category with a new ID
          for (let i = 0; i < categories.length; i++) {
            const cat = categories[i];
            try {
              // Force regenerate by setting category_id to null first
              const updateResponse = await window.callApi('/categories', {
                method: 'POST',
                body: JSON.stringify({
                  ...cat,
                  category_id: null, // This will trigger ID regeneration
                  force_regenerate_id: true
                })
              });
              
              if (updateResponse.success) {
                updatedCount++;
              } else {
                errors.push(`${cat.name}: ${updateResponse.error}`);
              }
            } catch (err) {
              errors.push(`${cat.name}: ${err.message}`);
            }
          }
          
          let html = '<h3>Regeneration Results</h3>';
          html += `<div class="${errors.length === 0 ? 'success' : 'warning'}">`;
          html += `Updated ${updatedCount} of ${categories.length} categories<br>`;
          if (errors.length > 0) {
            html += '<br><strong>Errors:</strong><br>';
            errors.forEach(err => {
              html += `- ${err}<br>`;
            });
          }
          html += '</div>';
          
          html += '<p><button class="btn-info" onclick="checkCategories()">Check Categories Again</button></p>';
          
          showResults(html);
        }
      } catch (error) {
        console.error('Error:', error);
        showResults(`<div class="error">Error: ${error.message}</div>`);
      }
    }

    // Check categories on load
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkCategories, 1000);
    });
  </script>
</body>
</html>