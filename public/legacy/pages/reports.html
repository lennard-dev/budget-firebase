<div class="content-area">
  <div class="page-header">
    <h2 class="page-title">Reports & Analytics</h2>
    <div class="page-actions">
      <button class="btn btn-primary" onclick="generateReport()">📊 Generate Report</button>
      <div class="export-buttons" style="display:none;" id="export-buttons">
        <button class="btn btn-outline" onclick="exportReport('pdf')" id="pdf-btn">📄 PDF</button>
        <button class="btn btn-outline" onclick="exportReport('excel')" id="excel-btn">📊 Excel</button>
        <button class="btn btn-outline" onclick="exportCSV()" id="csv-btn">📋 CSV</button>
      </div>
    </div>
  </div>
  
  <!-- Report Configuration Panel -->
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">Report Configuration</h3>
      <button class="btn btn-sm btn-outline" onclick="toggleConfig()" id="toggle-config">🔧 Settings</button>
    </div>
    <div class="card-body" id="config-panel">
      <div class="report-config-grid">
        <div class="config-section">
          <label class="form-label">Report Type</label>
          <select id="report-type" class="form-control">
            <option value="monthly">Monthly Summary</option>
            <option value="annual">Annual Report</option>
            <option value="category">Category Analysis</option>
            <option value="donor">Donor Summary</option>
          </select>
        </div>
        
        <div class="config-section" id="date-section">
          <label class="form-label">Period</label>
          <div class="date-inputs">
            <input type="month" id="report-month" class="form-control" />
            <input type="number" id="report-year" class="form-control" placeholder="Year" min="2020" max="2030" />
          </div>
        </div>
        
        <div class="config-section">
          <label class="form-label">Include Charts</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="include-budget" checked> Budget vs Actual</label>
            <label><input type="checkbox" id="include-trend" checked> Spending Trends</label>
            <label><input type="checkbox" id="include-category" checked> Category Breakdown</label>
          </div>
        </div>
        
        <div class="config-section">
          <label class="form-label">Categories</label>
          <select id="category-filter" class="form-control">
            <option value="">All Categories</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Results -->
  <div id="report-results" style="display:none;">
    <!-- Summary Cards -->
    <div class="report-summary-grid mb-3">
      <div class="card summary-card">
        <h4 id="total-expenses-label">Total Expenses</h4>
        <h2 id="total-expenses">€0.00</h2>
        <small id="expenses-trend" class="trend-indicator"></small>
      </div>
      <div class="card summary-card">
        <h4 id="budget-utilization-label">Budget Utilization</h4>
        <h2 id="budget-utilization">0%</h2>
        <small id="budget-status" class="trend-indicator"></small>
      </div>
      <div class="card summary-card">
        <h4 id="avg-expense-label">Average Expense</h4>
        <h2 id="avg-expense">€0.00</h2>
        <small id="expense-count" class="trend-indicator"></small>
      </div>
      <div class="card summary-card">
        <h4 id="largest-category-label">Top Category</h4>
        <h2 id="largest-category">-</h2>
        <small id="category-percentage" class="trend-indicator"></small>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid mb-3" id="report-charts">
      <div class="card chart-card" id="budget-chart-card">
        <div class="card-header">
          <h3>Budget vs Actual</h3>
        </div>
        <div class="card-body chart-container">
          <canvas id="report-budget-chart"></canvas>
        </div>
      </div>
      
      <div class="card chart-card" id="category-chart-card">
        <div class="card-header">
          <h3>Category Breakdown</h3>
        </div>
        <div class="card-body chart-container">
          <canvas id="report-category-chart"></canvas>
        </div>
      </div>
      
      <div class="card chart-card full-width" id="trend-chart-card">
        <div class="card-header">
          <h3>Spending Trends</h3>
        </div>
        <div class="card-body chart-container">
          <canvas id="report-trend-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Detailed Tables -->
    <div class="grid grid-2 mb-3" id="detail-tables">
      <div class="card">
        <div class="card-header">
          <h3>Category Details</h3>
        </div>
        <div class="card-body">
          <table class="data-table">
            <thead>
              <tr>
                <th>Category</th>
                <th class="text-right">Budget</th>
                <th class="text-right">Spent</th>
                <th class="text-right">Variance</th>
                <th class="text-center">Status</th>
              </tr>
            </thead>
            <tbody id="category-detail-table">
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3>Key Insights</h3>
        </div>
        <div class="card-body">
          <div id="insights-list">
            <div class="insight-item">
              <span class="insight-icon">💡</span>
              <div class="insight-content">
                <strong>Generating insights...</strong>
                <p>Analyzing your spending patterns and budget performance</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div id="report-loading" style="display:none;">
    <div class="card">
      <div class="card-body text-center">
        <div class="loading-spinner"></div>
        <h3>Generating Report...</h3>
        <p>Please wait while we analyze your data</p>
      </div>
    </div>
  </div>
</div>

<style>
.report-config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 1rem;
}

.config-section label.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #374151;
}

.date-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: normal;
}

.report-summary-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
}

.summary-card {
  text-align: center;
  padding: 1.5rem;
}

.summary-card h4 {
  color: #6b7280;
  font-size: 14px;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.summary-card h2 {
  font-size: 2rem;
  font-weight: 700;
  color: var(--color-primary);
  margin-bottom: 0.5rem;
}

.trend-indicator {
  font-size: 12px;
  color: #6b7280;
}

.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.chart-card.full-width {
  grid-column: 1 / -1;
}

.chart-container {
  position: relative;
  height: 300px;
}

.insight-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  background: #f8fafc;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.insight-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.insight-content {
  flex: 1;
}

.insight-content strong {
  display: block;
  color: var(--color-primary);
  margin-bottom: 0.25rem;
}

.insight-content p {
  margin: 0;
  color: #6b7280;
  font-size: 14px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #e5e7eb;
  border-top: 4px solid var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.export-buttons {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.page-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
}

@media (max-width: 768px) {
  .report-config-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  .date-inputs {
    grid-template-columns: 1fr;
  }
  
  .report-summary-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .grid-2 {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
(function(){
  let currentReportData = null;
  let reportCharts = {};
  
  function fmt(n) {
    return new Intl.NumberFormat('en-US', {style: 'currency', currency: 'EUR'}).format(Number(n) || 0);
  }
  
  function formatPercent(value) {
    return `${(value || 0).toFixed(1)}%`;
  }
  
  window.toggleConfig = function() {
    const panel = document.getElementById('config-panel');
    const btn = document.getElementById('toggle-config');
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
      btn.textContent = '🔧 Hide Settings';
    } else {
      panel.style.display = 'none';
      btn.textContent = '🔧 Show Settings';
    }
  }
  
  function updateDateSection() {
    const reportType = document.getElementById('report-type').value;
    const monthInput = document.getElementById('report-month');
    const yearInput = document.getElementById('report-year');
    
    const now = new Date();
    if (reportType === 'monthly') {
      monthInput.style.display = 'block';
      monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      yearInput.style.display = 'none';
    } else if (reportType === 'annual') {
      monthInput.style.display = 'none';
      yearInput.style.display = 'block';
      yearInput.value = now.getFullYear();
    } else {
      monthInput.style.display = 'block';
      yearInput.style.display = 'block';
      monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      yearInput.value = now.getFullYear();
    }
  }
  
  function destroyCharts() {
    Object.values(reportCharts).forEach(chart => {
      if (chart) chart.destroy();
    });
    reportCharts = {};
  }
  
  function createBudgetChart(data) {
    if (!document.getElementById('include-budget').checked) {
      document.getElementById('budget-chart-card').style.display = 'none';
      return;
    }
    document.getElementById('budget-chart-card').style.display = 'block';
    
    const ctx = document.getElementById('report-budget-chart');
    if (!ctx || !data.categories) return;
    
    if (reportCharts.budget) reportCharts.budget.destroy();
    
    reportCharts.budget = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.categories,
        datasets: [
          {
            label: 'Budget',
            data: data.budgeted,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: 'rgba(59, 130, 246, 1)',
            borderWidth: 1
          },
          {
            label: 'Actual',
            data: data.actual,
            backgroundColor: 'rgba(16, 185, 129, 0.6)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
  }
  
  function createCategoryChart(data) {
    if (!document.getElementById('include-category').checked) {
      document.getElementById('category-chart-card').style.display = 'none';
      return;
    }
    document.getElementById('category-chart-card').style.display = 'block';
    
    const ctx = document.getElementById('report-category-chart');
    if (!ctx || !data.categories) return;
    
    if (reportCharts.category) reportCharts.category.destroy();
    
    const colors = [
      'rgba(239, 68, 68, 0.8)',
      'rgba(59, 130, 246, 0.8)',
      'rgba(16, 185, 129, 0.8)',
      'rgba(245, 158, 11, 0.8)',
      'rgba(139, 92, 246, 0.8)',
      'rgba(236, 72, 153, 0.8)',
      'rgba(34, 197, 94, 0.8)',
      'rgba(249, 115, 22, 0.8)'
    ];
    
    reportCharts.category = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: data.categories,
        datasets: [{
          data: data.actual,
          backgroundColor: colors.slice(0, data.categories.length),
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = fmt(context.parsed);
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        }
      }
    });
  }
  
  function createTrendChart(data) {
    if (!document.getElementById('include-trend').checked) {
      document.getElementById('trend-chart-card').style.display = 'none';
      return;
    }
    document.getElementById('trend-chart-card').style.display = 'block';
    
    const ctx = document.getElementById('report-trend-chart');
    if (!ctx || !data.trendData) return;
    
    if (reportCharts.trend) reportCharts.trend.destroy();
    
    reportCharts.trend = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.trendData.labels,
        datasets: [{
          label: 'Monthly Expenses',
          data: data.trendData.values,
          borderColor: 'rgba(59, 130, 246, 1)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true,
          pointBackgroundColor: 'rgba(59, 130, 246, 1)',
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
  }
  
  function generateInsights(data) {
    const insights = [];
    
    if (data.budgetUtilization > 100) {
      insights.push({
        icon: '⚠️',
        title: 'Budget Exceeded',
        message: `You've exceeded your budget by ${formatPercent(data.budgetUtilization - 100)}. Consider reviewing high-spending categories.`
      });
    } else if (data.budgetUtilization < 50) {
      insights.push({
        icon: '💰',
        title: 'Budget Under-utilized',
        message: `Only ${formatPercent(data.budgetUtilization)} of budget used. Consider reallocating unused funds.`
      });
    }
    
    if (data.topCategory && data.topCategoryPercentage > 40) {
      insights.push({
        icon: '📊',
        title: 'Category Concentration',
        message: `${data.topCategory} represents ${formatPercent(data.topCategoryPercentage)} of total spending.`
      });
    }
    
    if (data.expenseCount && data.expenseCount < 10) {
      insights.push({
        icon: '📈',
        title: 'Low Activity',
        message: `Only ${data.expenseCount} expenses recorded. Consider tracking smaller expenses for better insights.`
      });
    }
    
    if (insights.length === 0) {
      insights.push({
        icon: '✅',
        title: 'Healthy Financial Activity',
        message: 'Your spending patterns look balanced and within expected ranges.'
      });
    }
    
    return insights;
  }
  
  function updateSummaryCards(data) {
    document.getElementById('total-expenses').textContent = fmt(data.totalExpenses || 0);
    document.getElementById('budget-utilization').textContent = formatPercent(data.budgetUtilization || 0);
    document.getElementById('avg-expense').textContent = fmt(data.averageExpense || 0);
    document.getElementById('largest-category').textContent = data.topCategory || '-';
    
    // Update trend indicators
    document.getElementById('expenses-trend').textContent = `${data.expenseCount || 0} transactions`;
    document.getElementById('budget-status').textContent = data.budgetUtilization > 100 ? 'Over budget' : 
      data.budgetUtilization > 80 ? 'Near limit' : 'On track';
    document.getElementById('expense-count').textContent = `Avg per day: ${((data.expenseCount || 0) / 30).toFixed(1)}`;
    document.getElementById('category-percentage').textContent = `${formatPercent(data.topCategoryPercentage || 0)} of total`;
  }
  
  function updateDetailTable(data) {
    const tbody = document.getElementById('category-detail-table');
    tbody.innerHTML = '';
    
    if (!data.categoryDetails || data.categoryDetails.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No category data available</td></tr>';
      return;
    }
    
    data.categoryDetails.forEach(cat => {
      const variance = (cat.spent || 0) - (cat.budgeted || 0);
      const status = variance > 0 ? 'Over' : variance < -(cat.budgeted * 0.2) ? 'Under' : 'On Track';
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${cat.category}</strong></td>
        <td class="text-right">${fmt(cat.budgeted || 0)}</td>
        <td class="text-right">${fmt(cat.spent || 0)}</td>
        <td class="text-right ${variance >= 0 ? 'text-danger' : 'text-success'}">
          ${variance >= 0 ? '+' : ''}${fmt(variance)}
        </td>
        <td class="text-center">
          <span class="status-badge ${status === 'Over' ? 'status-over' : status === 'Under' ? 'status-under' : 'status-on-track'}">
            ${status}
          </span>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  function updateInsights(data) {
    const insights = generateInsights(data);
    const container = document.getElementById('insights-list');
    container.innerHTML = '';
    
    insights.forEach(insight => {
      const div = document.createElement('div');
      div.className = 'insight-item';
      div.innerHTML = `
        <span class="insight-icon">${insight.icon}</span>
        <div class="insight-content">
          <strong>${insight.title}</strong>
          <p>${insight.message}</p>
        </div>
      `;
      container.appendChild(div);
    });
  }
  
  window.generateReport = async function() {
    const reportType = document.getElementById('report-type').value;
    const monthValue = document.getElementById('report-month').value;
    const yearValue = document.getElementById('report-year').value;
    const categoryFilter = document.getElementById('category-filter').value;
    
    // Show loading state
    document.getElementById('report-results').style.display = 'none';
    document.getElementById('report-loading').style.display = 'block';
    
    try {
      let apiPath = '/reports/';
      let params = new URLSearchParams();
      
      if (reportType === 'monthly') {
        const [year, month] = monthValue.split('-');
        apiPath += 'monthly-summary';
        params.set('year', year);
        params.set('month', month);
      } else if (reportType === 'annual') {
        apiPath += 'annual-summary';
        params.set('year', yearValue);
      } else if (reportType === 'category') {
        apiPath += 'category-analysis';
        if (categoryFilter) params.set('category', categoryFilter);
      } else if (reportType === 'donor') {
        apiPath += 'donor-summary';
        const [year, month] = monthValue.split('-');
        params.set('year', year);
        params.set('month', month);
      }
      
      const fullPath = apiPath + (params.toString() ? '?' + params.toString() : '');
      const response = await window.callApi(fullPath);
      currentReportData = response.data;
      
      // Process and display report data
      await new Promise(resolve => setTimeout(resolve, 1500)); // Show loading for user experience
      
      updateSummaryCards(currentReportData);
      updateDetailTable(currentReportData);
      updateInsights(currentReportData);
      
      // Destroy existing charts
      destroyCharts();
      
      // Create new charts
      setTimeout(() => {
        createBudgetChart(currentReportData);
        createCategoryChart(currentReportData);
        createTrendChart(currentReportData);
      }, 100);
      
      // Show results and export buttons
      document.getElementById('report-loading').style.display = 'none';
      document.getElementById('report-results').style.display = 'block';
      document.getElementById('export-buttons').style.display = 'block';
      
      // Hide config panel
      document.getElementById('config-panel').style.display = 'none';
      document.getElementById('toggle-config').textContent = '🔧 Show Settings';
      
    } catch (error) {
      console.error('Report generation failed:', error);
      document.getElementById('report-loading').style.display = 'none';
      alert('Failed to generate report. Please try again.');
    }
  }
  
  window.exportReport = async function(format) {
    if (!currentReportData) {
      alert('Please generate a report first');
      return;
    }
    
    const reportType = document.getElementById('report-type').value;
    const monthValue = document.getElementById('report-month').value;
    const yearValue = document.getElementById('report-year').value;
    const categoryFilter = document.getElementById('category-filter').value;
    
    try {
      let params = new URLSearchParams();
      
      if (reportType === 'monthly') {
        const [year, month] = monthValue.split('-');
        params.set('type', 'monthly');
        params.set('year', year);
        params.set('month', month);
      } else if (reportType === 'annual') {
        params.set('type', 'annual');
        params.set('year', yearValue);
      } else if (reportType === 'category') {
        params.set('type', 'category');
        if (categoryFilter) params.set('category', categoryFilter);
      } else if (reportType === 'donor') {
        params.set('type', 'donor');
        const [year, month] = monthValue.split('-');
        params.set('year', year);
        params.set('month', month);
      }
      
      let exportUrl;
      if (format === 'pdf') {
        // For PDF, we'll use the print functionality with custom styles
        window.printReport();
        return;
      } else if (format === 'excel') {
        exportUrl = `/api/reports/export/excel?${params.toString()}`;
      } else if (format === 'csv') {
        exportUrl = `/api/reports/export/csv?${params.toString()}`;
      }
      
      if (exportUrl) {
        // Get auth token
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Please sign in to export reports');
          return;
        }
        
        const token = await user.getIdToken();
        
        // Create a temporary link to download the file
        const link = document.createElement('a');
        link.href = exportUrl;
        link.style.display = 'none';
        
        // Add auth header by using fetch and creating blob URL
        const response = await fetch(exportUrl, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error(`Export failed: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const blobUrl = window.URL.createObjectURL(blob);
        
        link.href = blobUrl;
        link.download = ''; // Filename will come from Content-Disposition header
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up the blob URL
        setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);
      }
    } catch (error) {
      console.error('Export failed:', error);
      alert('Export failed. Please try again.');
    }
  }
  
  // Add CSV export button
  window.exportCSV = function() {
    window.exportReport('csv');
  }
  
  // Print report as PDF using browser print functionality
  window.printReport = function() {
    if (!currentReportData) {
      alert('Please generate a report first');
      return;
    }
    
    // Create a new window with print-friendly content
    const printWindow = window.open('', '_blank');
    const reportType = document.getElementById('report-type').value;
    const monthValue = document.getElementById('report-month').value;
    const yearValue = document.getElementById('report-year').value;
    
    let reportTitle = 'Financial Report';
    let reportPeriod = '';
    
    if (reportType === 'monthly') {
      const [year, month] = monthValue.split('-');
      const monthName = new Date(year, month - 1).toLocaleString('en', {month: 'long'});
      reportTitle = 'Monthly Financial Report';
      reportPeriod = `${monthName} ${year}`;
    } else if (reportType === 'annual') {
      reportTitle = 'Annual Financial Report';
      reportPeriod = yearValue;
    } else if (reportType === 'category') {
      reportTitle = 'Category Analysis Report';
      reportPeriod = 'All Periods';
    } else if (reportType === 'donor') {
      reportTitle = 'Donor Summary Report';
      const [year, month] = monthValue.split('-');
      const monthName = new Date(year, month - 1).toLocaleString('en', {month: 'long'});
      reportPeriod = `${monthName} ${year}`;
    }
    
    const printContent = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>${reportTitle} - ${reportPeriod}</title>
        <style>
          @media print {
            body { margin: 0; font-family: Arial, sans-serif; font-size: 12px; }
            .no-print { display: none; }
            .page-break { page-break-before: always; }
          }
          body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
          h1 { color: #1f2937; border-bottom: 2px solid #1f2937; padding-bottom: 10px; }
          h2 { color: #374151; margin-top: 30px; }
          .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 20px 0; }
          .summary-card { border: 1px solid #d1d5db; border-radius: 8px; padding: 15px; text-align: center; }
          .summary-card h3 { margin: 0 0 5px 0; font-size: 14px; color: #6b7280; }
          .summary-card .value { font-size: 24px; font-weight: bold; color: #1f2937; }
          .summary-card .trend { font-size: 12px; color: #6b7280; margin-top: 5px; }
          table { border-collapse: collapse; width: 100%; margin: 20px 0; }
          th, td { border: 1px solid #d1d5db; padding: 8px; text-align: left; }
          th { background-color: #f9fafb; font-weight: bold; }
          .text-right { text-align: right; }
          .text-center { text-align: center; }
          .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
          .status-on-track { background: #dcfce7; color: #166534; }
          .status-warning { background: #fef3c7; color: #92400e; }
          .status-over { background: #fee2e2; color: #991b1b; }
          .status-under { background: #dbeafe; color: #1e40af; }
          .insights { background: #f8fafc; padding: 15px; border-radius: 8px; margin: 20px 0; }
          .insight-item { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }
          .footer { margin-top: 40px; text-align: center; font-size: 10px; color: #6b7280; }
        </style>
      </head>
      <body>
        <h1>${reportTitle}</h1>
        <p><strong>Period:</strong> ${reportPeriod}</p>
        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
        
        <h2>Financial Summary</h2>
        <div class="summary-grid">
          <div class="summary-card">
            <h3>Total Expenses</h3>
            <div class="value">${fmt(currentReportData.totalExpenses || 0)}</div>
            <div class="trend">${currentReportData.expenseCount || 0} transactions</div>
          </div>
          <div class="summary-card">
            <h3>Budget Utilization</h3>
            <div class="value">${formatPercent(currentReportData.budgetUtilization || 0)}</div>
            <div class="trend">${currentReportData.budgetUtilization > 100 ? 'Over budget' : currentReportData.budgetUtilization > 80 ? 'Near limit' : 'On track'}</div>
          </div>
          <div class="summary-card">
            <h3>Average Expense</h3>
            <div class="value">${fmt(currentReportData.averageExpense || 0)}</div>
            <div class="trend">Avg per day: ${((currentReportData.expenseCount || 0) / 30).toFixed(1)}</div>
          </div>
          <div class="summary-card">
            <h3>Top Category</h3>
            <div class="value" style="font-size: 16px;">${currentReportData.topCategory || '-'}</div>
            <div class="trend">${formatPercent(currentReportData.topCategoryPercentage || 0)} of total</div>
          </div>
        </div>
        
        ${currentReportData.categoryDetails && currentReportData.categoryDetails.length > 0 ? `
        <h2>Category Analysis</h2>
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th class="text-right">Budget</th>
              <th class="text-right">Spent</th>
              <th class="text-right">Variance</th>
              <th class="text-center">Status</th>
            </tr>
          </thead>
          <tbody>
            ${currentReportData.categoryDetails.map(cat => {
              const variance = (cat.spent || 0) - (cat.budgeted || 0);
              const status = variance > 0 ? 'Over' : variance < -(cat.budgeted * 0.2) ? 'Under' : 'On Track';
              const statusClass = variance > 0 ? 'status-over' : variance < -(cat.budgeted * 0.2) ? 'status-under' : 'status-on-track';
              
              return `
                <tr>
                  <td><strong>${cat.category}</strong></td>
                  <td class="text-right">${fmt(cat.budgeted || 0)}</td>
                  <td class="text-right">${fmt(cat.spent || 0)}</td>
                  <td class="text-right">${variance >= 0 ? '+' : ''}${fmt(variance)}</td>
                  <td class="text-center"><span class="status-badge ${statusClass}">${status}</span></td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        ` : ''}
        
        <div class="page-break"></div>
        <h2>Key Insights</h2>
        <div class="insights">
          ${generateInsights(currentReportData).map(insight => `
            <div class="insight-item">
              <strong>${insight.icon} ${insight.title}</strong>
              <p>${insight.message}</p>
            </div>
          `).join('')}
        </div>
        
        <div class="footer">
          <p>This report was generated automatically by NGO Budget Management System</p>
          <p>For questions or support, please contact your system administrator</p>
        </div>
      </body>
      </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    // Trigger print after content is ready
    printWindow.onload = function(){
      try { printWindow.print(); } catch(_) {}
      printWindow.onafterprint = function(){ try { printWindow.close(); } catch(_) {} };
    };
  }
  
  async function loadCategories() {
    try {
      const response = await window.callApi('/categories');
      const categories = response.data || [];
      const select = document.getElementById('category-filter');
      
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.name;
        option.textContent = cat.name;
        select.appendChild(option);
      });
    } catch (error) {
      console.warn('Failed to load categories:', error);
    }
  }
  
  window.initializeReportsPage = function() {
    // Set initial values
    updateDateSection();
    
    // Event listeners
    document.getElementById('report-type').addEventListener('change', updateDateSection);
    
    // Load categories for filter
    loadCategories();
    
    // Hide config panel initially
    document.getElementById('config-panel').style.display = 'none';
    
    // Load Chart.js if not available
    if (typeof Chart === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
      document.head.appendChild(script);
    }
  }
  window.registerPageInitializer('reports', window.initializeReportsPage);
})();
</script>

