<div class="content-area">
  <div class="page-header">
    <h2 class="page-title">Dashboard</h2>
    <div class="page-actions">
      <button class="btn btn-primary" onclick="if(window.openExpenseModal){window.openExpenseModal();}">➕ Quick Expense</button>
    </div>
  </div>
  
  <!-- Metrics Cards -->
  <div class="grid grid-4 mb-3">
    <div class="card">
      <h4 class="text-muted mb-1">This Month's Expenses</h4>
      <h2 id="dash-month-expenses">€0.00</h2>
      <small id="dash-expense-trend" class="text-muted"></small>
    </div>
    <div class="card">
      <h4 class="text-muted mb-1">Budget Remaining</h4>
      <h2 id="dash-budget-remaining" class="text-success">€0.00</h2>
      <div class="progress-bar mt-2" style="height:6px;background:#e2e8f0;border-radius:3px;">
        <div id="dash-budget-progress" style="height:100%;background:var(--color-secondary);border-radius:3px;transition:width 0.3s;"></div>
      </div>
    </div>
    <div class="card">
      <h4 class="text-muted mb-1">Cash on Hand</h4>
      <h2 id="dash-cash">€0.00</h2>
      <small class="text-muted">Last updated today</small>
    </div>
    <div class="card">
      <h4 class="text-muted mb-1">Pending Donations</h4>
      <h2 id="dash-pending">€0.00</h2>
      <small id="dash-donation-count" class="text-muted">0 expected</small>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="grid grid-2 mb-3">
    <!-- Budget vs Actual Chart -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Budget vs Actual</h3>
        <select id="chart-period" class="form-control" style="width:auto;display:inline-block;">
          <option value="current">This Month</option>
          <option value="last">Last Month</option>
          <option value="quarter">Last 3 Months</option>
        </select>
      </div>
      <div class="card-body" style="position:relative;height:300px;">
        <canvas id="budget-chart"></canvas>
      </div>
    </div>
    
    <!-- Category Breakdown Chart -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Spending by Category</h3>
        <button class="btn btn-sm" onclick="toggleChartType()" style="float:right;">Switch View</button>
      </div>
      <div class="card-body" style="position:relative;height:300px;">
        <canvas id="category-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Spending Trend Chart -->
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">Spending Trend (Last 12 Months)</h3>
    </div>
    <div class="card-body" style="position:relative;height:200px;">
      <canvas id="trend-chart"></canvas>
    </div>
  </div>

  <!-- Recent Expenses Table -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Recent Expenses</h3>
      <a href="#expenses" class="btn btn-sm" style="float:right;">View All →</a>
    </div>
    <div class="card-body">
      <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Category</th>
            <th>Subcategory</th>
            <th>Description</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody id="dash-recent">
          <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<style>
.progress-bar { position: relative; overflow: hidden; }
.card-header { display: flex; justify-content: space-between; align-items: center; }
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 768px) {
  .grid-2 { grid-template-columns: 1fr; }
}
</style>

<script>
(function(){
  let budgetChart, categoryChart, trendChart;
  let categoryChartType = 'doughnut';
  
  function fmt(n){
    return new Intl.NumberFormat('en-US',{style:'currency',currency:'EUR'}).format(Number(n)||0);
  }
  
  function getMonthName(monthNum) {
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return months[monthNum - 1] || '';
  }
  
  window.toggleChartType = function() {
    categoryChartType = categoryChartType === 'doughnut' ? 'bar' : 'doughnut';
    if (categoryChart) {
      updateCategoryChart(categoryChart.data.labels, categoryChart.data.datasets[0].data);
    }
  }
  
  function updateBudgetChart(categories, budgeted, actual) {
    const ctx = document.getElementById('budget-chart');
    if (!ctx) return;
    
    if (budgetChart) {
      budgetChart.destroy();
    }
    
    // Ensure Chart is available before creating
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not available for budget chart');
      return;
    }
    
    budgetChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: categories,
        datasets: [
          {
            label: 'Budget',
            data: budgeted,
            backgroundColor: 'rgba(32, 45, 84, 0.6)',
            borderColor: 'rgba(32, 45, 84, 1)',
            borderWidth: 1
          },
          {
            label: 'Actual',
            data: actual,
            backgroundColor: 'rgba(72, 187, 120, 0.6)',
            borderColor: 'rgba(72, 187, 120, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
  }
  
  function updateCategoryChart(categories, amounts) {
    const ctx = document.getElementById('category-chart');
    if (!ctx) return;
    
    if (categoryChart) {
      categoryChart.destroy();
    }
    
    const colors = [
      'rgba(255, 99, 132, 0.8)',
      'rgba(54, 162, 235, 0.8)',
      'rgba(255, 206, 86, 0.8)',
      'rgba(75, 192, 192, 0.8)',
      'rgba(153, 102, 255, 0.8)',
      'rgba(255, 159, 64, 0.8)',
      'rgba(199, 199, 199, 0.8)',
      'rgba(83, 102, 255, 0.8)',
      'rgba(255, 99, 255, 0.8)',
      'rgba(99, 255, 132, 0.8)'
    ];
    
    // Ensure Chart is available before creating
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not available for category chart');
      return;
    }
    
    categoryChart = new Chart(ctx, {
      type: categoryChartType,
      data: {
        labels: categories,
        datasets: [{
          data: amounts,
          backgroundColor: colors.slice(0, categories.length),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: categoryChartType === 'doughnut' ? 'right' : 'top',
            display: categoryChartType === 'doughnut'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = fmt(context.parsed);
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return categoryChartType === 'doughnut' 
                  ? `${label}: ${value} (${percentage}%)`
                  : `${label}: ${value}`;
              }
            }
          }
        },
        scales: categoryChartType === 'bar' ? {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString();
              }
            }
          }
        } : {}
      }
    });
  }
  
  function updateTrendChart(months, amounts) {
    const ctx = document.getElementById('trend-chart');
    if (!ctx) return;
    
    if (trendChart) {
      trendChart.destroy();
    }
    
    // Ensure Chart is available before creating
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not available for trend chart');
      return;
    }
    
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [{
          label: 'Monthly Spending',
          data: amounts,
          borderColor: 'rgba(32, 45, 84, 1)',
          backgroundColor: 'rgba(32, 45, 84, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '€' + value.toLocaleString();
              }
            }
          }
        }
      }
    });
  }
  
  window.initializeDashboardPage = async function(){
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
      console.error('Dashboard: Chart.js not loaded');
      const dashboardContainer = document.querySelector('.content-area');
      if (dashboardContainer) {
        dashboardContainer.innerHTML = '<div class="card"><div class="card-body text-center"><h3>Error Loading Charts</h3><p>Chart library failed to load. Please refresh the page.</p></div></div>';
      }
      return;
    }

    // Check if TransactionService is available
    if (!window.TransactionService) {
      console.error('Dashboard: TransactionService not loaded');
      return;
    }

    // Wait for authentication to be ready
    const currentUser = window.getCurrentUser();
    if (!currentUser && window.firebase && window.firebase.auth) {
      // Wait a bit for auth to settle
      await new Promise(resolve => setTimeout(resolve, 500));
      const user = window.getCurrentUser() || (window.firebase.auth().currentUser);
      if (!user) {
        console.error('Dashboard: User not authenticated, redirecting to auth');
        // Show auth screen instead
        const authEl = document.getElementById('auth');
        const contentEl = document.getElementById('content');
        if (authEl) authEl.style.display = '';
        if (contentEl) contentEl.style.display = 'none';
        return;
      }
    }
    
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    
    // Show page progress
    window.showPageProgress(10);
    
    // Show loading states for different sections
    const dashboardContainer = document.querySelector('.content-area');
    const recentTableBody = document.getElementById('dash-recent');
    
    if (recentTableBody) {
      window.showTableSkeleton(recentTableBody, 5, 5);
    }
    
    // Show skeleton loading for metric cards
    const metricCards = document.querySelectorAll('.grid-4 .card h2');
    metricCards.forEach(card => {
      if (card) {
        card.innerHTML = '<div class="skeleton skeleton-text" style="width: 80px; height: 24px;"></div>';
      }
    });
    
    try {
      window.showPageProgress(30);
      
      // Fetch current month data using TransactionService
      const monthStart = `${year}-${String(month).padStart(2,'0')}-01`;
      const monthEnd = `${year}-${String(month).padStart(2,'0')}-31`;
      
      // Fetch data using the clean TransactionService
      let recentExpenses = [];
      let allTransactions = [];

      try {
        [recentExpenses, allTransactions] = await Promise.all([
          window.TransactionService.getList({ type: 'expense', startDate: monthStart, endDate: monthEnd, limit: 10 })
            .catch(err => {
              console.warn('Failed to fetch recent expenses:', err);
              return [];
            }),
          window.TransactionService.getList({ limit: 1000 })  // Get all transactions to calculate income and expenses
            .catch(err => {
              console.warn('Failed to fetch all transactions:', err);
              return [];
            })
        ]);
      } catch (e) {
        console.warn('TransactionService error:', e);
        recentExpenses = [];
        allTransactions = [];
      }
      
      window.showPageProgress(70);
      
      // Calculate budget data from transactions
      const currentMonthExpenses = allTransactions.filter(t => {
        if (t.type !== 'expense') return false;
        const d = new Date(t.date);
        return d.getFullYear() === year && d.getMonth() === month - 1;
      });
      
      const totalSpent = currentMonthExpenses.reduce((sum, e) => sum + Math.abs(e.amount || 0), 0);
      const totalBudget = 10000; // Default budget - could be made configurable
      
      // Group by category
      const categoriesGrouped = {};
      currentMonthExpenses.forEach(e => {
        const cat = e.category || 'Uncategorized';
        if (!categoriesGrouped[cat]) {
          categoriesGrouped[cat] = { total: 1500, spent: 0 };
        }
        categoriesGrouped[cat].spent += Math.abs(e.amount || 0);
      });
      
      const budget = { totalBudget, totalSpent, categoriesGrouped };
      
      // Update metric cards
      document.getElementById('dash-month-expenses').textContent = fmt(budget.totalSpent || 0);
      const remaining = (budget.totalBudget || 0) - (budget.totalSpent || 0);
      const remainingEl = document.getElementById('dash-budget-remaining');
      remainingEl.textContent = fmt(remaining);
      remainingEl.className = remaining < 0 ? 'text-danger' : remaining < 500 ? 'text-warning' : 'text-success';
      
      // Update budget progress bar
      const progress = budget.totalBudget > 0 ? (budget.totalSpent / budget.totalBudget * 100) : 0;
      const progressBar = document.getElementById('dash-budget-progress');
      progressBar.style.width = Math.min(progress, 100) + '%';
      progressBar.style.background = progress > 100 ? 'var(--color-danger)' : progress > 80 ? 'var(--color-warning)' : 'var(--color-secondary)';
      
      // Calculate expense trend
      const lastMonth = new Date(year, month - 2, 1);
      const lastMonthExpenses = allTransactions.filter(t => {
        if (t.type !== 'expense') return false;
        const d = new Date(t.date);
        return d.getFullYear() === lastMonth.getFullYear() && d.getMonth() === lastMonth.getMonth();
      });
      const lastMonthTotal = lastMonthExpenses.reduce((sum, e) => sum + Math.abs(e.amount || 0), 0);
      const trendPercent = lastMonthTotal > 0 ? ((budget.totalSpent - lastMonthTotal) / lastMonthTotal * 100) : 0;
      const trendEl = document.getElementById('dash-expense-trend');
      if (trendPercent > 0) {
        trendEl.innerHTML = `<span style="color:var(--color-danger)">↑ ${trendPercent.toFixed(1)}% vs last month</span>`;
      } else if (trendPercent < 0) {
        trendEl.innerHTML = `<span style="color:var(--color-secondary)">↓ ${Math.abs(trendPercent).toFixed(1)}% vs last month</span>`;
      } else {
        trendEl.textContent = 'Same as last month';
      }
      
      // Load cash & banking data using TransactionService
      try {
        const balances = await window.TransactionService.getBalances();
        const cashBalance = balances.cash?.current_balance || 0;
        const bankBalance = balances.bank?.current_balance || 0;
        
        document.getElementById('dash-cash').textContent = fmt(cashBalance);
        
        // Calculate this month's income from transactions
        const monthIncomes = allTransactions.filter(t => {
          if (t.type !== 'income') return false;
          const d = new Date(t.date);
          return d.getFullYear() === year && d.getMonth() === month - 1;
        });
        
        const monthlyIncome = monthIncomes.reduce((sum, t) => sum + Math.abs(t.amount || 0), 0);
        
        // For pending donations, we'll use a placeholder since we don't have expected income implemented yet
        document.getElementById('dash-pending').textContent = fmt(0);
        document.getElementById('dash-donation-count').textContent = '0 expected';
      } catch (e) {
        console.warn('Balance data unavailable:', e);
        document.getElementById('dash-cash').textContent = fmt(0);
        document.getElementById('dash-pending').textContent = fmt(0);
        document.getElementById('dash-donation-count').textContent = '0 expected';
      }
      
      // Prepare chart data
      const categories = Object.keys(budget.categoriesGrouped || {});
      const budgetAmounts = categories.map(cat => budget.categoriesGrouped[cat].total || 0);
      const actualAmounts = categories.map(cat => budget.categoriesGrouped[cat].spent || 0);
      
      // Update charts
      if (categories.length > 0) {
        updateBudgetChart(categories, budgetAmounts, actualAmounts);
        updateCategoryChart(categories, actualAmounts);
      } else {
        // Show sample data if no real data exists
        updateBudgetChart(
          ['Administration', 'Programs', 'Facilities', 'Supplies'],
          [2000, 5000, 1500, 1000],
          [1800, 4200, 1600, 850]
        );
        updateCategoryChart(
          ['Administration', 'Programs', 'Facilities', 'Supplies', 'Other'],
          [1800, 4200, 1600, 850, 300]
        );
      }
      
      // Calculate monthly trend (last 12 months)
      const monthlyTotals = {};
      const twelveMonthsAgo = new Date(year, month - 13, 1);
      
      allTransactions.filter(t => t.type === 'expense').forEach(e => {
        const d = new Date(e.date);
        if (d >= twelveMonthsAgo) {
          const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          monthlyTotals[key] = (monthlyTotals[key] || 0) + Math.abs(e.amount || 0);
        }
      });
      
      const trendMonths = [];
      const trendAmounts = [];
      for (let i = 11; i >= 0; i--) {
        const d = new Date(year, month - 1 - i, 1);
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        trendMonths.push(getMonthName(d.getMonth() + 1));
        trendAmounts.push(monthlyTotals[key] || 0);
      }
      
      if (trendAmounts.some(a => a > 0)) {
        updateTrendChart(trendMonths, trendAmounts);
      } else {
        // Show sample trend if no data
        updateTrendChart(
          ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          [8500, 9200, 8800, 9500, 10200, 9800, 9600, 10100, 9900, 10500, 9700, 0]
        );
      }
      
      window.showPageProgress(90);
      
      // Update recent expenses table with fade effect
      const tbody = document.getElementById('dash-recent');
      
      // Clear skeleton loading
      tbody.innerHTML = '';
      
      if (recentExpenses.length > 0) {
        recentExpenses.slice(0, 10).forEach((e, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${e.date || ''}</td>
            <td>${e.category || ''}</td>
            <td>${e.subcategory || ''}</td>
            <td>${(e.description || '').replace(/</g, '&lt;')}</td>
            <td class="text-right">${fmt(Math.abs(e.amount) || 0)}</td>
          `;
          
          // Add fade-in animation with staggered delay
          tr.style.opacity = '0';
          tr.style.transform = 'translateY(10px)';
          tr.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          tbody.appendChild(tr);
          
          setTimeout(() => {
            tr.style.opacity = '1';
            tr.style.transform = 'translateY(0)';
          }, 50 * index);
        });
      } else {
        window.showEmptyState(tbody, '💸', 'No expenses found', 'No expenses recorded for this month');
      }
      
      // Handle period selector
      document.getElementById('chart-period').addEventListener('change', async (e) => {
        const period = e.target.value;
        const chartContainer = e.target.closest('.card');
        
        try {
          window.showLoading(chartContainer, 'Updating chart...');
          
          // This would fetch different period data and update charts
          // For now, just showing the concept with delay
          await new Promise(resolve => setTimeout(resolve, 1000));
          console.log('Period changed to:', period);
          
          window.hideLoading(chartContainer);
        } catch (error) {
          window.hideLoading(chartContainer);
          console.error('Chart update failed:', error);
        }
      });
      
      // Complete page loading
      window.showPageProgress(100);
      
      // Add fade-in effect to the entire content
      const contentArea = document.querySelector('.content-area');
      if (contentArea) {
        contentArea.style.opacity = '0';
        contentArea.style.transform = 'translateY(20px)';
        contentArea.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        
        setTimeout(() => {
          contentArea.style.opacity = '1';
          contentArea.style.transform = 'translateY(0)';
        }, 100);
      }
      
    } catch (e) {
      console.error('Dashboard load failed', e);
      window.showPageProgress(100);
      
      const tbody = document.getElementById('dash-recent');
      if (tbody) {
        window.showEmptyState(tbody, '❌', 'Failed to load data', 'Please refresh the page to try again');
      }
      
      // Show error state for metric cards
      const metricCards = document.querySelectorAll('.grid-4 .card h2');
      metricCards.forEach(card => {
        if (card) {
          card.textContent = '€--';
          card.style.color = '#ef4444';
        }
      });
    }
  }
  
  window.registerPageInitializer('dashboard', window.initializeDashboardPage);
})();
</script>