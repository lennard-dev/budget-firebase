<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chart of Accounts System</title>
    <link rel="stylesheet" href="/legacy/shared.css">
    <style>
        body {
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
        }
        .test-card h3 {
            margin-top: 0;
            color: #4f46e5;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background: #4338ca;
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-warning {
            background: #f59e0b;
            color: white;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        .status.warning {
            background: #fed7aa;
            color: #9a3412;
        }
        .result-box {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .account-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .account-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .account-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .account-table tr:hover {
            background: #f9fafb;
        }
        .account-code {
            font-family: monospace;
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .test-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .progress-item {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        .progress-item.complete {
            background: #10b981;
            color: white;
        }
        .progress-item.pending {
            background: #e5e7eb;
            color: #6b7280;
        }
        .progress-item.running {
            background: #3b82f6;
            color: white;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Chart of Accounts System Testing</h1>
        <p>Comprehensive testing suite for the professional accounting backend</p>
    </div>

    <!-- Test Suite 1: Account Structure -->
    <div class="test-section">
        <h2>1. Account Structure Tests</h2>
        <div class="test-grid">
            <div class="test-card">
                <h3>Verify All 55 Accounts</h3>
                <button class="btn btn-primary" onclick="testAllAccounts()">Run Test</button>
                <div id="allAccountsResult"></div>
            </div>
            <div class="test-card">
                <h3>Test Account Hierarchy</h3>
                <button class="btn btn-primary" onclick="testAccountHierarchy()">Run Test</button>
                <div id="hierarchyResult"></div>
            </div>
            <div class="test-card">
                <h3>Validate Account Codes</h3>
                <button class="btn btn-primary" onclick="testAccountCodes()">Run Test</button>
                <div id="codesResult"></div>
            </div>
        </div>
    </div>

    <!-- Test Suite 2: Transaction Integration -->
    <div class="test-section">
        <h2>2. Transaction Integration Tests</h2>
        <div class="test-grid">
            <div class="test-card">
                <h3>Create Test Transactions</h3>
                <button class="btn btn-success" onclick="createTestTransactions()">Create Transactions</button>
                <div id="transactionsResult"></div>
            </div>
            <div class="test-card">
                <h3>Verify Journal Entries</h3>
                <button class="btn btn-primary" onclick="testJournalEntries()">Run Test</button>
                <div id="journalResult"></div>
            </div>
            <div class="test-card">
                <h3>Test Balance Calculations</h3>
                <button class="btn btn-primary" onclick="testBalances()">Run Test</button>
                <div id="balancesResult"></div>
            </div>
        </div>
    </div>

    <!-- Test Suite 3: Category Operations -->
    <div class="test-section">
        <h2>3. Category Operations Tests</h2>
        <div class="test-grid">
            <div class="test-card">
                <h3>Test Category Rename</h3>
                <input type="text" id="renameInput" placeholder="New category name" style="width: 100%; padding: 8px; margin: 10px 0;">
                <button class="btn btn-warning" onclick="testCategoryRename()">Test Rename</button>
                <div id="renameResult"></div>
            </div>
            <div class="test-card">
                <h3>Test Delete Validation</h3>
                <button class="btn btn-danger" onclick="testDeleteValidation()">Test Delete</button>
                <div id="deleteResult"></div>
            </div>
            <div class="test-card">
                <h3>Test Budget Updates</h3>
                <input type="number" id="budgetInput" placeholder="Monthly budget" style="width: 100%; padding: 8px; margin: 10px 0;">
                <button class="btn btn-primary" onclick="testBudgetUpdate()">Update Budget</button>
                <div id="budgetResult"></div>
            </div>
        </div>
    </div>

    <!-- Test Suite 4: API Compatibility -->
    <div class="test-section">
        <h2>4. API Compatibility Tests</h2>
        <div class="test-grid">
            <div class="test-card">
                <h3>Test Categories Endpoint</h3>
                <button class="btn btn-primary" onclick="testCategoriesAPI()">Test API</button>
                <div id="categoriesAPIResult"></div>
            </div>
            <div class="test-card">
                <h3>Test Translation Layer</h3>
                <button class="btn btn-primary" onclick="testTranslationLayer()">Test Translation</button>
                <div id="translationResult"></div>
            </div>
            <div class="test-card">
                <h3>Test Cache Performance</h3>
                <button class="btn btn-primary" onclick="testCachePerformance()">Test Cache</button>
                <div id="cacheResult"></div>
            </div>
        </div>
    </div>

    <!-- Test Results Summary -->
    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="summaryResults">
            <p>Run tests to see results...</p>
        </div>
        <div class="test-progress">
            <span>Progress:</span>
            <span class="progress-item pending" id="progress-structure">Structure</span>
            <span class="progress-item pending" id="progress-transactions">Transactions</span>
            <span class="progress-item pending" id="progress-operations">Operations</span>
            <span class="progress-item pending" id="progress-api">API</span>
        </div>
    </div>

    <!-- Detailed Account View -->
    <div class="test-section">
        <h2>Chart of Accounts Overview</h2>
        <button class="btn btn-primary" onclick="loadChartOverview()">Load Chart</button>
        <div id="chartOverview"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDocs, 
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            query,
            where,
            orderBy,
            limit,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCVLij8nih7vPqLfmxTTrNGDGaY8wJrGBY",
            authDomain: "budget-v01.firebaseapp.com",
            projectId: "budget-v01",
            storageBucket: "budget-v01.firebasestorage.app",
            messagingSenderId: "459584204952",
            appId: "1:459584204952:web:0c1e0f2fb3b1eb37508c52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = 'test-user-001';
        const API_URL = 'https://budget-v01.web.app/api';

        // Test results tracking
        const testResults = {
            structure: { passed: 0, failed: 0 },
            transactions: { passed: 0, failed: 0 },
            operations: { passed: 0, failed: 0 },
            api: { passed: 0, failed: 0 }
        };

        // Helper function to show result
        function showResult(elementId, success, message, details = null) {
            const element = document.getElementById(elementId);
            const statusClass = success ? 'success' : 'error';
            let html = `<div class="status ${statusClass}">${message}</div>`;
            if (details) {
                html += `<div class="result-box">${details}</div>`;
            }
            element.innerHTML = html;
        }

        // Test 1.1: Verify All 55 Accounts
        window.testAllAccounts = async function() {
            try {
                const accountsSnap = await getDocs(
                    collection(db, 'users', uid, 'chart_of_accounts')
                );
                
                const accounts = accountsSnap.docs.map(doc => ({
                    code: doc.id,
                    ...doc.data()
                }));
                
                // Expected: 5 system + 9 categories + 41 subcategories = 55
                const systemAccounts = accounts.filter(a => a.system_account);
                const categories = accounts.filter(a => a.display_as === 'category');
                const subcategories = accounts.filter(a => a.display_as === 'subcategory');
                
                const details = `Total Accounts: ${accounts.length}
System Accounts: ${systemAccounts.length}
Categories: ${categories.length}
Subcategories: ${subcategories.length}

Categories Found:
${categories.map(c => `- ${c.category_name || c.account_name} (${c.code})`).join('\n')}`;
                
                const success = accounts.length === 55;
                showResult('allAccountsResult', success, 
                    success ? '✅ All 55 accounts present!' : `❌ Expected 55 accounts, found ${accounts.length}`,
                    details
                );
                
                testResults.structure[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('allAccountsResult', false, '❌ Error: ' + error.message);
                testResults.structure.failed++;
            }
        };

        // Test 1.2: Test Account Hierarchy
        window.testAccountHierarchy = async function() {
            try {
                const accountsSnap = await getDocs(
                    collection(db, 'users', uid, 'chart_of_accounts')
                );
                
                const accounts = {};
                accountsSnap.docs.forEach(doc => {
                    accounts[doc.id] = doc.data();
                });
                
                let hierarchyIssues = [];
                let validHierarchies = 0;
                
                for (const [code, account] of Object.entries(accounts)) {
                    if (account.parent_code) {
                        if (accounts[account.parent_code]) {
                            validHierarchies++;
                        } else {
                            hierarchyIssues.push(`${code} references missing parent ${account.parent_code}`);
                        }
                    }
                }
                
                const details = `Valid parent-child relationships: ${validHierarchies}
${hierarchyIssues.length ? 'Issues:\n' + hierarchyIssues.join('\n') : 'No hierarchy issues found'}`;
                
                const success = hierarchyIssues.length === 0;
                showResult('hierarchyResult', success,
                    success ? '✅ Hierarchy structure valid!' : `❌ Found ${hierarchyIssues.length} hierarchy issues`,
                    details
                );
                
                testResults.structure[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('hierarchyResult', false, '❌ Error: ' + error.message);
                testResults.structure.failed++;
            }
        };

        // Test 1.3: Validate Account Codes
        window.testAccountCodes = async function() {
            try {
                const accountsSnap = await getDocs(
                    collection(db, 'users', uid, 'chart_of_accounts')
                );
                
                const codeIssues = [];
                const validCodes = [];
                
                accountsSnap.docs.forEach(doc => {
                    const code = doc.id;
                    const data = doc.data();
                    
                    // Check code format (should be 4 digits)
                    if (!/^\d{4}$/.test(code)) {
                        codeIssues.push(`Invalid format: ${code}`);
                    } else {
                        validCodes.push(`${code} - ${data.account_name}`);
                    }
                    
                    // Check code matches account_code field
                    if (code !== data.account_code) {
                        codeIssues.push(`Mismatch: doc.id=${code} but account_code=${data.account_code}`);
                    }
                });
                
                const details = `Valid Codes: ${validCodes.length}
${codeIssues.length ? 'Issues:\n' + codeIssues.join('\n') : 'All codes valid!'}

Sample Codes:
${validCodes.slice(0, 10).join('\n')}`;
                
                const success = codeIssues.length === 0;
                showResult('codesResult', success,
                    success ? '✅ All account codes valid!' : `❌ Found ${codeIssues.length} code issues`,
                    details
                );
                
                testResults.structure[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('codesResult', false, '❌ Error: ' + error.message);
                testResults.structure.failed++;
            }
        };

        // Test 2.1: Create Test Transactions
        window.createTestTransactions = async function() {
            try {
                const testTransactions = [
                    {
                        date: new Date().toISOString().split('T')[0],
                        type: 'expense',
                        subtype: 'Cash',
                        account: 'cash',
                        amount: -150,
                        description: 'Test: Office Supplies Purchase',
                        category: 'Administration',
                        subcategory: 'Office Supplies',
                        payment_method: 'Cash'
                    },
                    {
                        date: new Date().toISOString().split('T')[0],
                        type: 'expense',
                        subtype: 'Bank Transfer',
                        account: 'bank',
                        amount: -500,
                        description: 'Test: Monthly Rent Payment',
                        category: 'Facility',
                        subcategory: 'Rent',
                        payment_method: 'Bank Transfer'
                    },
                    {
                        date: new Date().toISOString().split('T')[0],
                        type: 'income',
                        subtype: 'donation',
                        account: 'bank',
                        amount: 1000,
                        description: 'Test: Monthly Donation',
                        category: 'Donations'
                    }
                ];
                
                const results = [];
                for (const txn of testTransactions) {
                    const response = await fetch(`${API_URL}/transactions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock-token'
                        },
                        body: JSON.stringify(txn)
                    });
                    
                    const result = await response.json();
                    results.push({
                        description: txn.description,
                        success: response.ok,
                        id: result.id,
                        account_code: result.account_code,
                        journal_entries: result.journal_entries
                    });
                }
                
                const details = results.map(r => 
                    `${r.success ? '✅' : '❌'} ${r.description}
  ID: ${r.id || 'failed'}
  Account Code: ${r.account_code || 'none'}
  Journal Entries: ${r.journal_entries ? r.journal_entries.length : 0}`
                ).join('\n\n');
                
                const allSuccess = results.every(r => r.success);
                showResult('transactionsResult', allSuccess,
                    allSuccess ? '✅ All test transactions created!' : '❌ Some transactions failed',
                    details
                );
                
                testResults.transactions[allSuccess ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('transactionsResult', false, '❌ Error: ' + error.message);
                testResults.transactions.failed++;
            }
        };

        // Test 2.2: Verify Journal Entries
        window.testJournalEntries = async function() {
            try {
                // Get recent transactions
                const txnSnap = await getDocs(
                    query(
                        collection(db, 'users', uid, 'all-transactions'),
                        orderBy('timestamp', 'desc'),
                        limit(5)
                    )
                );
                
                let journalIssues = [];
                let validJournals = 0;
                
                txnSnap.docs.forEach(doc => {
                    const txn = doc.data();
                    if (txn.journal_entries) {
                        // Check double-entry balance
                        const totalDebits = txn.journal_entries.reduce((sum, e) => sum + (e.debit || 0), 0);
                        const totalCredits = txn.journal_entries.reduce((sum, e) => sum + (e.credit || 0), 0);
                        
                        if (Math.abs(totalDebits - totalCredits) < 0.01) {
                            validJournals++;
                        } else {
                            journalIssues.push(`Transaction ${doc.id}: Debits=${totalDebits}, Credits=${totalCredits}`);
                        }
                    }
                });
                
                const details = `Transactions with valid journal entries: ${validJournals}
${journalIssues.length ? 'Unbalanced entries:\n' + journalIssues.join('\n') : 'All journal entries balanced!'}`;
                
                const success = journalIssues.length === 0 && validJournals > 0;
                showResult('journalResult', success,
                    success ? '✅ Journal entries balanced!' : `❌ Found ${journalIssues.length} unbalanced entries`,
                    details
                );
                
                testResults.transactions[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('journalResult', false, '❌ Error: ' + error.message);
                testResults.transactions.failed++;
            }
        };

        // Test 2.3: Test Balance Calculations
        window.testBalances = async function() {
            try {
                const response = await fetch(`${API_URL}/ledger/cash?limit=10`, {
                    headers: {
                        'Authorization': 'Bearer mock-token'
                    }
                });
                
                const ledgerData = await response.json();
                
                if (!ledgerData.entries || ledgerData.entries.length === 0) {
                    showResult('balancesResult', false, '⚠️ No ledger entries found', 
                        'Run "Create Test Transactions" first');
                    return;
                }
                
                // Check balance continuity
                let balanceIssues = [];
                for (let i = 1; i < ledgerData.entries.length; i++) {
                    const prev = ledgerData.entries[i - 1];
                    const curr = ledgerData.entries[i];
                    
                    // The balance_after of previous should equal balance_before of current
                    // (when reading newest to oldest)
                    if (Math.abs(prev.display_balance - (curr.display_balance - curr.amount)) > 0.01) {
                        balanceIssues.push(`Discontinuity between entries ${i-1} and ${i}`);
                    }
                }
                
                const details = `Current Balance: $${ledgerData.currentBalance}
Entries Checked: ${ledgerData.entries.length}
Balance Issues: ${balanceIssues.length}
${balanceIssues.length ? '\nIssues:\n' + balanceIssues.join('\n') : '\nAll balances continuous!'}`;
                
                const success = balanceIssues.length === 0;
                showResult('balancesResult', success,
                    success ? '✅ Balance calculations correct!' : `❌ Found ${balanceIssues.length} balance issues`,
                    details
                );
                
                testResults.transactions[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('balancesResult', false, '❌ Error: ' + error.message);
                testResults.transactions.failed++;
            }
        };

        // Test 3.1: Test Category Rename
        window.testCategoryRename = async function() {
            try {
                const newName = document.getElementById('renameInput').value;
                if (!newName) {
                    showResult('renameResult', false, '⚠️ Please enter a new category name');
                    return;
                }
                
                // Update Administration category to new name
                const accountCode = '5100'; // Administration category
                
                const response = await fetch(`${API_URL}/accounts/${accountCode}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mock-token'
                    },
                    body: JSON.stringify({
                        category_name: newName,
                        account_name: newName + ' Expenses'
                    })
                });
                
                const result = await response.json();
                
                // Check if transactions were updated
                const txnSnap = await getDocs(
                    query(
                        collection(db, 'users', uid, 'all-transactions'),
                        where('category', '==', 'Administration'),
                        limit(1)
                    )
                );
                
                const details = `Account renamed: ${result.success}
Original: Administration
New: ${newName}
Transactions to update: ${txnSnap.size}`;
                
                showResult('renameResult', result.success,
                    result.success ? '✅ Category renamed successfully!' : '❌ Rename failed',
                    details
                );
                
                testResults.operations[result.success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('renameResult', false, '❌ Error: ' + error.message);
                testResults.operations.failed++;
            }
        };

        // Test 3.2: Test Delete Validation
        window.testDeleteValidation = async function() {
            try {
                // Try to delete a category that has transactions
                const response = await fetch(`${API_URL}/accounts/5100`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer mock-token'
                    }
                });
                
                const result = await response.json();
                
                // Should fail if category has transactions
                const shouldFail = response.status === 400 || response.status === 409;
                const details = `Status Code: ${response.status}
Message: ${result.error || result.message}
${shouldFail ? 'Correctly prevented deletion of category in use' : 'Category deletion handling needs review'}`;
                
                showResult('deleteResult', shouldFail,
                    shouldFail ? '✅ Delete validation working!' : '⚠️ Delete validation needs review',
                    details
                );
                
                testResults.operations[shouldFail ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('deleteResult', false, '❌ Error: ' + error.message);
                testResults.operations.failed++;
            }
        };

        // Test 3.3: Test Budget Updates
        window.testBudgetUpdate = async function() {
            try {
                const budget = document.getElementById('budgetInput').value;
                if (!budget) {
                    showResult('budgetResult', false, '⚠️ Please enter a budget amount');
                    return;
                }
                
                const response = await fetch(`${API_URL}/accounts/5100`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer mock-token'
                    },
                    body: JSON.stringify({
                        budget_monthly: parseFloat(budget),
                        budget_annual: parseFloat(budget) * 12
                    })
                });
                
                const result = await response.json();
                
                // Verify update
                const accountDoc = await getDoc(
                    doc(db, 'users', uid, 'chart_of_accounts', '5100')
                );
                const accountData = accountDoc.data();
                
                const details = `Monthly Budget: $${budget}
Annual Budget: $${parseFloat(budget) * 12}
Update Success: ${result.success}
Verified in DB: ${accountData.budget_monthly === parseFloat(budget)}`;
                
                const success = result.success && accountData.budget_monthly === parseFloat(budget);
                showResult('budgetResult', success,
                    success ? '✅ Budget updated successfully!' : '❌ Budget update failed',
                    details
                );
                
                testResults.operations[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('budgetResult', false, '❌ Error: ' + error.message);
                testResults.operations.failed++;
            }
        };

        // Test 4.1: Test Categories API
        window.testCategoriesAPI = async function() {
            try {
                const response = await fetch(`${API_URL}/categories`, {
                    headers: {
                        'Authorization': 'Bearer mock-token'
                    }
                });
                
                const categories = await response.json();
                
                const details = `Categories returned: ${categories.length}
Sample:
${categories.slice(0, 3).map(c => 
    `- ${c.name} (${c.category_id})
  Subcategories: ${c.subcategories ? c.subcategories.length : 0}`
).join('\n')}`;
                
                const success = response.ok && categories.length > 0;
                showResult('categoriesAPIResult', success,
                    success ? '✅ Categories API working!' : '❌ Categories API failed',
                    details
                );
                
                testResults.api[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('categoriesAPIResult', false, '❌ Error: ' + error.message);
                testResults.api.failed++;
            }
        };

        // Test 4.2: Test Translation Layer
        window.testTranslationLayer = async function() {
            try {
                const testCases = [
                    { category: 'Administration', subcategory: 'Office Supplies', expected: '5110' },
                    { category: 'Facility', subcategory: 'Rent', expected: '5301' },
                    { category: 'Transportation', subcategory: 'Vehicle Rental', expected: '5601' }
                ];
                
                const results = [];
                for (const test of testCases) {
                    const response = await fetch(`${API_URL}/accounts/lookup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer mock-token'
                        },
                        body: JSON.stringify(test)
                    });
                    
                    const result = await response.json();
                    results.push({
                        ...test,
                        actual: result.account_code,
                        success: result.account_code === test.expected
                    });
                }
                
                const details = results.map(r => 
                    `${r.success ? '✅' : '❌'} ${r.category}/${r.subcategory}
  Expected: ${r.expected}, Got: ${r.actual}`
                ).join('\n\n');
                
                const allSuccess = results.every(r => r.success);
                showResult('translationResult', allSuccess,
                    allSuccess ? '✅ Translation layer working!' : '❌ Translation issues found',
                    details
                );
                
                testResults.api[allSuccess ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('translationResult', false, '❌ Error: ' + error.message);
                testResults.api.failed++;
            }
        };

        // Test 4.3: Test Cache Performance
        window.testCachePerformance = async function() {
            try {
                // Make multiple requests to test caching
                const iterations = 10;
                const start = Date.now();
                
                for (let i = 0; i < iterations; i++) {
                    await fetch(`${API_URL}/categories`, {
                        headers: {
                            'Authorization': 'Bearer mock-token'
                        }
                    });
                }
                
                const elapsed = Date.now() - start;
                const avgTime = elapsed / iterations;
                
                const details = `Total requests: ${iterations}
Total time: ${elapsed}ms
Average time: ${avgTime.toFixed(2)}ms
Cache effectiveness: ${avgTime < 100 ? 'Excellent' : avgTime < 200 ? 'Good' : 'Needs optimization'}`;
                
                const success = avgTime < 200;
                showResult('cacheResult', success,
                    success ? '✅ Cache performance good!' : '⚠️ Cache could be optimized',
                    details
                );
                
                testResults.api[success ? 'passed' : 'failed']++;
                updateProgress();
            } catch (error) {
                showResult('cacheResult', false, '❌ Error: ' + error.message);
                testResults.api.failed++;
            }
        };

        // Load Chart Overview
        window.loadChartOverview = async function() {
            try {
                const accountsSnap = await getDocs(
                    collection(db, 'users', uid, 'chart_of_accounts')
                );
                
                const accounts = {};
                accountsSnap.docs.forEach(doc => {
                    const data = doc.data();
                    accounts[doc.id] = data;
                });
                
                // Build hierarchical view
                let html = '<table class="account-table"><thead><tr>';
                html += '<th>Code</th><th>Account Name</th><th>Type</th><th>Display</th><th>Category</th><th>Subcategory</th>';
                html += '</tr></thead><tbody>';
                
                // Sort by account code
                const sortedAccounts = Object.entries(accounts).sort((a, b) => 
                    a[0].localeCompare(b[0])
                );
                
                for (const [code, account] of sortedAccounts) {
                    const isParent = !account.parent_code;
                    const style = isParent ? 'font-weight: bold; background: #f0f9ff;' : 'padding-left: 30px;';
                    
                    html += `<tr style="${style}">`;
                    html += `<td><span class="account-code">${code}</span></td>`;
                    html += `<td>${account.account_name}</td>`;
                    html += `<td>${account.account_type}</td>`;
                    html += `<td>${account.display_as}</td>`;
                    html += `<td>${account.category_name || '-'}</td>`;
                    html += `<td>${account.subcategory_name || '-'}</td>`;
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
                
                document.getElementById('chartOverview').innerHTML = html;
            } catch (error) {
                document.getElementById('chartOverview').innerHTML = 
                    `<div class="status error">Error loading chart: ${error.message}</div>`;
            }
        };

        // Update progress indicators
        function updateProgress() {
            // Update individual progress items
            if (testResults.structure.passed > 0 || testResults.structure.failed > 0) {
                document.getElementById('progress-structure').className = 
                    testResults.structure.failed === 0 ? 'progress-item complete' : 'progress-item running';
            }
            if (testResults.transactions.passed > 0 || testResults.transactions.failed > 0) {
                document.getElementById('progress-transactions').className = 
                    testResults.transactions.failed === 0 ? 'progress-item complete' : 'progress-item running';
            }
            if (testResults.operations.passed > 0 || testResults.operations.failed > 0) {
                document.getElementById('progress-operations').className = 
                    testResults.operations.failed === 0 ? 'progress-item complete' : 'progress-item running';
            }
            if (testResults.api.passed > 0 || testResults.api.failed > 0) {
                document.getElementById('progress-api').className = 
                    testResults.api.failed === 0 ? 'progress-item complete' : 'progress-item running';
            }
            
            // Update summary
            const totalPassed = Object.values(testResults).reduce((sum, r) => sum + r.passed, 0);
            const totalFailed = Object.values(testResults).reduce((sum, r) => sum + r.failed, 0);
            const total = totalPassed + totalFailed;
            
            let summaryHtml = '<h3>Overall Results</h3>';
            summaryHtml += `<p>Total Tests Run: ${total}</p>`;
            summaryHtml += `<p style="color: #10b981;">✅ Passed: ${totalPassed}</p>`;
            summaryHtml += `<p style="color: #ef4444;">❌ Failed: ${totalFailed}</p>`;
            
            if (total > 0) {
                const successRate = ((totalPassed / total) * 100).toFixed(1);
                summaryHtml += `<p>Success Rate: ${successRate}%</p>`;
                
                if (successRate === '100.0') {
                    summaryHtml += '<div class="status success">🎉 All tests passed! Chart of Accounts system is fully operational!</div>';
                }
            }
            
            document.getElementById('summaryResults').innerHTML = summaryHtml;
        }

        // Initialize
        loadChartOverview();
    </script>
</body>
</html>