<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Budgets</title>
    <link rel="stylesheet" href="/shared.css" />
    <script defer src="/__/firebase/12.1.0/firebase-app-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-auth-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-firestore-compat.js"></script>
    <script defer src="/__/firebase/12.1.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <script defer src="/app.js"></script>
  </head>
  <body class="app-container" id="budget-page">
    <div class="nav-header">
      <div class="nav-brand"><h1>Paréa Lesvos Budget Management</h1></div>
      <nav class="nav-menu">
        <a href="/index.html" class="nav-link" data-page="dashboard"><span class="nav-icon">📊</span><span class="nav-text">Dashboard</span></a>
        <a href="/expenses.html" class="nav-link" data-page="expenses"><span class="nav-icon">💰</span><span class="nav-text">Expenses</span></a>
        <a href="/budgets.html" class="nav-link active" data-page="budget"><span class="nav-icon">📈</span><span class="nav-text">Budgets</span></a>
        <a href="/cash-banking.html" class="nav-link" data-page="cash-banking"><span class="nav-icon">🏦</span><span class="nav-text">Cash & Banking</span></a>
        <a href="/settings.html" class="nav-link" data-page="settings"><span class="nav-icon">⚙️</span><span class="nav-text">Settings</span></a>
        <button id="signout" class="btn btn-secondary" style="margin-left:12px;">Sign out</button>
      </nav>
    </div>
    <div class="content-area">
      <div class="page-header">
        <h2 class="page-title">Budget Management</h2>
        <div class="page-actions">
          <button class="btn btn-secondary btn-sm" id="prevMonth">← Previous</button>
          <select id="monthSelect" class="form-control" style="width: 220px;"></select>
          <button class="btn btn-secondary btn-sm" id="nextMonth">Next →</button>
          <button class="btn btn-primary" id="openSettings">⚙️ Set Budget</button>
          <a class="btn btn-secondary" href="/index.html">Home</a>
        </div>
      </div>

      <div class="budget-summary-row">
        <div class="budget-summary-card"><span class="summary-label">Total Budget</span><span id="s_totalBudget" class="summary-value">€0.00</span></div>
        <div class="budget-summary-card"><span class="summary-label">Total Spent</span><span id="s_totalSpent" class="summary-value text-danger">€0.00</span></div>
        <div class="budget-summary-card"><span class="summary-label">Remaining</span><span id="s_remaining" class="summary-value text-success">€0.00</span></div>
        <div class="budget-summary-card"><span class="summary-label">% Used</span><span id="s_percent" class="summary-value">0%</span></div>
      </div>

      <div class="card">
        <div class="card-body">
          <table class="budget-table" id="budgetTable">
            <thead>
              <tr>
                <th>Category</th>
                <th class="text-right">Budget</th>
                <th class="text-right">Spent</th>
                <th class="text-right">Remaining</th>
                <th class="text-center">% Used</th>
              </tr>
            </thead>
            <tbody id="budgetBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="budgetModal" class="modal">
      <div class="modal-content" style="max-width:900px;">
        <div class="modal-header">
          <h2>Set Monthly Budget</h2>
          <button class="btn btn-icon" id="bm_close_top"><span style="font-size:1.5rem;">×</span></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Total Monthly Budget (€)</label>
            <input type="number" id="bm_total" class="form-control" step="50" min="0" />
          </div>
          <div id="bm_rows"></div>
          <div class="mt-2"><strong>Total Allocated: <span id="bm_allocated">€0.00</span></strong></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="bm_close">Cancel</button>
          <button class="btn btn-primary" id="bm_save">Save Budget</button>
        </div>
      </div>
    </div>

    <script>
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      function fmt(amount){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'EUR'}).format(Number(amount)||0); }

      function selectedYearMonth(){ const v = document.getElementById('monthSelect').value; const [y,m] = v.split('-'); return { y:Number(y), m:Number(m) }; }
      function setMonthSelect(){
        const sel = document.getElementById('monthSelect');
        sel.innerHTML='';
        const now = new Date();
        for(let i=11;i>=0;i--){
          const d = new Date(); d.setMonth(d.getMonth()-i);
          const y=d.getFullYear(); const m=d.getMonth()+1; const opt=document.createElement('option');
          opt.value=`${y}-${String(m).padStart(2,'0')}`; opt.textContent=`${monthNames[m-1]} ${y}`; sel.appendChild(opt);
        }
        sel.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      }

      async function loadBudget(){
        const {y,m} = selectedYearMonth();
        const res = await window.callApi(`/budgets?year=${y}&month=${m}`);
        const data = res.data || { totalBudget:0, totalSpent:0, categoriesGrouped:{} };
        document.getElementById('s_totalBudget').textContent = fmt(data.totalBudget);
        document.getElementById('s_totalSpent').textContent = fmt(data.totalSpent||0);
        const remaining = (data.totalBudget||0) - (data.totalSpent||0);
        document.getElementById('s_remaining').textContent = fmt(remaining);
        const pct = (data.totalBudget>0) ? (data.totalSpent/data.totalBudget*100) : 0;
        document.getElementById('s_percent').textContent = `${pct.toFixed(1)}%`;

        const body = document.getElementById('budgetBody');
        body.innerHTML='';
        const grouped = data.categoriesGrouped || {};
        Object.entries(grouped).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([cat, obj])=>{
          const spent = Number(obj.spent)||0; const total = Number(obj.total)||0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="category-name"><strong>${cat}</strong></td>
            <td class="text-right">${fmt(total)}</td>
            <td class="text-right ${spent>total?'text-danger':''}">${fmt(spent)}</td>
            <td class="text-right">${fmt(total-spent)}</td>
            <td class="text-center">${total>0?((spent/total*100).toFixed(1)+'%'):'-'}</td>`;
          body.appendChild(tr);
          (obj.subcategories||[]).forEach(sc=>{
            const sspent = Number(sc.spent)||0; const bud = Number(sc.budgeted)||0;
            const tr2 = document.createElement('tr');
            tr2.className='subcategory-row';
            tr2.innerHTML = `
              <td class="subcategory-name">${sc.subcategory}</td>
              <td class="text-right">${fmt(bud)}</td>
              <td class="text-right ${sspent>bud?'text-danger':''}">${fmt(sspent)}</td>
              <td class="text-right">${fmt(bud-sspent)}</td>
              <td class="text-center">${bud>0?((sspent/bud*100).toFixed(1)+'%'):'-'}</td>`;
            body.appendChild(tr2);
          });
        });
      }

      function openBudgetModal(){ document.getElementById('budgetModal').style.display='block'; }
      function closeBudgetModal(){ document.getElementById('budgetModal').style.display='none'; }
      function euros(n){ return fmt(n); }

      async function openSettings(){
        const {y,m} = selectedYearMonth();
        const [budRes, catRes] = await Promise.all([
          window.callApi(`/budgets?year=${y}&month=${m}`),
          window.callApi('/categories')
        ]);
        const data = budRes.data || { totalBudget:0, categoriesGrouped:{} };
        const cats = (catRes.data||[]).sort((a,b)=>a.name.localeCompare(b.name));
        document.getElementById('bm_total').value = Number(data.totalBudget)||0;
        const container = document.getElementById('bm_rows');
        container.innerHTML='';
        cats.forEach(c=>{
          const catData = (data.categoriesGrouped||{})[c.name] || { total:0, subcategories:[] };
          const subMap = new Map((catData.subcategories||[]).map(s=>[s.subcategory, Number(s.budgeted)||0]));
          const wrap = document.createElement('div');
          wrap.className='budget-category-allocation mb-3';
          wrap.style.border='1px solid var(--color-border)'; wrap.style.padding='15px'; wrap.style.borderRadius='6px';
          const subs = (c.subcategories||[]);
          let inner = `<div class="grid grid-2 mb-1"><label class="form-label"><strong>${c.name}</strong></label><input type="number" class="form-control bm-cat" data-cat="${c.name}" value="${Number(catData.total)||0}" step="50" min="0"></div>`;
          subs.forEach(s=>{
            inner += `<div class="grid grid-2 mb-1"><label class="form-label text-muted">${s}</label><input type="number" class="form-control bm-sub" data-cat="${c.name}" data-sub="${s}" value="${subMap.get(s)||0}" step="10" min="0"></div>`;
          });
          wrap.innerHTML = inner;
          container.appendChild(wrap);
        });
        recomputeAllocated();
        openBudgetModal();
      }

      function recomputeAllocated(){
        let total = 0;
        document.querySelectorAll('.bm-cat').forEach(inp=>{ total += Number(inp.value)||0; });
        document.getElementById('bm_allocated').textContent = fmt(total);
      }

      async function saveBudget(){
        const {y,m} = selectedYearMonth();
        const totalBudget = Number(document.getElementById('bm_total').value)||0;
        const allocations = [];
        document.querySelectorAll('.bm-cat').forEach(inp=>{
          const cat = inp.dataset.cat; const amount = Number(inp.value)||0; if(amount>0){ allocations.push({category:cat, subcategory:'All', amount}); }
        });
        document.querySelectorAll('.bm-sub').forEach(inp=>{
          const cat = inp.dataset.cat; const sub = inp.dataset.sub; const amount = Number(inp.value)||0; if(amount>0){ allocations.push({category:cat, subcategory:sub, amount}); }
        });
        await window.callApi('/budgets', { method:'POST', body: JSON.stringify({year:y, month:m, totalBudget, allocations}) });
        closeBudgetModal();
        await loadBudget();
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        setMonthSelect();
        document.getElementById('monthSelect').addEventListener('change', loadBudget);
        document.getElementById('openSettings').addEventListener('click', openSettings);
        document.getElementById('bm_close').addEventListener('click', closeBudgetModal);
        document.getElementById('bm_close_top').addEventListener('click', closeBudgetModal);
        document.getElementById('bm_total').addEventListener('input', recomputeAllocated);
        document.getElementById('bm_rows').addEventListener('input', (e)=>{ if(e.target.matches('.bm-cat,.bm-sub')) recomputeAllocated(); });
        document.getElementById('bm_save').addEventListener('click', saveBudget);
        document.getElementById('prevMonth').addEventListener('click', ()=>{ const sel=document.getElementById('monthSelect'); if(sel.selectedIndex>0){ sel.selectedIndex--; sel.dispatchEvent(new Event('change')); } });
        document.getElementById('nextMonth').addEventListener('click', ()=>{ const sel=document.getElementById('monthSelect'); if(sel.selectedIndex<sel.options.length-1){ sel.selectedIndex++; sel.dispatchEvent(new Event('change')); } });
        firebase.auth().onAuthStateChanged(u=>{ if(u) loadBudget(); });
      });
    </script>
  </body>
  </html>


