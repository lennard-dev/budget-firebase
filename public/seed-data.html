<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Seed Data - Budget Management</title>
  <link rel="stylesheet" href="/shared.css" />
  <script defer src="/__/firebase/12.1.0/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/12.1.0/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/12.1.0/firebase-firestore-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>
  <script defer src="/app.js"></script>
  <style>
    .seed-container { max-width: 800px; margin: 50px auto; padding: 20px; }
    .seed-card { background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .seed-btn { margin: 5px; padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
    .seed-btn:hover { background: var(--color-primary-dark); }
    .seed-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .status { margin-top: 10px; padding: 10px; border-radius: 4px; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <div class="seed-container">
    <div class="seed-card">
      <h1>Data Seeder for Budget Management</h1>
      <p>Use this page to populate your database with realistic dummy data for testing and demonstration.</p>
      
      <div id="auth-status" class="status info">Checking authentication...</div>
      
      <div id="seed-controls" style="display:none;">
        <h2>Quick Seeds</h2>
        <button class="seed-btn" onclick="seedCategories()">Seed Categories & Payment Methods</button>
        <button class="seed-btn" onclick="seedCurrentMonthExpenses()">Seed Current Month Expenses</button>
        <button class="seed-btn" onclick="seedHistoricalExpenses()">Seed 12 Months Historical Data</button>
        <button class="seed-btn" onclick="seedBudgets()">Seed Budget Allocations</button>
        <button class="seed-btn" onclick="seedCashBanking()">Seed Cash & Banking Data</button>
        <button class="seed-btn" onclick="seedAll()">Seed Everything</button>
        
        <h2>Custom Seed</h2>
        <label>Number of expenses: <input type="number" id="expense-count" value="50" min="1" max="500" /></label><br>
        <label>Months back: <input type="number" id="months-back" value="3" min="1" max="24" /></label><br>
        <button class="seed-btn" onclick="seedCustom()">Generate Custom Data</button>
      </div>
      
      <div id="status-output"></div>
      <pre id="log-output" style="display:none;"></pre>
    </div>
  </div>

  <script>
    let currentUser = null;
    const statusDiv = document.getElementById('status-output');
    const logDiv = document.getElementById('log-output');
    
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      statusDiv.appendChild(div);
      
      logDiv.style.display = 'block';
      logDiv.textContent += `${new Date().toISOString()}: ${message}\n`;
    }
    
    // Wait for auth
    setTimeout(() => {
      firebase.auth().onAuthStateChanged(async (user) => {
        currentUser = user;
        const authStatus = document.getElementById('auth-status');
        const controls = document.getElementById('seed-controls');
        
        if (user) {
          authStatus.className = 'status success';
          authStatus.textContent = `Authenticated as: ${user.email}`;
          controls.style.display = 'block';
        } else {
          authStatus.className = 'status error';
          authStatus.textContent = 'Not authenticated. Please sign in first.';
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        }
      });
    }, 1000);
    
    // Helper to call API
    async function callApi(path, options = {}) {
      if (!currentUser) throw new Error("Not signed in");
      const token = await currentUser.getIdToken();
      const res = await fetch(`/api${path}`, {
        ...options,
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
          ...(options.headers || {}),
        },
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }
    
    // Categories and Payment Methods
    async function seedCategories() {
      log('Seeding categories and payment methods...');
      
      const categories = [
        { name: 'Administration', code: 'ADM', subcategories: ['Office Supplies', 'Communications', 'Professional Services', 'Banking Fees'] },
        { name: 'Programs', code: 'PRG', subcategories: ['Education', 'Health Services', 'Community Outreach', 'Emergency Aid'] },
        { name: 'Facilities', code: 'FAC', subcategories: ['Rent', 'Utilities', 'Maintenance', 'Security'] },
        { name: 'Supplies', code: 'SUP', subcategories: ['Food & Beverages', 'Medical Supplies', 'Clothing', 'Hygiene Products'] },
        { name: 'Transportation', code: 'TRN', subcategories: ['Fuel', 'Vehicle Maintenance', 'Public Transport', 'Logistics'] },
        { name: 'Staff', code: 'STF', subcategories: ['Salaries', 'Training', 'Insurance', 'Benefits'] }
      ];
      
      const paymentMethods = [
        { name: 'Cash', sortOrder: 1 },
        { name: 'Bank Transfer', sortOrder: 2 },
        { name: 'Credit Card', sortOrder: 3 },
        { name: 'Debit Card', sortOrder: 4 },
        { name: 'PayPal', sortOrder: 5 },
        { name: 'Check', sortOrder: 6 }
      ];
      
      try {
        for (const cat of categories) {
          await callApi('/categories', {
            method: 'POST',
            body: JSON.stringify(cat)
          });
          log(`✓ Created category: ${cat.name}`, 'success');
        }
        
        for (const pm of paymentMethods) {
          await callApi('/paymentMethods', {
            method: 'POST',
            body: JSON.stringify(pm)
          });
          log(`✓ Created payment method: ${pm.name}`, 'success');
        }
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    }
    
    // Generate random expense
    function generateExpense(daysAgo = 0) {
      const categories = [
        { name: 'Administration', subs: ['Office Supplies', 'Communications', 'Professional Services', 'Banking Fees'] },
        { name: 'Programs', subs: ['Education', 'Health Services', 'Community Outreach', 'Emergency Aid'] },
        { name: 'Facilities', subs: ['Rent', 'Utilities', 'Maintenance', 'Security'] },
        { name: 'Supplies', subs: ['Food & Beverages', 'Medical Supplies', 'Clothing', 'Hygiene Products'] },
        { name: 'Transportation', subs: ['Fuel', 'Vehicle Maintenance', 'Public Transport', 'Logistics'] },
        { name: 'Staff', subs: ['Salaries', 'Training', 'Insurance', 'Benefits'] }
      ];
      
      const descriptions = {
        'Office Supplies': ['Printer paper and toner', 'Notebooks and pens', 'Computer accessories', 'Desk organizers'],
        'Communications': ['Internet service', 'Phone bills', 'Website hosting', 'Marketing materials'],
        'Professional Services': ['Accounting services', 'Legal consultation', 'IT support', 'Translation services'],
        'Banking Fees': ['Wire transfer fees', 'Account maintenance', 'International transaction fees'],
        'Education': ['School supplies for children', 'Language learning materials', 'Workshop materials', 'Educational books'],
        'Health Services': ['Medical consultations', 'Medications', 'First aid supplies', 'Mental health support'],
        'Community Outreach': ['Community event supplies', 'Promotional materials', 'Volunteer coordination', 'Meeting expenses'],
        'Emergency Aid': ['Emergency food packages', 'Temporary shelter costs', 'Emergency medical care', 'Crisis intervention'],
        'Rent': ['Monthly office rent', 'Storage facility rent', 'Community center rent'],
        'Utilities': ['Electricity bill', 'Water bill', 'Gas bill', 'Waste management'],
        'Maintenance': ['Building repairs', 'Equipment maintenance', 'Cleaning supplies', 'Pest control'],
        'Security': ['Security service', 'CCTV maintenance', 'Access control systems', 'Emergency equipment'],
        'Food & Beverages': ['Food for beneficiaries', 'Kitchen supplies', 'Water bottles', 'Coffee and tea'],
        'Medical Supplies': ['Bandages and gauze', 'Disinfectants', 'Basic medications', 'Medical equipment'],
        'Clothing': ['Winter jackets', 'Children clothing', 'Shoes and boots', 'Blankets'],
        'Hygiene Products': ['Soap and shampoo', 'Toothbrushes and toothpaste', 'Diapers', 'Sanitary products'],
        'Fuel': ['Vehicle fuel', 'Generator fuel', 'Heating fuel'],
        'Vehicle Maintenance': ['Oil change', 'Tire replacement', 'Vehicle repairs', 'Insurance'],
        'Public Transport': ['Bus tickets', 'Train passes', 'Taxi services'],
        'Logistics': ['Shipping costs', 'Storage fees', 'Distribution expenses'],
        'Salaries': ['Staff salaries', 'Consultant fees', 'Overtime pay'],
        'Training': ['Staff training courses', 'Conference attendance', 'Workshop fees', 'Training materials'],
        'Insurance': ['Health insurance', 'Liability insurance', 'Property insurance'],
        'Benefits': ['Staff benefits', 'Meal allowances', 'Transportation allowances']
      };
      
      const paymentMethods = ['Cash', 'Bank Transfer', 'Credit Card', 'Debit Card'];
      
      const cat = categories[Math.floor(Math.random() * categories.length)];
      const sub = cat.subs[Math.floor(Math.random() * cat.subs.length)];
      const descList = descriptions[sub] || ['General expense'];
      const desc = descList[Math.floor(Math.random() * descList.length)];
      
      const date = new Date();
      date.setDate(date.getDate() - daysAgo);
      const dateStr = date.toISOString().split('T')[0];
      
      // Generate amount based on category
      let amount;
      if (cat.name === 'Staff' || (cat.name === 'Facilities' && sub === 'Rent')) {
        amount = Math.floor(Math.random() * 3000) + 1000; // 1000-4000
      } else if (cat.name === 'Programs') {
        amount = Math.floor(Math.random() * 1500) + 200; // 200-1700
      } else {
        amount = Math.floor(Math.random() * 500) + 20; // 20-520
      }
      
      const receiptId = `${dateStr.replace(/-/g, '')}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`;
      
      return {
        date: dateStr,
        receiptId: receiptId,
        category: cat.name,
        subcategory: sub,
        description: desc,
        amount: amount,
        paymentMethod: paymentMethods[Math.floor(Math.random() * paymentMethods.length)]
      };
    }
    
    // Seed current month expenses
    async function seedCurrentMonthExpenses() {
      log('Generating current month expenses...');
      const today = new Date();
      const daysInMonth = today.getDate();
      const expenses = [];
      
      // Generate 2-5 expenses per day up to today
      for (let day = 0; day < daysInMonth; day++) {
        const numExpenses = Math.floor(Math.random() * 4) + 2;
        for (let i = 0; i < numExpenses; i++) {
          expenses.push(generateExpense(day));
        }
      }
      
      try {
        await callApi('/import/expenses-batch', {
          method: 'POST',
          body: JSON.stringify(expenses)
        });
        log(`✓ Created ${expenses.length} expenses for current month`, 'success');
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    }
    
    // Seed historical expenses
    async function seedHistoricalExpenses() {
      log('Generating 12 months of historical data...');
      const expenses = [];
      
      // Generate data for last 12 months
      for (let month = 1; month <= 12; month++) {
        const daysBack = month * 30;
        const expensesPerMonth = Math.floor(Math.random() * 30) + 40; // 40-70 per month
        
        for (let i = 0; i < expensesPerMonth; i++) {
          const dayOffset = Math.floor(Math.random() * 28); // Spread across month
          expenses.push(generateExpense(daysBack - dayOffset));
        }
      }
      
      try {
        // Batch import in chunks
        const chunks = [];
        for (let i = 0; i < expenses.length; i += 100) {
          chunks.push(expenses.slice(i, i + 100));
        }
        
        for (const chunk of chunks) {
          await callApi('/import/expenses-batch', {
            method: 'POST',
            body: JSON.stringify(chunk)
          });
          log(`✓ Imported batch of ${chunk.length} expenses`, 'success');
        }
        
        log(`✓ Created ${expenses.length} historical expenses`, 'success');
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    }
    
    // Seed budgets
    async function seedBudgets() {
      log('Creating budget allocations...');
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      
      const allocations = [
        { category: 'Administration', subcategory: 'All', amount: 2000 },
        { category: 'Programs', subcategory: 'All', amount: 5000 },
        { category: 'Facilities', subcategory: 'All', amount: 3000 },
        { category: 'Supplies', subcategory: 'All', amount: 2500 },
        { category: 'Transportation', subcategory: 'All', amount: 1000 },
        { category: 'Staff', subcategory: 'All', amount: 8000 }
      ];
      
      try {
        // Current month
        await callApi('/budgets', {
          method: 'POST',
          body: JSON.stringify({
            year: year,
            month: month,
            totalBudget: 21500,
            allocations: allocations
          })
        });
        log(`✓ Created budget for ${year}-${String(month).padStart(2, '0')}`, 'success');
        
        // Last 3 months
        for (let i = 1; i <= 3; i++) {
          const d = new Date(year, month - 1 - i, 1);
          await callApi('/budgets', {
            method: 'POST',
            body: JSON.stringify({
              year: d.getFullYear(),
              month: d.getMonth() + 1,
              totalBudget: 20000 + Math.floor(Math.random() * 3000),
              allocations: allocations.map(a => ({
                ...a,
                amount: a.amount + Math.floor(Math.random() * 500) - 250
              }))
            })
          });
          log(`✓ Created budget for ${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`, 'success');
        }
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    }
    
    // Custom seed
    async function seedCustom() {
      const count = parseInt(document.getElementById('expense-count').value);
      const monthsBack = parseInt(document.getElementById('months-back').value);
      
      log(`Generating ${count} expenses over ${monthsBack} months...`);
      const expenses = [];
      
      for (let i = 0; i < count; i++) {
        const daysAgo = Math.floor(Math.random() * (monthsBack * 30));
        expenses.push(generateExpense(daysAgo));
      }
      
      try {
        await callApi('/import/expenses-batch', {
          method: 'POST',
          body: JSON.stringify(expenses)
        });
        log(`✓ Created ${expenses.length} custom expenses`, 'success');
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    }
    
    // Seed cash & banking data
    async function seedCashBanking() {
      log('Generating cash & banking data...');
      
      // First, seed some donors if they don't exist
      const donorNames = ['European Foundation', 'Anonymous Donor', 'Local Community Fund', 'Corporate Sponsor', 'Individual Supporter'];
      for (const name of donorNames) {
        try {
          await callApi('/donors', {
            method: 'POST',
            body: JSON.stringify({
              name: name,
              organization: name.includes('Foundation') || name.includes('Corporate') ? name : '',
              email: `${name.toLowerCase().replace(/ /g, '.')}@example.com`,
              active: true
            })
          });
        } catch (e) {
          // Donor might already exist
        }
      }
      
      // Generate cash movements (last 30 days)
      const cashMovements = [];
      let runningBalance = 500; // Starting balance
      
      for (let i = 30; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        // Random 1-3 movements per day
        const numMovements = Math.floor(Math.random() * 3) + 1;
        
        for (let j = 0; j < numMovements; j++) {
          const movements = [
            { type: 'deposit', desc: 'Bank withdrawal for expenses', amount: 200 + Math.random() * 300 },
            { type: 'expense', desc: 'Petty cash expense', amount: -(20 + Math.random() * 80) },
            { type: 'donation', desc: 'Cash donation received', amount: 50 + Math.random() * 150 },
            { type: 'withdrawal', desc: 'Deposit to bank account', amount: -(100 + Math.random() * 200) }
          ];
          
          const movement = movements[Math.floor(Math.random() * movements.length)];
          runningBalance += movement.amount;
          
          cashMovements.push({
            date: dateStr,
            type: movement.type,
            description: movement.desc,
            amount: movement.amount
          });
        }
      }
      
      // Create cash movements
      for (const movement of cashMovements) {
        try {
          await callApi('/cash-movements', {
            method: 'POST',
            body: JSON.stringify(movement)
          });
        } catch (e) {
          console.error('Failed to create movement:', e);
        }
      }
      log(`✓ Created ${cashMovements.length} cash movements`, 'success');
      
      // Generate expected donations
      const today = new Date();
      const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 15);
      const nextMonth2 = new Date(today.getFullYear(), today.getMonth() + 2, 15);
      
      const expectedDonations = [
        { donor: 'European Foundation', expectedDate: new Date(today.getTime() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 5000, notes: 'Annual grant payment' },
        { donor: 'Corporate Sponsor', expectedDate: new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], amount: 2500, notes: 'Year-end donation' },
        { donor: 'Local Community Fund', expectedDate: nextMonth.toISOString().split('T')[0], amount: 1500, notes: 'Quarterly support' },
        { donor: 'Anonymous Donor', expectedDate: nextMonth2.toISOString().split('T')[0], amount: 3000, notes: 'Monthly pledge' }
      ];
      
      for (const donation of expectedDonations) {
        try {
          await callApi('/expected-donations', {
            method: 'POST',
            body: JSON.stringify(donation)
          });
        } catch (e) {
          console.error('Failed to create expected donation:', e);
        }
      }
      log(`✓ Created ${expectedDonations.length} expected donations`, 'success');
      
      // Generate received donations (current month)
      const thisMonth = new Date();
      const receivedDonations = [
        { date: new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 5).toISOString().split('T')[0], donor: 'Individual Supporter', amount: 250, reference: 'TXN001', description: 'Monthly donation', method: 'Bank Transfer' },
        { date: new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 12).toISOString().split('T')[0], donor: 'Anonymous Donor', amount: 500, reference: 'CASH001', description: 'Cash donation', method: 'Cash' },
        { date: new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 20).toISOString().split('T')[0], donor: 'Local Community Fund', amount: 750, reference: 'CHK123', description: 'Community support', method: 'Check' }
      ];
      
      for (const donation of receivedDonations) {
        try {
          await callApi('/received-donations', {
            method: 'POST',
            body: JSON.stringify(donation)
          });
        } catch (e) {
          console.error('Failed to create received donation:', e);
        }
      }
      log(`✓ Created ${receivedDonations.length} received donations`, 'success');
    }
    
    // Seed everything
    async function seedAll() {
      log('Starting complete data seed...', 'info');
      await seedCategories();
      await new Promise(r => setTimeout(r, 1000));
      await seedHistoricalExpenses();
      await new Promise(r => setTimeout(r, 1000));
      await seedCurrentMonthExpenses();
      await new Promise(r => setTimeout(r, 1000));
      await seedBudgets();
      await new Promise(r => setTimeout(r, 1000));
      await seedCashBanking();
      log('✓ Complete seed finished!', 'success');
      log('You can now go to the dashboard to see the data with charts and cash balances.', 'info');
    }
  </script>
</body>
</html>