<style>
#category-modal .modal-content {
  max-width: 500px;
  margin: 10% auto;
}

#category-modal .form-group {
  margin-bottom: 16px;
}

#category-modal .form-label {
  font-weight: 500;
  margin-bottom: 6px;
  display: block;
  color: #333;
}

#category-modal .form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
  transition: border-color 0.3s;
}

#category-modal .form-control:focus {
  outline: none;
  border-color: #1976d2;
  box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
}

#category-modal .form-text {
  display: block;
  margin-top: 4px;
  font-size: 12px;
}

#category-modal textarea.form-control {
  resize: vertical;
  min-height: 60px;
}
</style>

<div id="category-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h2 id="category-modal-title">Add Category</h2><button class="btn btn-icon" onclick="closeModal('category-modal')"><span style="font-size:1.5rem;">Ã—</span></button></div>
    <div class="modal-body">
      <form id="category-form">
        <input type="hidden" id="cat-id" />
        <div class="form-group">
          <label class="form-label">Category Name <span style="color: red;">*</span></label>
          <input type="text" id="cat-name" class="form-control" required placeholder="e.g., Operations" />
          <small class="form-text" style="color: #666;">The display name for this category</small>
        </div>
        <div class="form-group">
          <label class="form-label">Category Code <span style="color: red;">*</span></label>
          <input type="text" id="cat-code" class="form-control" maxlength="3" required placeholder="e.g., OPS" style="text-transform: uppercase;" />
          <small class="form-text" style="color: #666;">3-letter code (will be auto-uppercased)</small>
        </div>
        <div class="form-group">
          <label class="form-label">Subcategories</label>
          <textarea id="cat-subs" class="form-control" rows="3" placeholder="Administrative, Office Supplies, Communications"></textarea>
          <small class="form-text" style="color: #666;">Enter subcategories separated by commas</small>
        </div>
        <div class="form-group" style="margin-top: 15px;">
          <label class="form-label" style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="cat-active" checked style="margin-right: 8px;" />
            <span>Category is Active</span>
          </label>
          <small class="form-text" style="color: #666;">Inactive categories won't appear in expense forms</small>
        </div>
      </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('category-modal')">Cancel</button><button class="btn btn-primary" onclick="saveCategoryModal()">Save Category</button></div>
  </div>
</div>
<script>
(function(){
  window.openCategoryModal = function(cat){
    document.getElementById('category-modal-title').textContent = cat && cat.id ? 'Edit Category' : 'Add Category';
    document.getElementById('cat-id').value = cat?.id || '';
    document.getElementById('cat-name').value = cat?.name || '';
    document.getElementById('cat-code').value = cat?.code || '';
    document.getElementById('cat-subs').value = (cat?.subcategories||[]).join(', ');
    document.getElementById('cat-active').checked = cat?.active !== false;
    document.getElementById('category-modal').style.display='block';
  }
  window.saveCategoryModal = async function(){
    const nameInput = document.getElementById('cat-name');
    const codeInput = document.getElementById('cat-code');
    
    const body = {
      id: document.getElementById('cat-id').value || undefined,
      name: nameInput.value.trim(),
      code: codeInput.value.trim().toUpperCase(),
      subcategories: document.getElementById('cat-subs').value.split(',').map(s=>s.trim()).filter(Boolean),
      active: document.getElementById('cat-active').checked
    };
    
    // Validation
    if (!body.name) {
      nameInput.style.borderColor = '#f44336';
      nameInput.focus();
      alert('Please enter a category name');
      return;
    }
    if (!body.code) {
      codeInput.style.borderColor = '#f44336';
      codeInput.focus();
      alert('Please enter a category code');
      return;
    }
    if (body.code.length !== 3) {
      codeInput.style.borderColor = '#f44336';
      codeInput.focus();
      alert('Category code must be exactly 3 characters');
      return;
    }
    
    try {
      const response = await window.callApi('/categories', {
        method: 'POST',
        body: JSON.stringify(body)
      });
      
      if (response.success) {
        closeModal('category-modal');
        // Refresh the categories list
        if (typeof loadCategories === 'function') {
          await loadCategories();
        } else if (window.initializeSettingsPage) {
          window.initializeSettingsPage();
        }
      } else {
        alert('Failed to save category: ' + (response.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error saving category:', error);
      alert('Failed to save category. Please try again.');
    }
  }
})();
</script>

