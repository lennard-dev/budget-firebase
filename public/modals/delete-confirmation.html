<div id="delete-confirmation-modal" class="modal">
  <div class="modal-content modal-delete-confirm">
    <div class="modal-header">
      <h2>‚ö†Ô∏è Confirm Deletion</h2>
      <button class="modal-close" onclick="closeModal('delete-confirmation-modal')" aria-label="Close">
        <span>√ó</span>
      </button>
    </div>
    <div class="modal-body">
      <div class="delete-warning">
        <div class="warning-icon">‚ö†Ô∏è</div>
        <div class="warning-text">
          <h3>Are you sure you want to delete this transaction?</h3>
          <p>This action cannot be undone.</p>
        </div>
      </div>
      
      <!-- Transaction Details -->
      <div class="transaction-details">
        <h4>Transaction Details:</h4>
        <div id="delete-transaction-info" class="info-grid">
          <!-- Populated dynamically -->
        </div>
      </div>
      
      <!-- Balance Impact Preview -->
      <div class="balance-impact-section">
        <h4>Balance Impact:</h4>
        <div id="delete-balance-impact" class="impact-preview">
          <!-- Populated dynamically -->
        </div>
      </div>
      
      <!-- Affected Transactions Count -->
      <div class="affected-transactions">
        <div class="affected-icon">üîÑ</div>
        <div class="affected-text">
          <span id="affected-count">0</span> subsequent transactions will be recalculated
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('delete-confirmation-modal')">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDeletion()" id="confirm-delete-btn">
        Delete Transaction
      </button>
    </div>
  </div>
</div>

<style>
.modal-delete-confirm {
  background-color: #fff;
  margin: 10% auto;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  max-width: 500px;
  width: 90%;
  overflow: hidden;
}

.modal-delete-confirm .modal-header {
  background: #fff3cd;
  border-bottom: 1px solid #ffc107;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
}

.modal-delete-confirm .modal-header h2 {
  color: #856404;
  font-size: 18px;
  margin: 0;
}

.delete-warning {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding: 20px;
  background: #fee;
  border: 1px solid #fcc;
  border-radius: 6px;
  margin-bottom: 20px;
}

.warning-icon {
  font-size: 32px;
  flex-shrink: 0;
}

.warning-text h3 {
  margin: 0 0 8px 0;
  color: #721c24;
  font-size: 16px;
}

.warning-text p {
  margin: 0;
  color: #721c24;
  font-size: 14px;
}

.transaction-details {
  margin-bottom: 20px;
}

.transaction-details h4 {
  color: #495057;
  font-size: 14px;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.info-grid {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 8px;
  background: #f8f9fa;
  padding: 12px;
  border-radius: 4px;
  font-size: 13px;
}

.info-label {
  color: #6c757d;
  font-weight: 500;
}

.info-value {
  color: #212529;
}

.balance-impact-section {
  margin-bottom: 20px;
}

.balance-impact-section h4 {
  color: #495057;
  font-size: 14px;
  margin: 0 0 12px 0;
  font-weight: 600;
}

.impact-preview {
  background: #e8f0fe;
  border: 1px solid #1a73e8;
  border-radius: 4px;
  padding: 12px;
}

.impact-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 13px;
}

.impact-item:last-child {
  margin-bottom: 0;
}

.impact-label {
  color: #495057;
}

.impact-value {
  font-weight: 600;
}

.impact-value.positive {
  color: #28a745;
}

.impact-value.negative {
  color: #dc3545;
}

.affected-transactions {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 4px;
  margin-bottom: 20px;
}

.affected-icon {
  font-size: 24px;
}

.affected-text {
  font-size: 14px;
  color: #856404;
}

#affected-count {
  font-weight: bold;
  font-size: 16px;
}

.modal-delete-confirm .modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid #e8eaed;
  background: #f8f9fa;
}

.btn-danger {
  background-color: #dc3545;
  color: white;
  border: none;
}

.btn-danger:hover:not(:disabled) {
  background-color: #c82333;
}

.btn-danger:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
  opacity: 0.65;
}
</style>

<script>
(function() {
  let pendingDeletion = null;
  
  // Open delete confirmation modal
  window.openDeleteConfirmation = async function(transactionId, transactionType, transactionData) {
    console.log('Opening delete confirmation for:', transactionId, transactionType);
    
    pendingDeletion = {
      id: transactionId,
      type: transactionType,
      data: transactionData
    };
    
    // Populate transaction details
    const infoEl = document.getElementById('delete-transaction-info');
    let infoHTML = '';
    
    if (transactionType === 'expense') {
      infoHTML = `
        <span class="info-label">Date:</span>
        <span class="info-value">${transactionData.date}</span>
        <span class="info-label">Amount:</span>
        <span class="info-value">‚Ç¨${transactionData.amount.toFixed(2)}</span>
        <span class="info-label">Category:</span>
        <span class="info-value">${transactionData.category} - ${transactionData.subcategory}</span>
        <span class="info-label">Payment:</span>
        <span class="info-value">${transactionData.paymentMethod}</span>
        <span class="info-label">Description:</span>
        <span class="info-value">${transactionData.description || 'N/A'}</span>
      `;
    } else {
      infoHTML = `
        <span class="info-label">Date:</span>
        <span class="info-value">${transactionData.date}</span>
        <span class="info-label">Amount:</span>
        <span class="info-value">‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
        <span class="info-label">Type:</span>
        <span class="info-value">${transactionData.type}</span>
        <span class="info-label">Description:</span>
        <span class="info-value">${transactionData.description || 'N/A'}</span>
      `;
    }
    
    infoEl.innerHTML = infoHTML;
    
    // Calculate balance impact
    await calculateDeletionImpact(transactionData, transactionType);
    
    // Show modal
    document.getElementById('delete-confirmation-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
  };
  
  // Calculate deletion impact
  async function calculateDeletionImpact(transactionData, transactionType) {
    const impactEl = document.getElementById('delete-balance-impact');
    const countEl = document.getElementById('affected-count');
    
    let impactHTML = '';
    
    // Determine which balances will be affected
    if (transactionType === 'expense') {
      if (transactionData.paymentMethod === 'Cash') {
        impactHTML += `
          <div class="impact-item">
            <span class="impact-label">Cash Balance Change:</span>
            <span class="impact-value positive">+‚Ç¨${transactionData.amount.toFixed(2)}</span>
          </div>
          <div class="impact-item">
            <span class="impact-label">Restored to Cash</span>
            <span class="impact-value">Amount will be added back</span>
          </div>
        `;
      } else if (transactionData.paymentMethod === 'Card' || transactionData.paymentMethod === 'Bank Transfer') {
        impactHTML += `
          <div class="impact-item">
            <span class="impact-label">Bank Balance Change:</span>
            <span class="impact-value positive">+‚Ç¨${transactionData.amount.toFixed(2)}</span>
          </div>
          <div class="impact-item">
            <span class="impact-label">Restored to Bank</span>
            <span class="impact-value">Amount will be added back</span>
          </div>
        `;
      }
    } else {
      // Cash movement impacts
      switch(transactionData.type) {
        case 'withdrawal':
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">Cash Balance:</span>
              <span class="impact-value negative">-‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
            <div class="impact-item">
              <span class="impact-label">Bank Balance:</span>
              <span class="impact-value positive">+‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
          `;
          break;
        case 'deposit':
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">Cash Balance:</span>
              <span class="impact-value positive">+‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
            <div class="impact-item">
              <span class="impact-label">Bank Balance:</span>
              <span class="impact-value negative">-‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
          `;
          break;
        case 'donation':
          const account = transactionData.toBank ? 'Bank' : 'Cash';
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">${account} Balance:</span>
              <span class="impact-value negative">-‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
            <div class="impact-item">
              <span class="impact-label">Donation Reversed</span>
              <span class="impact-value">Amount removed from ${account.toLowerCase()}</span>
            </div>
          `;
          break;
        case 'cash-expense':
          impactHTML += `
            <div class="impact-item">
              <span class="impact-label">Cash Balance:</span>
              <span class="impact-value positive">+‚Ç¨${Math.abs(transactionData.amount).toFixed(2)}</span>
            </div>
          `;
          break;
      }
    }
    
    impactEl.innerHTML = impactHTML;
    
    // Estimate affected transactions
    try {
      const endpoint = transactionType === 'expense' ? '/expenses' : '/cash-movements';
      const response = await window.callApi(`${endpoint}?fromDate=${transactionData.date}&limit=1000`);
      
      if (response.success && response.data) {
        // Count transactions after this one
        const affectedCount = response.data.filter(t => 
          t.date > transactionData.date || 
          (t.date === transactionData.date && t.id !== transactionData.id)
        ).length;
        
        countEl.textContent = affectedCount;
      }
    } catch (error) {
      console.error('Failed to estimate affected transactions:', error);
      countEl.textContent = 'Unknown';
    }
  }
  
  // Confirm deletion
  window.confirmDeletion = async function() {
    if (!pendingDeletion) {
      console.error('No pending deletion');
      return;
    }
    
    const confirmBtn = document.getElementById('confirm-delete-btn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Deleting...';
    
    try {
      // Use transaction editor for proper balance recalculation
      if (window.TransactionEditor) {
        confirmBtn.textContent = 'Recalculating balances...';
        const result = await window.TransactionEditor.deleteTransaction(
          pendingDeletion.id,
          pendingDeletion.type
        );
        
        console.log('Deletion result:', result);
        
        // Close modal
        closeModal('delete-confirmation-modal');
        
        // Show success message
        if (result.recalculation) {
          alert(`Transaction deleted successfully!\n${result.recalculation.affectedCount} subsequent transactions were recalculated.`);
        } else {
          alert('Transaction deleted successfully!');
        }
        
        // Refresh the current page
        if (window.refreshCurrentPage) {
          window.refreshCurrentPage();
        } else if (location.hash === '#expenses' && window.initializeExpensesPage) {
          window.initializeExpensesPage();
        } else if (location.hash === '#cash-banking' && window.initializeCashBankingPage) {
          window.initializeCashBankingPage();
        }
      } else {
        // Fallback to simple delete
        const endpoint = pendingDeletion.type === 'expense' 
          ? `/expenses/${pendingDeletion.id}`
          : `/cash-movements/${pendingDeletion.id}`;
        
        const response = await window.callApi(endpoint, { method: 'DELETE' });
        
        if (response.success) {
          closeModal('delete-confirmation-modal');
          alert('Transaction deleted! Note: Balance recalculation service not loaded.');
          
          // Refresh current page
          if (window.refreshCurrentPage) {
            window.refreshCurrentPage();
          }
        } else {
          throw new Error('Delete failed');
        }
      }
      
      pendingDeletion = null;
      
    } catch (error) {
      console.error('Failed to delete transaction:', error);
      alert('Failed to delete transaction: ' + error.message);
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Delete Transaction';
    }
  };
  
  // Enhanced delete function for expenses
  window.deleteExpenseWithConfirmation = function(expense) {
    window.openDeleteConfirmation(expense.id, 'expense', expense);
  };
  
  // Enhanced delete function for cash movements
  window.deleteCashMovementWithConfirmation = function(movement) {
    window.openDeleteConfirmation(movement.id, 'movement', movement);
  };
  
  console.log('Delete Confirmation Modal initialized');
})();
</script>